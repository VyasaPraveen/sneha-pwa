<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sneha Label Printer</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="WYSIWYG Label Designer & Printer for Sneha Vinyl Products PVT LTD">
    <meta name="theme-color" content="#059669">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Sneha Labels">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Sneha Label Printer">
    <meta name="msapplication-TileColor" content="#059669">
    <meta name="msapplication-TileImage" content="icons/icon-144.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-72.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <!-- External Libraries for Label Printing -->
    <script src="https://cdn.jsdelivr.net/npm/qz-tray@2.2.3/qz-tray.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Firebase SDK v27 -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* ============================================================
         * SNEHA VINYL LABEL PRINTER - STYLESHEET v27.1
         * ============================================================
         * 
         * SECTIONS:
         * 1. RESET & BASE STYLES
         * 2. LAYOUT - App Grid, Panels
         * 3. FORMS - Inputs, Dropdowns, Toggles
         * 4. BUTTONS - Primary, Secondary, Danger
         * 5. LABEL CANVAS - Preview, Elements, Drag
         * 6. TABS & PANELS - Right Panel, Properties
         * 7. MODALS - Overlays, Headers, Content
         * 8. PRINT LOG & STATS
         * 9. TABLES - Reports, Error Log
         * 10. UTILITIES - Status, Alerts, Misc
         * 11. RESPONSIVE - Mobile Adjustments
         * ============================================================ */

        /* ============================================================
         * 1. RESET & BASE STYLES
         * ============================================================ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f0f0f0;
            color: #333;
            min-height: 100vh;
        }

        /* ============================================================
         * 2. LAYOUT - App Grid, Panels
         * ============================================================ */
        .app {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            min-height: 100vh;
        }

        .panel {
            background: #fff;
            padding: 16px;
            overflow-y: auto;
            border-right: 1px solid #e5e7eb;
            scrollbar-width: thin;
            scrollbar-color: #d1d5db #f3f4f6;
        }
        
        .panel::-webkit-scrollbar {
            width: 6px;
        }
        
        .panel::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 3px;
        }
        
        .panel::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }
        
        .panel::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .panel h2 {
            font-size: 14px;
            color: #059669;
            margin-bottom: 14px;
            padding-bottom: 10px;
            border-bottom: 2px solid #059669;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* ============================================================
         * 3. FORMS - Inputs, Dropdowns, Toggles
         * ============================================================ */
        .form-group { margin-bottom: 10px; }

        .form-group label {
            display: block;
            font-size: 11px;
            color: #666;
            margin-bottom: 3px;
            font-weight: 600;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 12px;
            background: #fff;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .form-group input:focus, .form-group select:focus { 
            outline: none; 
            border-color: #059669; 
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }
        
        .form-group input:hover, .form-group select:hover {
            border-color: #9ca3af;
        }

        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #86efac;
            border-radius: 8px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }
        
        .toggle-row:hover {
            border-color: #4ade80;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.1);
        }

        .toggle-row span { font-size: 12px; font-weight: 600; color: #166534; }

        .toggle {
            width: 44px; height: 24px;
            background: #ccc; border-radius: 12px;
            position: relative; cursor: pointer;
        }

        .toggle.active { background: #059669; }

        .toggle::after {
            content: ''; position: absolute;
            width: 18px; height: 18px;
            background: #fff; border-radius: 50%;
            top: 3px; left: 3px; transition: 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .toggle.active::after { left: 23px; }

        .preview-container {
            background: #e5e5e5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow: auto;
        }

        .preview-title {
            color: #666;
            font-size: 11px;
            margin-bottom: 10px;
            text-align: center;
        }

        .scale-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .scale-control label { font-size: 12px; font-weight: 600; color: #333; }
        .scale-control input[type="range"] { width: 120px; cursor: pointer; }
        .scale-control .scale-value { font-size: 14px; font-weight: 700; color: #059669; min-width: 45px; }

        /* ============================================================
         * 5. LABEL CANVAS - Preview, Elements, Drag
         * ============================================================ */
        .label-canvas {
            width: 288px;
            height: 288px;
            background: #fff;
            position: relative;
            font-family: Arial, sans-serif;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transform-origin: center center;
            overflow: hidden;
            border: 1px dashed #ccc;
        }

        .label-element {
            position: absolute;
            cursor: move;
            user-select: none;
            white-space: nowrap;
        }

        .label-element:hover { outline: 1px dashed #059669; }
        .label-element.selected { outline: 2px solid #059669; background: rgba(5, 150, 105, 0.1); }
        .label-element.multi-selected { outline: 2px solid #2563eb; background: rgba(37, 99, 235, 0.15); }
        .label-element.multi-selected.primary { outline: 2px solid #059669; background: rgba(5, 150, 105, 0.2); }

        .contact-bar {
            position: absolute;
            left: 0; right: 0;
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            color: #000;
        }

        .separator-line {
            position: absolute;
            left: 0; right: 0;
            height: 2px;
            background: #000;
        }

        .right-panel {
            background: #fff;
            padding: 15px;
            border-left: 1px solid #ddd;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            border-radius: 6px;
        }

        .tab.active {
            background: #059669;
            color: #fff;
        }

        .tab-content { display: none; flex: 1; overflow-y: auto; }
        .tab-content.active { display: flex; flex-direction: column; }

        .prop-group { margin-bottom: 12px; }
        .prop-group label { display: block; font-size: 10px; color: #666; margin-bottom: 3px; font-weight: 600; }
        .prop-row { display: flex; gap: 6px; }
        .prop-row input { flex: 1; padding: 6px; background: #f8f8f8; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }

        /* ============================================================
         * 4. BUTTONS - Primary, Secondary, Danger
         * ============================================================ */
        .btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        /* ============================================================
         * 4.1 SIDEBAR ACTION SECTIONS (v27.1)
         * ============================================================ */
        
        /* Collapsible Section Container */
        .sidebar-section {
            margin-bottom: 12px;
            border-radius: 8px;
            background: #fafafa;
            border: 1px solid #e5e5e5;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        
        .sidebar-section:hover {
            border-color: #d1d5db;
        }
        
        /* Section Header - Clickable */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            cursor: pointer;
            user-select: none;
            border-bottom: 1px solid transparent;
            transition: all 0.2s ease;
        }
        
        .section-header:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        }
        
        .sidebar-section.expanded .section-header {
            border-bottom-color: #e5e5e5;
        }
        
        .section-header .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 700;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .section-header .section-icon {
            font-size: 14px;
        }
        
        .section-header .expand-icon {
            font-size: 10px;
            color: #9ca3af;
            transition: transform 0.2s ease;
        }
        
        .sidebar-section.expanded .expand-icon {
            transform: rotate(180deg);
        }
        
        /* Section Content */
        .section-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        
        .sidebar-section.expanded .section-content {
            padding: 10px 12px;
            max-height: 500px;
        }
        
        /* Button Group - Compact Row */
        .btn-group {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }
        
        .btn-group:last-child {
            margin-bottom: 0;
        }
        
        .btn-group .btn {
            flex: 1;
            margin-bottom: 0;
            padding: 8px 6px;
            font-size: 11px;
        }
        
        /* Icon Button - Square */
        .btn-icon {
            width: 36px;
            height: 36px;
            min-width: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            border-radius: 8px;
            margin-bottom: 0;
            flex: none;
        }
        
        .btn-icon:hover {
            transform: scale(1.05);
        }
        
        /* Action Card - For important actions */
        .action-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-card:hover {
            border-color: #059669;
            box-shadow: 0 2px 8px rgba(5, 150, 105, 0.1);
            transform: translateY(-1px);
        }
        
        .action-card:last-child {
            margin-bottom: 0;
        }
        
        .action-card .card-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .action-card .card-content {
            flex: 1;
            min-width: 0;
        }
        
        .action-card .card-title {
            font-size: 12px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 2px;
        }
        
        .action-card .card-desc {
            font-size: 9px;
            color: #6b7280;
            line-height: 1.3;
        }
        
        .action-card .card-arrow {
            color: #9ca3af;
            font-size: 12px;
        }
        
        /* Card Color Variants */
        .action-card.card-danger {
            background: #fef2f2;
            border-color: #fecaca;
        }
        .action-card.card-danger:hover {
            border-color: #dc2626;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.15);
        }
        .action-card.card-danger .card-icon {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .action-card.card-info {
            background: #eff6ff;
            border-color: #bfdbfe;
        }
        .action-card.card-info:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }
        .action-card.card-info .card-icon {
            background: #dbeafe;
            color: #2563eb;
        }
        
        .action-card.card-warning {
            background: #fffbeb;
            border-color: #fde68a;
        }
        .action-card.card-warning:hover {
            border-color: #f59e0b;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.15);
        }
        .action-card.card-warning .card-icon {
            background: #fef3c7;
            color: #d97706;
        }
        
        .action-card.card-success {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }
        .action-card.card-success:hover {
            border-color: #22c55e;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.15);
        }
        .action-card.card-success .card-icon {
            background: #dcfce7;
            color: #16a34a;
        }
        
        /* Toggle Box - Compact */
        .toggle-box {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .toggle-box:last-child {
            margin-bottom: 0;
        }
        
        .toggle-box .toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 600;
            color: #374151;
        }
        
        .toggle-box .toggle-status {
            font-size: 9px;
            color: #6b7280;
            margin-top: 2px;
        }
        
        .toggle-box.toggle-locked {
            background: #fef3c7;
            border-color: #fcd34d;
        }
        
        .toggle-box.toggle-locked .toggle-label {
            color: #92400e;
        }
        
        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            font-size: 9px;
            font-weight: 600;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .status-badge.badge-success {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-badge.badge-warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-badge.badge-info {
            background: #dbeafe;
            color: #1e40af;
        }
        
        /* Quick Action Bar */
        .quick-actions {
            display: flex;
            gap: 6px;
            padding: 8px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .quick-actions .btn-icon {
            flex: 1;
            background: #fff;
            border: 1px solid #e5e5e5;
        }
        
        .quick-actions .btn-icon:hover {
            background: #059669;
            border-color: #059669;
            color: #fff;
        }
        
        /* Sidebar Divider with Label */
        .sidebar-divider {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 16px 0 12px 0;
            font-size: 9px;
            font-weight: 700;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .sidebar-divider::before,
        .sidebar-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e5e5e5;
        }

        .btn-primary { background: linear-gradient(135deg, #059669 0%, #047857 100%); color: #fff; }
        .btn-primary:hover { background: linear-gradient(135deg, #047857 0%, #065f46 100%); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3); }
        .btn-primary:active { transform: translateY(0); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .btn-secondary { background: #fff; color: #374151; border: 1px solid #d1d5db; }
        .btn-secondary:hover { background: #f9fafb; border-color: #9ca3af; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); }
        .btn-secondary:active { transform: translateY(0); }
        
        .btn-danger { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: #fff; }
        .btn-danger:hover { background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); }
        .btn-danger:active { transform: translateY(0); }

        .status {
            padding: 8px;
            border-radius: 4px;
            font-size: 11px;
            text-align: center;
            margin-bottom: 10px;
        }

        .status.connected { background: #d1fae5; color: #059669; }
        .status.disconnected { background: #fee2e2; color: #dc2626; }

        .qty-control { display: flex; align-items: center; gap: 6px; }
        .qty-btn { width: 32px; height: 32px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; cursor: pointer; }
        .qty-btn:hover { background: #059669; color: #fff; }

        .dropdown-list {
            position: absolute;
            top: 100%; left: 0; right: 0;
            max-height: 180px; overflow-y: auto;
            background: #fff; border: 1px solid #059669;
            border-radius: 0 0 8px 8px;
            z-index: 100; display: none;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            border-top: none;
        }

        .dropdown-list.show { display: block; }
        .dropdown-item { 
            padding: 10px 12px; 
            font-size: 12px; 
            cursor: pointer; 
            transition: all 0.15s ease;
            border-bottom: 1px solid #f3f4f6;
        }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); color: #065f46; }
        .searchable { position: relative; }
        hr { border: none; border-top: 1px solid #eee; margin: 15px 0; }

        /* ============================================================
         * 8. PRINT LOG & STATS
         * ============================================================ */
        .log-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .stat-box {
            background: #f0fdf4;
            border: 1px solid #059669;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
        }

        .stat-box .value {
            font-size: 20px;
            font-weight: 700;
            color: #059669;
        }

        .stat-box .label {
            font-size: 10px;
            color: #666;
        }

        .log-list {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .log-item {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            font-size: 11px;
        }

        .log-item:last-child { border-bottom: none; }

        .log-item .time {
            color: #888;
            font-size: 10px;
        }

        .log-item .details {
            display: flex;
            justify-content: space-between;
            margin-top: 3px;
        }

        .log-item .product {
            font-weight: 600;
            color: #333;
        }

        .log-item .meta {
            color: #666;
        }

        /* ============================================================
         * 7. MODALS - Overlays, Headers, Content
         * ============================================================ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show { display: flex; }

        /* Error Log Modal - FULLSCREEN STYLE */
        #errorLogModalContent {
            width: 95vw !important;
            max-width: 1400px !important;
            height: 90vh !important;
            background: #fff;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
        }
        
        #errorLogTable tbody tr:hover {
            background: #e0f2fe !important;
        }
        
        #errorLogTable tbody tr:nth-child(even) {
            background: #f8fafc;
        }

        .modal {
            background: #fff;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 15px 20px;
            background: #059669;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 { font-size: 16px; }

        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
        }

        .modal-body {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-footer .btn { width: auto; padding: 10px 20px; }

        /* Master Type Tab Buttons */
        .master-tab-btn {
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: #f8fafc;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
        }
        .master-tab-btn:hover {
            background: #e2e8f0;
            color: #334155;
        }
        .master-tab-btn.active {
            background: #059669;
            color: white;
            border-color: #059669;
        }

        /* Report Preview */
        .report-preview {
            background: #fff;
            border: 1px solid #ddd;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 20px;
            min-height: 500px;
        }

        .report-header {
            text-align: center;
            padding: 5px 0 8px 0;
            border-bottom: 2px solid #000;
            margin-bottom: 8px;
        }
        
        .report-header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .report-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        .report-header h1 {
            font-size: 18px;
            font-weight: 900;
            margin: 0;
            letter-spacing: 1px;
        }

        .report-header .since {
            font-size: 12px;
            font-weight: bold;
            margin: 2px 0;
        }

        .report-header .address {
            font-size: 12px;
            margin: 2px 0;
        }

        .report-header .contact {
            font-size: 12px;
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 3px;
        }

        .report-meta {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin: 6px 0;
            padding: 6px 0;
            border-bottom: 1px solid #000;
            font-size: 11px;
        }
        
        .report-meta .meta-left,
        .report-meta .meta-right {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .report-meta .meta-right {
            text-align: right;
        }
        
        .report-meta span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin: 5px 0;
        }

        .report-table th, .report-table td {
            border: 1px solid #000;
            padding: 4px 6px;
            text-align: left;
            font-size: 13px;
        }

        .report-table th {
            background: #e0e0e0;
            font-weight: 700;
        }

        .report-table td.number {
            text-align: right;
        }

        .report-totals {
            margin: 6px 0 10px 0;
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            font-size: 13px;
            padding-top: 5px;
        }

        .filter-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-row .form-group {
            flex: 1;
            min-width: 150px;
        }
        
        /* Toggle Switch for Edit Lock */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #059669;
            transition: 0.3s;
            border-radius: 22px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: #dc2626;
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
        
        /* Edit locked state */
        .edit-locked .label-element {
            cursor: default !important;
            pointer-events: none;
        }
        
        .edit-locked .label-element:hover {
            outline: none !important;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Left Panel - Data Entry -->
        <div class="panel">
            <h2>üìù Label Data</h2>
            <!-- Firebase Sync Indicator v27.1 -->
            <div id="syncIndicator" style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; margin-bottom: 12px; border-radius: 8px; font-size: 11px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); color: #0369a1; border: 1px solid #bae6fd;">
                <span id="syncDot" style="width: 8px; height: 8px; border-radius: 50%; background: #9ca3af; box-shadow: 0 0 0 2px rgba(156, 163, 175, 0.2);"></span>
                <span id="syncText" style="font-weight: 500;">Initializing...</span>
                <span class="status-badge badge-info" style="margin-left: auto;">v29.0</span>
            </div>
            
            <div class="form-group searchable">
                <label>üë§ CLIENT NAME</label>
                <input type="text" id="clientInput" placeholder="Type to search..." oninput="filterDropdown('client'); updateLabelText();" onfocus="showDropdown('client')" onblur="hideDropdown('client')">
                <div class="dropdown-list" id="clientDropdown"></div>
            </div>
            
            <div class="toggle-row">
                <span>Show Header</span>
                <div class="toggle active" id="headerToggle" onclick="toggleHeader()"></div>
            </div>
            <div id="modeIndicator" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 1px solid #93c5fd; border-radius: 8px; padding: 10px; margin-bottom: 12px; text-align: center; font-size: 11px; color: #1e40af; font-weight: 500;">
                üìê Editing: <strong>WITH HEADER</strong> layout
            </div>

            <div class="form-group searchable">
                <label>PRODUCT</label>
                <input type="text" id="productInput" placeholder="Type to search..." oninput="filterDropdown('product'); updateLabelText();" onfocus="showDropdown('product')" onblur="hideDropdown('product')">
                <div class="dropdown-list" id="productDropdown"></div>
            </div>

            <div class="form-group searchable">
                <label>DESIGN</label>
                <input type="text" id="designInput" placeholder="Type to search..." oninput="filterDropdown('design'); updateLabelText();" onfocus="showDropdown('design')" onblur="hideDropdown('design')">
                <div class="dropdown-list" id="designDropdown"></div>
            </div>

            <div class="form-group searchable">
                <label>COLOR</label>
                <input type="text" id="colorInput" placeholder="Type to search..." oninput="filterDropdown('color'); updateLabelText();" onfocus="showDropdown('color')" onblur="hideDropdown('color')">
                <div class="dropdown-list" id="colorDropdown"></div>
            </div>

            <div class="form-group">
                <label>GRADE</label>
                <select id="gradeInput" onchange="updateLabelText()">
                    <option value="">-- Select Grade --</option>
                    <option value="A">A</option>
                    <option value="STD">STD</option>
                    <option value="Commercial">Commercial</option>
                </select>
            </div>

            <div class="form-group">
                <label>METERS</label>
                <input type="number" id="metersInput" placeholder="e.g., 50" oninput="updateLabelText(); toggleBitsField()">
            </div>
            
            <div class="form-group" id="bitsGroup" style="display: none;">
                <label>BITS (Split Rolls) <span style="font-weight:400; color:#888;">- Optional</span></label>
                <input type="text" id="bitsInput" placeholder="e.g., 15+5 or 18+2" oninput="updateLabelText()" style="font-weight: 600;">
                <div style="font-size: 9px; color: #666; margin-top: 3px;">
                    Enter split values separated by + (e.g., 15+5 for 20m roll)
                </div>
            </div>

            <div class="form-group">
                <label>ROLL NO (Auto-generated)</label>
                <div style="display: flex; gap: 6px; align-items: center;">
                    <select id="systemSelect" style="width: 70px;" onchange="generateRollNumber()">
                        <option value="1">Sys 1</option>
                        <option value="2">Sys 2</option>
                    </select>
                    <input type="text" id="rollNoInput" style="flex:1; font-weight: 700; font-size: 14px;" oninput="updateLabelText(); detectManualRollEntry()">
                    <button class="btn-icon btn-secondary" onclick="generateRollNumber()" title="Generate next number">üîÑ</button>
                </div>
                <div style="font-size: 9px; color: #666; margin-top: 4px;">
                    Format: [System][Month][Serial] ‚Ä¢ Auto-increments after print ‚Ä¢ Manual entry allowed
                </div>
            </div>

            <div class="form-group">
                <label>WEIGHT (Kgs)</label>
                <input type="number" step="0.1" id="weightInput" placeholder="e.g., 2.5" oninput="updateLabelText()">
            </div>

            <!-- ============ PRODUCTION ENTRY SECTION ============ -->
            <div class="sidebar-divider">Production</div>
            
            <div class="action-card card-danger" onclick="openRejectsModal()">
                <div class="card-icon">üö´</div>
                <div class="card-content">
                    <div class="card-title">Rejects Entry</div>
                    <div class="card-desc">Log production without printing labels</div>
                </div>
                <span class="card-arrow">‚Ä∫</span>
            </div>
            
            <div class="action-card card-info" onclick="openExtraRollsModal()">
                <div class="card-icon">üì¶</div>
                <div class="card-content">
                    <div class="card-title">Extra Rolls</div>
                    <div class="card-desc">Add leftover small meter rolls</div>
                </div>
                <span class="card-arrow">‚Ä∫</span>
            </div>

            <!-- ============ LAYOUT CONTROLS SECTION ============ -->
            <div class="sidebar-section expanded" id="layoutSection">
                <div class="section-header" onclick="toggleSection('layoutSection')">
                    <span class="section-title">
                        <span class="section-icon">üìê</span>
                        Layout Controls
                    </span>
                    <span class="expand-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveLayout()">üíæ Save</button>
                        <button class="btn btn-secondary" onclick="resetLayout()">üîÑ Reset</button>
                    </div>
                    
                    <div class="toggle-box">
                        <div>
                            <div class="toggle-label">üîí Edit Lock</div>
                            <div class="toggle-status" id="editLockStatus">‚úèÔ∏è Editing Enabled</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="editLockToggle" onchange="toggleEditLock()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="toggle-box toggle-locked">
                        <div>
                            <div class="toggle-label">üîê Master Lock</div>
                            <div class="toggle-status" id="masterLockStatus">üîí New entries blocked</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="masterLockToggle" checked onchange="toggleMasterLock()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="openMasterManagement()" style="margin-top: 4px;">
                        ‚öôÔ∏è Manage Masters
                    </button>
                </div>
            </div>

            <!-- ============ DATA TRANSFER SECTION ============ -->
            <div class="sidebar-section" id="transferSection">
                <div class="section-header" onclick="toggleSection('transferSection')">
                    <span class="section-title">
                        <span class="section-icon">üîÑ</span>
                        Data Transfer
                    </span>
                    <span class="expand-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="exportLayout()">üì§ Export</button>
                        <button class="btn btn-secondary" onclick="importLayout()">üì• Import</button>
                    </div>
                    <div style="font-size: 9px; color: #666; margin-top: 4px; text-align: center;">
                        Transfer layout to another system
                    </div>
                </div>
            </div>

            <!-- ============ BACKUP & SYNC SECTION ============ -->
            <div class="sidebar-section expanded" id="backupSection">
                <div class="section-header" onclick="toggleSection('backupSection')">
                    <span class="section-title">
                        <span class="section-icon">üíæ</span>
                        Backup & Sync
                    </span>
                    <span class="expand-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <!-- Cloud Sync Status (v29: repurposed from auto-backup) -->
                    <div id="autoBackupStatus" style="font-size: 10px; color: #059669; margin-bottom: 8px; padding: 8px 10px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 6px; border: 1px solid #86efac; display: flex; align-items: center; gap: 6px;">
                        <span>&#9203;</span>
                        <span>Cloud Sync: Checking...</span>
                    </div>
                    
                    <div id="lastBackupInfo" style="font-size: 9px; color: #666; margin-bottom: 10px; padding: 6px 10px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                        üìÖ Last backup: Never
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="createFullBackup()" style="background: linear-gradient(135deg, #059669 0%, #047857 100%);">&#11015;&#65039; Backup</button>
                        <button class="btn btn-secondary" onclick="restoreFullBackup()">&#11014;&#65039; Restore</button>
                    </div>

                    <!-- v28: Cloud Recovery & Push Buttons -->
                    <div style="margin-top: 8px; display: flex; gap: 4px;">
                        <button class="btn btn-secondary" onclick="recoverAllFromFirebase()" style="flex: 1; background: #fff7ed; border-color: #fb923c; color: #c2410c; font-weight: 700; font-size: 10px; padding: 6px 4px;">&#9729;&#65039; Cloud Pull</button>
                        <button class="btn btn-secondary" onclick="pushLocalToFirebase()" style="flex: 1; background: #eff6ff; border-color: #93c5fd; color: #1e40af; font-weight: 700; font-size: 10px; padding: 6px 4px;">&#9650; Cloud Push</button>
                    </div>

                    <!-- Quick Tool Buttons -->
                    <div class="quick-actions" style="margin-top: 8px;">
                        <button class="btn-icon" onclick="openFirebaseMigration()" title="Cloud Sync" style="background: #fff7ed; border-color: #fdba74; color: #ea580c;">&#128293;</button>
                        <button class="btn-icon" onclick="openMigrationTool()" title="Migrate Old Data" style="background: #fef3c7; border-color: #fcd34d; color: #d97706;">&#128260;</button>
                        <button class="btn-icon" onclick="openErrorLog()" title="Error Log" style="background: #fef2f2; border-color: #fecaca; color: #dc2626;">&#128308;</button>
                    </div>

                    <div style="font-size: 9px; color: #9ca3af; margin-top: 8px; text-align: center; line-height: 1.4;">
                        v28: Data syncs to Firestore cloud automatically
                    </div>
                </div>
            </div>
        </div>

        <!-- Center - Label Preview -->
        <div class="preview-container">
            <div class="preview-title">
                <strong>WYSIWYG Preview</strong> ‚Äî Drag to reposition
            </div>
            
            <div class="scale-control">
                <label>üìê Scale:</label>
                <input type="range" id="scaleSlider" min="80" max="150" value="130" oninput="updateScale()">
                <span class="scale-value" id="scaleValue">130%</span>
            </div>
            
            <div class="btn-group" style="margin-bottom: 6px;">
                <button class="btn btn-secondary" style="padding: 5px 4px; font-size: 11px;" onclick="selectAllHeader()" title="Select all header elements">üìã Header</button>
                <button class="btn btn-secondary" style="padding: 5px 4px; font-size: 11px;" onclick="selectAllFields()" title="Select all field elements">üìù Fields</button>
                <button class="btn btn-secondary" style="padding: 5px 4px; font-size: 11px;" onclick="selectAll()" title="Select all visible elements">‚úÖ All</button>
                <button class="btn btn-secondary" style="padding: 5px 4px; font-size: 11px;" onclick="clearAllSelections()" title="Deselect all">‚ùå Clear</button>
            </div>
            <div style="font-size: 10px; color: #666; margin-bottom: 6px; text-align: center;">Ctrl+Click to multi-select</div>

            <div class="label-canvas" id="labelCanvas">
                <!-- HEADER -->
                <div class="label-element" id="el_logo" style="left: 5px; top: 5px; width: 38px; height: 38px;">
                    <img id="logo_img" src="data:image/png;base64,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" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'">
                </div>

                <div class="label-element" id="el_company" style="left: 48px; top: 5px; font-size: 10px; font-weight: 900; color: #000; line-height: 1.2;">SNEHA VINYL PRODUCTS PVT LTD</div>
                <div class="label-element" id="el_since" style="left: 230px; top: 5px; font-size: 8px; font-weight: 700; color: #000;">SINCE 1984</div>
                <div class="label-element" id="el_address" style="left: 48px; top: 20px; font-size: 8px; font-weight: 700; color: #000;">14-34, IDA, RENIGUNTA, TIRUPATI, AP</div>

                <!-- Phone and Email - Separate draggable elements -->
                <div class="label-element" id="el_phone" style="left: 8px; top: 35px; font-size: 9px; font-weight: 700; color: #000;">+91-9000317333</div>
                <div class="label-element" id="el_email" style="left: 160px; top: 35px; font-size: 9px; font-weight: 700; color: #000;">info@snehavinyl.in</div>

                <div class="separator-line label-element" id="el_separator" style="top: 52px; height: 2px;"></div>

                <!-- FIELDS - Proper colon alignment -->
                <div class="label-element" id="el_product_label" style="left: 8px; top: 60px; font-size: 16px; font-weight: 900; color: #000;">PRODUCT</div>
                <div class="label-element" id="el_product_colon" style="left: 85px; top: 60px; font-size: 16px; font-weight: 900; color: #000;">:</div>
                <div class="label-element" id="el_product_value" style="left: 100px; top: 60px; font-size: 16px; font-weight: 700; color: #000;"></div>
                
                <div class="label-element" id="el_design_label" style="left: 8px; top: 87px; font-size: 16px; font-weight: 900; color: #000;">DESIGN</div>
                <div class="label-element" id="el_design_colon" style="left: 85px; top: 87px; font-size: 16px; font-weight: 900; color: #000;">:</div>
                <div class="label-element" id="el_design_value" style="left: 100px; top: 87px; font-size: 16px; font-weight: 700; color: #000;"></div>
                
                <div class="label-element" id="el_color_label" style="left: 8px; top: 114px; font-size: 16px; font-weight: 900; color: #000;">COLOR</div>
                <div class="label-element" id="el_color_colon" style="left: 85px; top: 114px; font-size: 16px; font-weight: 900; color: #000;">:</div>
                <div class="label-element" id="el_color_value" style="left: 100px; top: 114px; font-size: 16px; font-weight: 700; color: #000;"></div>
                
                <div class="label-element" id="el_grade_label" style="left: 8px; top: 141px; font-size: 16px; font-weight: 900; color: #000;">GRADE</div>
                <div class="label-element" id="el_grade_colon" style="left: 85px; top: 141px; font-size: 16px; font-weight: 900; color: #000;">:</div>
                <div class="label-element" id="el_grade_value" style="left: 100px; top: 141px; font-size: 16px; font-weight: 700; color: #000;"></div>
                
                <div class="label-element" id="el_meters_label" style="left: 8px; top: 168px; font-size: 16px; font-weight: 900; color: #000;">METERS</div>
                <div class="label-element" id="el_meters_colon" style="left: 85px; top: 168px; font-size: 16px; font-weight: 900; color: #000;">:</div>
                <div class="label-element" id="el_meters_value" style="left: 100px; top: 168px; font-size: 16px; font-weight: 700; color: #000;"></div>
                <div class="label-element" id="el_bits_value" style="left: 135px; top: 168px; font-size: 14px; font-weight: 600; color: #000;"></div>
                
                <div class="label-element" id="el_weight_label" style="left: 8px; top: 195px; font-size: 16px; font-weight: 900; color: #000;">WEIGHT</div>
                <div class="label-element" id="el_weight_colon" style="left: 85px; top: 195px; font-size: 16px; font-weight: 900; color: #000;">:</div>
                <div class="label-element" id="el_weight_value" style="left: 100px; top: 195px; font-size: 16px; font-weight: 700; color: #000;"></div>
                
                <div class="label-element" id="el_rollno_label" style="left: 8px; top: 222px; font-size: 16px; font-weight: 900; color: #000;">ROLL NO</div>
                <div class="label-element" id="el_rollno_colon" style="left: 85px; top: 222px; font-size: 16px; font-weight: 900; color: #000;">:</div>
                <div class="label-element" id="el_rollno_value" style="left: 100px; top: 222px; font-size: 16px; font-weight: 700; color: #000;"></div>
            </div>
        </div>

        <!-- Right Panel - Tabs -->
        <div class="right-panel">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('print')">üñ®Ô∏è Print</button>
                <button class="tab" onclick="switchTab('log')">üìã Log</button>
                <button class="tab" onclick="switchTab('props')">üîß Props</button>
            </div>

            <!-- Print Tab -->
            <div class="tab-content active" id="tab-print">
                <div class="status disconnected" id="qzStatus">‚ö´ Not Connected</div>
                <button class="btn btn-secondary" onclick="connectQZ()" id="connectBtn">üîå Connect QZ Tray</button>

                <div class="form-group">
                    <label>Label Printer</label>
                    <select id="printerSelect" style="width:100%" onchange="selectedPrinter = this.value">
                        <option value="">-- Select Printer --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>DPI</label>
                    <select id="dpiSelect" style="width:100%">
                        <option value="203">203 DPI</option>
                        <option value="300">300 DPI</option>
                        <option value="150">150 DPI</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>üîç Print Fill % (adjust to fill paper)</label>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <input type="range" id="printFillSlider" min="80" max="150" value="105" style="flex:1" oninput="document.getElementById('printFillValue').textContent = this.value + '%'">
                        <span id="printFillValue" style="min-width:40px; font-weight:600;">105%</span>
                    </div>
                    <div style="font-size:9px; color:#888; margin-top:3px;">Increase if content is too small on paper</div>
                </div>

                <div class="form-group">
                    <label>Copies</label>
                    <div class="qty-control">
                        <button class="qty-btn" onclick="adjustQty(-1)">‚àí</button>
                        <input type="number" style="flex:1; text-align:center" id="qtyInput" value="1" min="1" max="100">
                        <button class="qty-btn" onclick="adjustQty(1)">+</button>
                    </div>
                </div>

                <button class="btn btn-primary" id="printBtn" onclick="printLabel()" disabled>üñ®Ô∏è PRINT LABEL</button>

                <hr>

                <div class="form-group">
                    <label>Dot Matrix Printer (for reports)</label>
                    <select id="dotMatrixSelect" style="width:100%">
                        <option value="">-- Select Printer --</option>
                    </select>
                </div>

                <button class="btn btn-secondary" onclick="openReportModal()">üìä Generate Report</button>
            </div>

            <!-- Log Tab -->
            <div class="tab-content" id="tab-log">
                <div style="margin-bottom: 10px;">
                    <label style="font-weight: 600; font-size: 12px; display: block; margin-bottom: 5px;">üìÖ Select Date:</label>
                    <input type="date" id="logDatePicker" onchange="window.logCurrentPage = 1; updateLogDisplay()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                </div>
                
                <div class="log-stats">
                    <div class="stat-box">
                        <div class="value" id="todayCount">0</div>
                        <div class="label">Prints</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="todayMeters">0</div>
                        <div class="label">Total Meters</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="todayRolls">0</div>
                        <div class="label">Total Rolls</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="todayWeight">0</div>
                        <div class="label">Total Kgs</div>
                    </div>
                </div>

                <div class="log-list" id="logList">
                    <div style="padding: 20px; text-align: center; color: #888;">
                        No prints logged
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="openReportModal()">üìä View Report</button>
                <button class="btn btn-secondary" onclick="exportLogCSV()">üì• Export CSV</button>
                <!-- üö´ Clear Log button REMOVED for data safety -->
            </div>

            <!-- Properties Tab -->
            <div class="tab-content" id="tab-props">
                <div id="elementProps" style="display: none;">
                    <div class="prop-group">
                        <label>Selected</label>
                        <div style="font-weight: 600; color: #059669;" id="selectedName">-</div>
                    </div>

                    <div class="prop-group" id="textEditGroup">
                        <label>‚úèÔ∏è Text Content</label>
                        <input type="text" id="propText" style="width:100%" oninput="updateElementText()" placeholder="Edit text...">
                    </div>

                    <div class="prop-group">
                        <label>Position (X, Y)</label>
                        <div class="prop-row">
                            <input type="number" id="propX" placeholder="X" onchange="updateElementPosition()">
                            <input type="number" id="propY" placeholder="Y" onchange="updateElementPosition()">
                        </div>
                    </div>

                    <div class="prop-group" id="fontSizeGroup">
                        <label>Font Size (px)</label>
                        <input type="number" id="propFontSize" min="6" max="36" style="width:100%" onchange="updateElementStyle()">
                    </div>

                    <div class="prop-group" id="fontWeightGroup">
                        <label>Font Weight</label>
                        <select id="propFontWeight" style="width:100%" onchange="updateElementStyle()">
                            <option value="400">Normal (400)</option>
                            <option value="500">Medium (500)</option>
                            <option value="600">Semi-Bold (600)</option>
                            <option value="700">Bold (700)</option>
                            <option value="800">Extra-Bold (800)</option>
                            <option value="900">Black (900)</option>
                        </select>
                    </div>

                    <div class="prop-group" id="lineHeightGroup" style="display:none;">
                        <label>Line Thickness (px)</label>
                        <input type="number" id="propLineHeight" min="1" max="10" style="width:100%" onchange="updateLineThickness()">
                    </div>

                    <div class="prop-group" id="logoSizeGroup" style="display:none;">
                        <label>Logo Size (px)</label>
                        <input type="number" id="propLogoSize" min="20" max="100" style="width:100%" onchange="updateLogoSize()">
                    </div>

                    <div class="prop-group" id="fontFamilyGroup">
                        <label>Font Family</label>
                        <select id="propFontFamily" style="width:100%" onchange="updateElementStyle()">
                            <option value="Arial, sans-serif">Arial</option>
                            <option value="'Times New Roman', serif">Times New Roman</option>
                            <option value="'Courier New', monospace">Courier New</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="Verdana, sans-serif">Verdana</option>
                            <option value="Impact, sans-serif">Impact</option>
                            <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                        </select>
                    </div>
                </div>

                <div id="noSelection" style="color: #888; font-size: 11px; padding: 10px; background: #f8f8f8; border-radius: 4px;">
                    üëÜ Click any element to edit
                </div>

                <hr>

                <h2 style="font-size: 12px; color: #059669; margin-bottom: 10px;">üìû Contact Bar</h2>
                <div class="prop-group">
                    <label>Phone</label>
                    <input type="text" id="contactPhone" style="width:100%" value="+91-9000317333" oninput="updateContactBar()">
                </div>
                <div class="prop-group">
                    <label>Email</label>
                    <input type="text" id="contactEmail" style="width:100%" value="info@snehavinyl.in" oninput="updateContactBar()">
                </div>
                <div class="prop-group">
                    <label>Bar Font Size (px)</label>
                    <input type="number" id="contactFontSize" style="width:100%" value="9" min="6" max="14" oninput="updateContactBar()">
                </div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3>üìä Daily Production Report</h3>
                <button class="modal-close" onclick="closeReportModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="filter-row" style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <div class="form-group" style="flex: 1; min-width: 120px;">
                        <label>Date</label>
                        <input type="date" id="reportDate" onchange="generateReport()">
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 120px;">
                        <label>Report Type</label>
                        <select id="reportType" onchange="generateReport()">
                            <option value="labels">Labels Only</option>
                            <option value="rejects">Rejects Only</option>
                            <option value="all">All (Combined)</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 100px;">
                        <label>System</label>
                        <select id="reportSystem" onchange="generateReport()">
                            <option value="">All Systems</option>
                            <option value="1">Sys 1</option>
                            <option value="2">Sys 2</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 120px;">
                        <label>Client</label>
                        <select id="reportClient" onchange="generateReport()">
                            <option value="">All Clients</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 120px;">
                        <label>Product</label>
                        <select id="reportProduct" onchange="generateReport()">
                            <option value="">All Products</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 120px;">
                        <label>Design</label>
                        <select id="reportDesign" onchange="generateReport()">
                            <option value="">All Designs</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 100px;">
                        <label>Grade</label>
                        <select id="reportGrade" onchange="generateReport()">
                            <option value="">All Grades</option>
                            <option value="A">A</option>
                            <option value="STD">STD</option>
                            <option value="COMMERCIAL">COMMERCIAL</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 100px;">
                        <label>Color</label>
                        <select id="reportColor" onchange="generateReport()">
                            <option value="">All Colors</option>
                        </select>
                    </div>
                </div>
                
                <!-- Label Number Range Filter -->
                <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px; margin: 10px 0;">
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <label style="font-size: 12px; font-weight: 600; color: #475569;">
                            <input type="checkbox" id="enableLabelRange" onchange="toggleLabelRange(); generateReport();" style="margin-right: 5px;">
                            Label Number Range Filter
                        </label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span style="font-size: 11px; color: #64748b;">From Label:</span>
                            <input type="text" id="labelStart" placeholder="e.g., 10100001" style="width: 100px; padding: 4px; font-size: 12px;" onchange="generateReport()" disabled>
                            <span style="font-size: 11px; color: #64748b;">To Label:</span>
                            <input type="text" id="labelEnd" placeholder="e.g., 10100100" style="width: 100px; padding: 4px; font-size: 12px;" onchange="generateReport()" disabled>
                        </div>
                    </div>
                </div>

                <div class="report-preview" id="reportPreview" style="max-height: 500px; overflow-y: auto;">
                    <!-- Report will be generated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeReportModal()">Close</button>
                <button class="btn btn-secondary" onclick="printReportBrowser()">üñ®Ô∏è Browser Print</button>
                <button class="btn btn-primary" onclick="printReportDotMatrix()">üñ®Ô∏è Print to Dot Matrix</button>
            </div>
        </div>
    </div>

    <!-- Rejects Entry Modal -->
    <div class="modal-overlay" id="rejectsModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header" style="background: #fef2f2; border-bottom-color: #fecaca;">
                <h3 style="color: #dc2626;">üö´ Rejects Entry</h3>
                <button class="modal-close" onclick="closeRejectsModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div style="background: #fef2f2; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 12px; color: #991b1b;">
                    <strong>Note:</strong> Product, Design & Color are auto-filled for rejects.
                </div>
                
                <div class="form-group">
                    <label>System</label>
                    <select id="rejectSystem" style="width: 100%;" onchange="generateRejectRollNumber()">
                        <option value="1">Sys 1</option>
                        <option value="2">Sys 2</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Client</label>
                    <select id="rejectClient" style="width: 100%;">
                        <option value="">-- Select Client --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Roll Number (Auto)</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="rejectRollNo" style="font-weight: 700; flex: 1;" placeholder="Auto-generated or enter manually">
                        <button type="button" onclick="generateRejectRollNumber()" style="padding: 8px 12px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer;" title="Regenerate">üîÑ</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Product</label>
                    <input type="text" id="rejectProduct" value="Rejects" readonly style="background: #f0f0f0; font-weight: 600;">
                </div>
                
                <div class="form-group">
                    <label>Design</label>
                    <input type="text" id="rejectDesign" value="All Design" readonly style="background: #f0f0f0;">
                </div>
                
                <div class="form-group">
                    <label>Color</label>
                    <input type="text" id="rejectColor" value="All Color" readonly style="background: #f0f0f0;">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Meters</label>
                        <input type="number" step="0.1" id="rejectMeters" placeholder="e.g., 50">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Weight (Kgs)</label>
                        <input type="number" step="0.1" id="rejectWeight" placeholder="e.g., 2.5">
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="rejectPrintLabel" style="width: 18px; height: 18px;">
                        <span>üñ®Ô∏è Print Label for this Reject</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRejectsModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveRejectsEntry()" style="background: #dc2626;">‚úÖ Save Rejects Entry</button>
            </div>
        </div>
    </div>
    
    <!-- Extra Rolls Modal - Add to Existing Label -->
    <div class="modal-overlay" id="extraRollsModal">
        <div class="modal">
            <div class="modal-header" style="background: #e0f2fe;">
                <h3 style="color: #0284c7;">üì¶ Add Extra / Low Quantity Roll</h3>
                <button class="modal-close" onclick="closeExtraRollsModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>SELECT EXISTING LABEL</label>
                    <select id="extraLabelSelect" onchange="loadExtraLabelDetails()" style="font-weight: 600;">
                        <option value="">-- Select Label Number --</option>
                    </select>
                </div>
                
                <div id="extraLabelFields" style="display: none;">
                    <div class="form-group">
                        <label>PRODUCT</label>
                        <input type="text" id="extraDetailProduct" readonly style="background: #f1f5f9; font-weight: 600;">
                    </div>
                    <div class="form-group">
                        <label>DESIGN</label>
                        <input type="text" id="extraDetailDesign" readonly style="background: #f1f5f9;">
                    </div>
                    <div class="form-group">
                        <label>COLOR</label>
                        <input type="text" id="extraDetailColor" readonly style="background: #f1f5f9;">
                    </div>
                    <div class="form-group">
                        <label>GRADE</label>
                        <input type="text" id="extraDetailGrade" readonly style="background: #f1f5f9;">
                    </div>
                    
                    <div style="background: #e0f2fe; padding: 8px; border-radius: 6px; margin: 10px 0; font-size: 12px;">
                        <b>Current Meters:</b> <span id="extraDetailMeters" style="color: #0284c7; font-weight: 700;">-</span> &nbsp;|&nbsp;
                        <b>Current Weight:</b> <span id="extraDetailWeight">-</span>
                    </div>
                    
                    <div class="form-group">
                        <label>METERS (Low Quantity) - TO ADD</label>
                        <input type="number" id="extraMetersToAdd" placeholder="e.g., 3, 5, 7" step="0.1" oninput="calculateNewTotal()">
                        <div id="newTotalDisplay" style="font-size: 11px; color: #059669; margin-top: 5px; font-weight: 600;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label>WEIGHT (Kgs) - TO ADD (Optional)</label>
                        <input type="number" id="extraWeightToAdd" placeholder="Weight to add" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label>SYSTEM</label>
                        <input type="text" id="extraDetailSystem" readonly style="background: #f1f5f9;">
                    </div>
                    
                    <div style="background: #f0fdf4; padding: 10px; border-radius: 6px; margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; color: #166534;">
                            <input type="checkbox" id="extraPrintLabel" style="width: 18px; height: 18px;">
                            <span>üñ®Ô∏è Print Label for this Extra Roll</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeExtraRollsModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveExtraRoll()" style="background: #0284c7;">‚úÖ Save Extra Roll</button>
            </div>
        </div>
    </div>

    <!-- v29: Backup Settings Modal removed (auto-backup to browser storage eliminated) -->

    <!-- Master Data Management Modal -->
    <div class="modal-overlay" id="masterManagementModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header" style="background: #f1f5f9;">
                <h3 style="color: #334155;">‚öôÔ∏è Master Data Management</h3>
                <button class="modal-close" onclick="closeMasterManagement()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Master Type BUTTON TABS (replaces dropdown) -->
                <div id="masterTypeTabs" style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 12px;">
                    <button class="master-tab-btn active" data-type="client" onclick="switchMasterTab('client')">üë• Clients</button>
                    <button class="master-tab-btn" data-type="product" onclick="switchMasterTab('product')">üì¶ Products</button>
                    <button class="master-tab-btn" data-type="design" onclick="switchMasterTab('design')">üé® Designs</button>
                    <button class="master-tab-btn" data-type="color" onclick="switchMasterTab('color')">üåà Colors</button>
                </div>
                <!-- Hidden select for compatibility -->
                <select id="masterTypeSelect" style="display: none;">
                    <option value="client">Clients</option>
                    <option value="product">Products</option>
                    <option value="design">Designs</option>
                    <option value="color">Colors</option>
                </select>
                
                <!-- Master Lock Status Banner -->
                <div id="masterLockBanner" style="background: #fef2f2; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 2px solid #fecaca; display: none;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 18px;">üîí</span>
                        <div>
                            <div style="font-size: 12px; font-weight: 700; color: #dc2626;">MASTER LOCK IS ON</div>
                            <div style="font-size: 10px; color: #991b1b;">New entries are blocked. Disable lock from main screen to add new masters.</div>
                        </div>
                    </div>
                </div>
                
                <div style="background: #fef3c7; padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 10px; color: #92400e;">
                    <b>‚ö†Ô∏è Safety Rules:</b> Masters used in labels/reports cannot be deleted. You can mark them as inactive instead, or use Merge to consolidate duplicates.
                </div>
                
                <!-- üîç SEARCH INPUT -->
                <div style="margin-bottom: 10px;">
                    <input type="text" id="masterSearchInput" placeholder="üîç Search master records..." 
                           oninput="filterMasterList()" 
                           style="width: 100%; padding: 10px 12px; font-size: 13px; border: 2px solid #e2e8f0; border-radius: 8px; box-sizing: border-box;">
                </div>
                
                <div id="masterListContainer" style="max-height: 220px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead style="background: #f8fafc; position: sticky; top: 0;">
                            <tr>
                                <th style="padding: 8px; text-align: center; width: 30px; border-bottom: 1px solid #e2e8f0;">
                                    <input type="checkbox" id="selectAllMasters" onchange="toggleSelectAllMasters()" title="Select all for merge">
                                </th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e2e8f0;">Name</th>
                                <th style="padding: 8px; text-align: center; width: 50px; border-bottom: 1px solid #e2e8f0;">Used</th>
                                <th style="padding: 8px; text-align: center; width: 55px; border-bottom: 1px solid #e2e8f0;">Status</th>
                                <th style="padding: 8px; text-align: center; width: 70px; border-bottom: 1px solid #e2e8f0;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="masterListBody">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Bulk Actions Section -->
                <div id="bulkActionsSection" style="margin-top: 10px; padding: 10px; background: #f1f5f9; border-radius: 6px; display: none;">
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <span style="font-size: 11px; font-weight: 600; color: #475569;" id="selectedCountText">0 selected</span>
                        <button class="btn" onclick="bulkDeleteMasters()" style="padding: 5px 10px; background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; font-size: 10px; border-radius: 4px;">üóëÔ∏è Delete Selected</button>
                        <button class="btn" onclick="showMergeSection()" style="padding: 5px 10px; background: #dbeafe; border: 1px solid #93c5fd; color: #1d4ed8; font-size: 10px; border-radius: 4px;">üîÄ Merge Selected</button>
                    </div>
                </div>
                
                <!-- Merge Section -->
                <div id="mergeSection" style="margin-top: 10px; padding: 10px; background: #dbeafe; border-radius: 6px; display: none;">
                    <div style="font-size: 11px; font-weight: 600; color: #1e40af; margin-bottom: 8px;">üîÄ Merge Selected Into Target:</div>
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <select id="mergeTargetSelect" style="flex: 1; min-width: 150px; padding: 6px; font-size: 11px;">
                            <option value="">-- Select Target --</option>
                        </select>
                        <button class="btn btn-primary" onclick="executeMerge()" style="padding: 6px 12px; background: #2563eb; font-size: 11px;">üîÄ Merge & Reassign</button>
                    </div>
                    <div style="font-size: 9px; color: #1e40af; margin-top: 5px;">
                        All labels/reports from selected items will be moved to target. Old items become inactive.
                    </div>
                </div>
                
                <!-- Add New Master Entry (DISABLED when lock is ON) -->
                <div id="addMasterSection" style="margin-top: 10px; padding: 10px; background: #f8fafc; border-radius: 6px;">
                    <div style="font-size: 11px; font-weight: 600; margin-bottom: 8px;">‚ûï Add New Master Entry:</div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="newMasterValue" placeholder="Enter new value..." style="flex: 1; padding: 6px;">
                        <button class="btn btn-primary" id="addMasterBtn" onclick="addNewMaster()" style="padding: 6px 12px;">Add</button>
                    </div>
                    <div id="addMasterLockMsg" style="display: none; font-size: 10px; color: #dc2626; margin-top: 5px;">
                        üîí Master Lock is ON. Disable lock to add new entries.
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
                <button class="btn" onclick="reconcileMasters()" style="padding: 8px 12px; background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; font-size: 11px; font-weight: 600;">üîß Reconcile Usage</button>
                <button class="btn btn-secondary" onclick="closeMasterManagement()">Close</button>
            </div>
        </div>
    </div>

    <!-- Data Migration Tool Modal -->
    <div class="modal-overlay" id="migrationModal">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header" style="background: #fef3c7;">
                <h3 style="color: #92400e;">üîÑ Old Data Migration & Cleaning Tool</h3>
                <button class="modal-close" onclick="closeMigrationTool()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="font-size: 12px; color: #64748b; margin-bottom: 15px;">
                    Import old backup data, clean duplicates, enforce CAPITAL CASE, and migrate to new format.
                </p>
                
                <div style="background: #dbeafe; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 11px; color: #1e40af;">
                    <b>üìå Migration will:</b><br>
                    ‚Ä¢ Convert all text to UPPERCASE<br>
                    ‚Ä¢ Merge duplicate entries (sneha, Sneha, SNEHA ‚Üí SNEHA)<br>
                    ‚Ä¢ Clean special characters and extra spaces<br>
                    ‚Ä¢ Preserve all labels, rolls, and meters data<br>
                    ‚Ä¢ Make data compatible with new features
                </div>
                
                <div class="form-group">
                    <label>SELECT OLD BACKUP FILE</label>
                    <input type="file" id="migrationFile" accept=".json" style="padding: 8px; border: 2px dashed #cbd5e1; border-radius: 6px; width: 100%;">
                </div>
                
                <div id="migrationPreview" style="display: none; margin-top: 15px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">üìä Migration Preview:</div>
                    <div id="migrationStats" style="background: #f8fafc; padding: 10px; border-radius: 6px; font-size: 11px;"></div>
                </div>
                
                <div id="migrationProgress" style="display: none; margin-top: 15px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">‚è≥ Migration Progress:</div>
                    <div style="background: #f0f0f0; border-radius: 4px; overflow: hidden;">
                        <div id="migrationProgressBar" style="height: 20px; background: #22c55e; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div id="migrationLog" style="margin-top: 8px; font-size: 10px; color: #64748b; max-height: 100px; overflow-y: auto;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="previewMigration()">üëÅÔ∏è Preview Changes</button>
                <button class="btn btn-secondary" onclick="closeMigrationTool()">Cancel</button>
                <button class="btn btn-primary" onclick="executeMigration()" style="background: #f59e0b;" id="executeMigrationBtn" disabled>‚úÖ Execute Migration</button>
            </div>
        </div>
    </div>

    <!-- Error Log Modal - FULLSCREEN UI v27 -->
    <div class="modal-overlay" id="errorLogModal">
        <div id="errorLogModalContent">
            <!-- HEADER -->
            <div style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); padding: 18px 25px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                <span style="font-size: 18px; font-weight: 700; color: white;">üî¥ Application Error Log</span>
                <button onclick="closeErrorLog()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            
            <!-- FILTERS BAR -->
            <div style="padding: 15px 25px; background: #f1f5f9; border-bottom: 1px solid #e2e8f0; flex-shrink: 0;">
                <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-size: 13px; font-weight: 600; color: #334155;">Severity:</label>
                        <select id="errorSeverityFilter" onchange="displayErrorLog()" style="padding: 10px 15px; font-size: 14px; border: 1px solid #cbd5e1; border-radius: 8px; min-width: 160px; background: white;">
                            <option value="">All Severities</option>
                            <option value="INFO">‚ÑπÔ∏è INFO</option>
                            <option value="WARN">‚ö†Ô∏è WARN</option>
                            <option value="ERROR">‚ùå ERROR</option>
                            <option value="CRITICAL">üî¥ CRITICAL</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-size: 13px; font-weight: 600; color: #334155;">Module:</label>
                        <select id="errorModuleFilter" onchange="displayErrorLog()" style="padding: 10px 15px; font-size: 14px; border: 1px solid #cbd5e1; border-radius: 8px; min-width: 160px; background: white;">
                            <option value="">All Modules</option>
                            <option value="Master">Master</option>
                            <option value="Label">Label</option>
                            <option value="Backup">Backup</option>
                            <option value="Cleanup">Cleanup</option>
                            <option value="Merge">Merge</option>
                        </select>
                    </div>
                    <button onclick="clearErrorLog()" style="padding: 10px 18px; font-size: 13px; background: #fef2f2; border: 2px solid #fecaca; color: #dc2626; border-radius: 8px; cursor: pointer; font-weight: 700;">üóëÔ∏è Clear Log</button>
                    <span id="errorLogCount" style="font-size: 14px; color: #475569; font-weight: 600; margin-left: auto;"></span>
                </div>
            </div>
            
            <!-- TABLE CONTAINER -->
            <div id="errorLogContainer" style="flex: 1; overflow: auto; padding: 0; background: white;">
                <table id="errorLogTable" style="width: 100%; border-collapse: collapse; font-size: 14px; table-layout: fixed;">
                    <thead style="background: #e2e8f0; position: sticky; top: 0; z-index: 10;">
                        <tr>
                            <th style="padding: 14px 20px; text-align: left; border-bottom: 2px solid #94a3b8; font-weight: 700; color: #1e293b; width: 200px;">Time</th>
                            <th style="padding: 14px 20px; text-align: center; border-bottom: 2px solid #94a3b8; font-weight: 700; color: #1e293b; width: 120px;">Severity</th>
                            <th style="padding: 14px 20px; text-align: left; border-bottom: 2px solid #94a3b8; font-weight: 700; color: #1e293b; width: 220px;">Module / Action</th>
                            <th style="padding: 14px 20px; text-align: left; border-bottom: 2px solid #94a3b8; font-weight: 700; color: #1e293b;">Message</th>
                        </tr>
                    </thead>
                    <tbody id="errorLogBody">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
            </div>
            
            <!-- FOOTER -->
            <div style="padding: 15px 25px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 15px; flex-shrink: 0;">
                <button onclick="exportErrorLog()" style="padding: 12px 25px; font-size: 14px; font-weight: 600; background: #059669; color: white; border: none; border-radius: 8px; cursor: pointer;">üì• Export Log</button>
                <button onclick="closeErrorLog()" style="padding: 12px 25px; font-size: 14px; font-weight: 600; background: #64748b; color: white; border: none; border-radius: 8px; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Firebase Migration Modal v27 -->
    <div class="modal-overlay" id="firebaseMigrationModal">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header" style="background: #fef3c7;">
                <h3 style="color: #92400e;">üî• Firebase Cloud Migration</h3>
                <button class="modal-close" onclick="closeFirebaseMigration()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="font-size: 12px; color: #64748b; margin-bottom: 15px;">
                    Migrate your local data to Firebase cloud storage for multi-device sync.
                </p>
                
                <div id="fbMigrationStatus" style="background: #dbeafe; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 11px; color: #1e40af;">
                    <b>üìå Current Status:</b><br>
                    <span id="fbStatusText">Checking Firebase connection...</span>
                </div>
                
                <div style="background: #f0fdf4; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 11px; color: #166534;">
                    <b>‚úÖ Migration will:</b><br>
                    ‚Ä¢ Upload all masters (Clients, Products, Designs, Colors)<br>
                    ‚Ä¢ Upload print log (all labels)<br>
                    ‚Ä¢ Upload layouts and settings<br>
                    ‚Ä¢ Enable multi-device sync<br>
                    ‚Ä¢ Keep local backup for offline use
                </div>
                
                <div id="fbMigrationPreview" style="display: none; margin-top: 15px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">üìä Data to Migrate:</div>
                    <div id="fbMigrationStats" style="background: #f8fafc; padding: 10px; border-radius: 6px; font-size: 11px;"></div>
                </div>
                
                <div id="fbMigrationProgress" style="display: none; margin-top: 15px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">‚è≥ Migration Progress:</div>
                    <div style="background: #f0f0f0; border-radius: 4px; overflow: hidden;">
                        <div id="fbMigrationProgressBar" style="height: 20px; background: #f59e0b; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div id="fbMigrationLog" style="margin-top: 8px; font-size: 10px; color: #64748b; max-height: 150px; overflow-y: auto; font-family: monospace;"></div>
                </div>
                
                <div id="fbMigrationComplete" style="display: none; margin-top: 15px; background: #dcfce7; padding: 15px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 8px;">‚úÖ</div>
                    <div style="font-weight: 600; color: #166534;">Migration Complete!</div>
                    <div style="font-size: 11px; color: #166534; margin-top: 5px;">Your data is now syncing with Firebase.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="previewFirebaseMigration()" id="fbPreviewBtn">üëÅÔ∏è Preview Data</button>
                <button class="btn btn-secondary" onclick="closeFirebaseMigration()">Cancel</button>
                <button class="btn btn-primary" onclick="executeFirebaseMigration()" style="background: #f59e0b;" id="fbExecuteBtn" disabled>üöÄ Start Migration</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * ================================================================
         * SNEHA VINYL LABEL PRINTER - APPLICATION v27.1
         * ================================================================
         * 
         * @description WYSIWYG Label Designer & Printer PWA for manufacturing
         * @company Sneha Vinyl Products PVT LTD
         * @established 1984
         * @location Tirupati, AP, India
         * 
         * MODULES:
         * 1. SnehaConfig      - Application configuration & constants
         * 2. SnehaFirebase    - Firebase cloud sync service
         * 3. SnehaData        - Data management (masters, logs, layouts)
         * 4. SnehaValidation  - Input validation & sanitization
         * 5. SnehaUI          - User interface functions
         * 6. SnehaPrint       - Print engine (QZ Tray integration)
         * 7. SnehaLayout      - WYSIWYG layout manager
         * 
         * STORAGE KEYS:
         * - snehaCustom_{type}          : Custom master data
         * - snehaPrintLog               : Print history
         * - snehaLayout_*               : Layout configurations
         * - snehaRollSerial_*           : Roll number sequences
         * - snehaErrorLog               : Application error log
         * - snehaSettings               : User preferences
         * ================================================================
         */

        // ============================================================
        // üîß APPLICATION CONFIGURATION
        // ============================================================
        
        /**
         * @typedef {Object} SnehaConfigType
         * @property {Object} company - Company information
         * @property {Object} label - Label dimensions and settings
         * @property {Object} storage - Storage keys and limits
         * @property {Object} validation - Validation rules
         */
        const SnehaConfig = Object.freeze({
            // Application version
            VERSION: '29.0',
            BUILD_DATE: '2026-02-08',
            
            // Company Information
            company: {
                name: 'SNEHA VINYL PRODUCTS PVT LTD',
                tagline: 'SINCE 1984',
                address: '14-34, IDA, RENIGUNTA, TIRUPATI, AP',
                phone: '+91-9000317333',
                email: 'info@snehavinyl.in'
            },
            
            // Label Configuration
            label: {
                widthInches: 3,
                heightInches: 3,
                canvasPixels: 288,  // 3 inches at 96 DPI
                defaultDPI: 203     // Thermal printer DPI
            },
            
            // Storage Configuration
            storage: {
                maxErrorLogEntries: 500,
                maxPrintLogEntries: 10000,
                backupRetentionDays: 30,
                keys: {
                    printLog: 'snehaPrintLog',
                    errorLog: 'snehaErrorLog',
                    layoutMode: 'snehaLayout_mode',
                    layoutWithHeader: 'snehaLayout_withHeader_v3',
                    layoutWithoutHeader: 'snehaLayout_withoutHeader_v3',
                    masterLock: 'snehaMasterLock',
                    editLock: 'snehaEditLocked',
                    lastSystem: 'snehaLastSystem',
                    deletedMasters: 'snehaDeletedMasters',
                    inactiveMasters: 'snehaInactiveMasters'
                }
            },
            
            // Validation Rules
            validation: {
                maxMasterLength: 100,
                maxMeters: 99999,
                maxWeight: 9999,
                rollNumberFormat: /^[12](0[1-9]|1[0-2])\d{5}$/,
                forbiddenChars: /[\\\/'"`<>]/g
            },
            
            // Master Data Types
            masterTypes: ['client', 'product', 'design', 'color'],
            
            // Grade Options
            gradeOptions: ['PRIME', 'ECO', 'MILL-2'],
            
            // Default Print Fill Percentage
            defaultPrintFill: 100
        });

        // ============================================================
        // üõ°Ô∏è ERROR BOUNDARY & SAFE EXECUTION
        // ============================================================
        
        /**
         * Safely execute a function with error handling
         * @param {Function} fn - Function to execute
         * @param {string} context - Context for error logging
         * @param {*} fallback - Fallback value on error
         * @returns {*} Result of function or fallback
         */
        function safeExecute(fn, context = 'Unknown', fallback = null) {
            try {
                return fn();
            } catch (error) {
                console.error(`[SafeExecute Error] ${context}:`, error);
                if (typeof logError === 'function') {
                    logError('SafeExecute', context, error.message, 'ERROR');
                }
                return fallback;
            }
        }

        /**
         * Safely execute an async function with error handling
         * @param {Function} fn - Async function to execute
         * @param {string} context - Context for error logging
         * @param {*} fallback - Fallback value on error
         * @returns {Promise<*>} Result of function or fallback
         */
        async function safeExecuteAsync(fn, context = 'Unknown', fallback = null) {
            try {
                return await fn();
            } catch (error) {
                console.error(`[SafeExecuteAsync Error] ${context}:`, error);
                if (typeof logError === 'function') {
                    logError('SafeExecuteAsync', context, error.message, 'ERROR');
                }
                return fallback;
            }
        }

        /**
         * Show user-friendly error toast
         * @param {string} message - Error message to display
         * @param {string} type - Type: 'error', 'warning', 'success', 'info'
         */
        function showToast(message, type = 'info') {
            // Create toast container if not exists
            let container = document.getElementById('toastContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toastContainer';
                container.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10001;
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                `;
                document.body.appendChild(container);
            }
            
            const colors = {
                error: { bg: '#fee2e2', border: '#dc2626', text: '#991b1b' },
                warning: { bg: '#fef3c7', border: '#f59e0b', text: '#92400e' },
                success: { bg: '#d1fae5', border: '#059669', text: '#065f46' },
                info: { bg: '#dbeafe', border: '#3b82f6', text: '#1e40af' }
            };
            
            const style = colors[type] || colors.info;
            
            const toast = document.createElement('div');
            toast.style.cssText = `
                padding: 12px 20px;
                background: ${style.bg};
                border: 1px solid ${style.border};
                border-left: 4px solid ${style.border};
                color: ${style.text};
                border-radius: 6px;
                font-size: 13px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease;
                max-width: 350px;
            `;
            toast.textContent = message;
            container.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Add toast animations
        if (!document.getElementById('toastStyles')) {
            const style = document.createElement('style');
            style.id = 'toastStyles';
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }

        // ============================================================
        // üî• FIREBASE CLOUD SYNC SERVICE v27
        // ============================================================
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAl5fnNFvhONeml1sJdSuF_c7ZBsWk6P3w",
            authDomain: "sneha-vinyl-label.firebaseapp.com",
            projectId: "sneha-vinyl-label",
            storageBucket: "sneha-vinyl-label.firebasestorage.app",
            messagingSenderId: "355847323576",
            appId: "1:355847323576:web:aa808e744bc56f4d78194d"
        };
        
        // Firebase state
        let firebaseApp = null;
        let firebaseDb = null;
        let firebaseReady = false;
        let firebaseOnline = false;
        let firebaseMigrated = false; // Has data been migrated to Firebase?
        
        // Firebase Service Object
        const SnehaFirebase = {
            /**
             * Initialize Firebase connection and setup listeners
             * @returns {Promise<boolean>} True if initialization successful
             */
            init: async function() {
                try {
                    // v29: Block Firebase sync on localhost (prevents test data polluting production)
                    const host = window.location.hostname;
                    if (host === 'localhost' || host === '127.0.0.1' || host.startsWith('192.168.')) {
                        console.warn('üõë Localhost detected ‚Äî Firebase sync DISABLED (test mode)');
                        this.updateSyncIndicator('offline', 'LOCAL TEST MODE');
                        return false;
                    }

                    // Check if Firebase SDK loaded
                    if (typeof firebase === 'undefined') {
                        console.warn('Firebase SDK not loaded - using localStorage only');
                        this.updateSyncIndicator('offline', 'Local Only (No Firebase)');
                        return false;
                    }
                    
                    // Initialize Firebase app
                    firebaseApp = firebase.initializeApp(firebaseConfig);
                    firebaseDb = firebase.firestore();
                    
                    // Enable offline persistence
                    try {
                        await firebaseDb.enablePersistence({ synchronizeTabs: true });
                        console.log('üî• Firestore offline persistence enabled');
                    } catch (err) {
                        if (err.code === 'failed-precondition') {
                            console.warn('Multiple tabs open - persistence limited to one tab');
                        } else if (err.code === 'unimplemented') {
                            console.warn('Browser does not support offline persistence');
                        }
                    }
                    
                    // Check connection status
                    this.setupConnectionListener();
                    
                    // Check if already migrated
                    await this.checkMigrationStatus();
                    
                    firebaseReady = true;
                    console.log('üî• Firebase initialized successfully');
                    return true;
                } catch (error) {
                    console.error('Firebase init error:', error);
                    this.updateSyncIndicator('error', 'Firebase Error');
                    return false;
                }
            },
            
            // Setup connection listener
            setupConnectionListener: function() {
                // Firestore doesn't have direct online/offline detection
                // We use navigator.onLine and periodic checks
                const updateStatus = () => {
                    firebaseOnline = navigator.onLine;
                    if (firebaseReady && firebaseMigrated) {
                        this.updateSyncIndicator(
                            firebaseOnline ? 'online' : 'offline',
                            firebaseOnline ? 'Cloud Synced' : 'Offline Mode'
                        );
                    }
                };
                
                window.addEventListener('online', updateStatus);
                window.addEventListener('offline', updateStatus);
                updateStatus();
            },
            
            // Update sync indicator in UI
            updateSyncIndicator: function(status, text) {
                const dot = document.getElementById('syncDot');
                const textEl = document.getElementById('syncText');
                if (!dot || !textEl) return;
                
                const colors = {
                    'online': '#22c55e',    // Green
                    'offline': '#f59e0b',   // Orange
                    'syncing': '#3b82f6',   // Blue
                    'error': '#ef4444',     // Red
                    'local': '#9ca3af'      // Gray
                };
                
                dot.style.background = colors[status] || colors.local;
                textEl.textContent = text;
            },
            
            // Check if data has been migrated to Firebase
            checkMigrationStatus: async function() {
                try {
                    const settingsDoc = await firebaseDb.collection('settings').doc('app').get();
                    if (settingsDoc.exists && settingsDoc.data().migrated === true) {
                        firebaseMigrated = true;
                        this.updateSyncIndicator('online', 'Cloud Synced');
                        console.log('üî• Firebase migration status: MIGRATED');
                    } else {
                        firebaseMigrated = false;
                        this.updateSyncIndicator('local', 'Local Only');
                        console.log('üî• Firebase migration status: NOT MIGRATED');
                    }
                } catch (error) {
                    console.warn('Could not check migration status:', error);
                    firebaseMigrated = false;
                    this.updateSyncIndicator('local', 'Local Only');
                }
            },
            
            // ==================== MASTERS ====================
            
            // Get all masters of a type
            getMasters: async function(type) {
                if (!firebaseReady || !firebaseMigrated) return null;
                try {
                    const snapshot = await firebaseDb.collection('masters').doc(type).collection('items').get();
                    const masters = [];
                    snapshot.forEach(doc => {
                        masters.push({ id: doc.id, ...doc.data() });
                    });
                    return masters;
                } catch (error) {
                    console.error(`Error getting ${type} masters:`, error);
                    return null;
                }
            },
            
            // Add a master
            addMaster: async function(type, name, source = 'custom') {
                if (!firebaseReady || !firebaseMigrated) return false;
                try {
                    const docId = name.toUpperCase().replace(/[^A-Z0-9]/g, '_');
                    await firebaseDb.collection('masters').doc(type).collection('items').doc(docId).set({
                        name: name.toUpperCase(),
                        source: source,
                        status: 'active',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    return true;
                } catch (error) {
                    console.error(`Error adding ${type} master:`, error);
                    return false;
                }
            },
            
            // Update master status
            updateMasterStatus: async function(type, name, status) {
                if (!firebaseReady || !firebaseMigrated) return false;
                try {
                    const docId = name.toUpperCase().replace(/[^A-Z0-9]/g, '_');
                    await firebaseDb.collection('masters').doc(type).collection('items').doc(docId).update({
                        status: status,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return true;
                } catch (error) {
                    console.error(`Error updating ${type} master status:`, error);
                    return false;
                }
            },
            
            // Rename master
            renameMaster: async function(type, oldName, newName) {
                if (!firebaseReady || !firebaseMigrated) return false;
                try {
                    const oldDocId = oldName.toUpperCase().replace(/[^A-Z0-9]/g, '_');
                    const newDocId = newName.toUpperCase().replace(/[^A-Z0-9]/g, '_');
                    
                    // Get old document
                    const oldDoc = await firebaseDb.collection('masters').doc(type).collection('items').doc(oldDocId).get();
                    if (!oldDoc.exists) return false;
                    
                    const data = oldDoc.data();
                    
                    // Create new document
                    await firebaseDb.collection('masters').doc(type).collection('items').doc(newDocId).set({
                        ...data,
                        name: newName.toUpperCase(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Delete old document
                    await firebaseDb.collection('masters').doc(type).collection('items').doc(oldDocId).delete();
                    
                    return true;
                } catch (error) {
                    console.error(`Error renaming ${type} master:`, error);
                    return false;
                }
            },
            
            // ==================== LABELS (Print Log) ====================
            
            // Add a label
            addLabel: async function(label) {
                if (!firebaseReady || !firebaseMigrated) return false;
                try {
                    const docId = `${label.rollNo}_${label.id}`;
                    await firebaseDb.collection('labels').doc(docId).set({
                        ...label,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return true;
                } catch (error) {
                    console.error('Error adding label:', error);
                    return false;
                }
            },
            
            // Get labels by date
            getLabelsByDate: async function(date) {
                if (!firebaseReady || !firebaseMigrated) return null;
                try {
                    const snapshot = await firebaseDb.collection('labels')
                        .where('date', '==', date)
                        .get();
                    const labels = [];
                    snapshot.forEach(doc => labels.push(doc.data()));
                    return labels;
                } catch (error) {
                    console.error('Error getting labels:', error);
                    return null;
                }
            },
            
            // Get all labels (for reports)
            getAllLabels: async function() {
                if (!firebaseReady || !firebaseMigrated) return null;
                try {
                    const snapshot = await firebaseDb.collection('labels').get();
                    const labels = [];
                    snapshot.forEach(doc => labels.push(doc.data()));
                    return labels;
                } catch (error) {
                    console.error('Error getting all labels:', error);
                    return null;
                }
            },

            // v29: Update a label (for edit sync ‚Äî prevents duplicates)
            updateLabel: async function(label) {
                if (!firebaseReady || !firebaseMigrated) return false;
                try {
                    const docId = `${label.rollNo}_${label.id}`;
                    await firebaseDb.collection('labels').doc(docId).set({
                        ...label,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    return true;
                } catch (error) {
                    console.error('Error updating label:', error);
                    return false;
                }
            },

            // v29: Delete a label
            deleteLabel: async function(rollNo, id) {
                if (!firebaseReady || !firebaseMigrated) return false;
                try {
                    const docId = `${rollNo}_${id}`;
                    await firebaseDb.collection('labels').doc(docId).delete();
                    return true;
                } catch (error) {
                    console.error('Error deleting label:', error);
                    return false;
                }
            },

            // ==================== SEQUENCES ====================
            
            // Get next sequence number (with transaction for atomic increment)
            getNextSequence: async function(system, type, month, year) {
                if (!firebaseReady || !firebaseMigrated) return null;
                try {
                    const seqKey = `${type}_sys${system}_${year}${month}`;
                    const seqRef = firebaseDb.collection('sequences').doc(seqKey);
                    
                    const newSerial = await firebaseDb.runTransaction(async (transaction) => {
                        const seqDoc = await transaction.get(seqRef);
                        let currentSerial = 0;
                        
                        if (seqDoc.exists) {
                            currentSerial = seqDoc.data().lastSerial || 0;
                        }
                        
                        const nextSerial = currentSerial + 1;
                        
                        transaction.set(seqRef, {
                            system: system,
                            type: type,
                            month: month,
                            year: year,
                            lastSerial: nextSerial,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                        
                        return nextSerial;
                    });
                    
                    return newSerial;
                } catch (error) {
                    console.error('Error getting sequence:', error);
                    return null;
                }
            },
            
            // Get current sequence (without incrementing)
            getCurrentSequence: async function(system, type, month, year) {
                if (!firebaseReady || !firebaseMigrated) return null;
                try {
                    const seqKey = `${type}_sys${system}_${year}${month}`;
                    const seqDoc = await firebaseDb.collection('sequences').doc(seqKey).get();
                    return seqDoc.exists ? seqDoc.data().lastSerial : 0;
                } catch (error) {
                    console.error('Error getting current sequence:', error);
                    return null;
                }
            },
            
            // Set sequence (for migration)
            setSequence: async function(system, type, month, year, value) {
                if (!firebaseReady) return false;
                try {
                    const seqKey = `${type}_sys${system}_${year}${month}`;
                    await firebaseDb.collection('sequences').doc(seqKey).set({
                        system: system,
                        type: type,
                        month: month,
                        year: year,
                        lastSerial: parseInt(value),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return true;
                } catch (error) {
                    console.error('Error setting sequence:', error);
                    return false;
                }
            },
            
            // ==================== SETTINGS ====================
            
            // Get setting
            getSetting: async function(key) {
                if (!firebaseReady || !firebaseMigrated) return null;
                try {
                    const doc = await firebaseDb.collection('settings').doc('app').get();
                    return doc.exists ? doc.data()[key] : null;
                } catch (error) {
                    console.error('Error getting setting:', error);
                    return null;
                }
            },
            
            // Set setting
            setSetting: async function(key, value) {
                if (!firebaseReady || !firebaseMigrated) return false;
                try {
                    await firebaseDb.collection('settings').doc('app').set({
                        [key]: value,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    return true;
                } catch (error) {
                    console.error('Error setting setting:', error);
                    return false;
                }
            },
            
            // ==================== LAYOUTS ====================
            
            // Get layout
            getLayout: async function(mode) {
                if (!firebaseReady || !firebaseMigrated) return null;
                try {
                    const doc = await firebaseDb.collection('layouts').doc(mode).get();
                    return doc.exists ? doc.data() : null;
                } catch (error) {
                    console.error('Error getting layout:', error);
                    return null;
                }
            },
            
            // Save layout
            saveLayout: async function(mode, data) {
                if (!firebaseReady || !firebaseMigrated) return false;
                try {
                    await firebaseDb.collection('layouts').doc(mode).set({
                        ...data,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return true;
                } catch (error) {
                    console.error('Error saving layout:', error);
                    return false;
                }
            },
            
            // ==================== ERROR LOG ====================
            
            // Add error log entry
            addErrorLog: async function(entry) {
                if (!firebaseReady || !firebaseMigrated) return false;
                try {
                    await firebaseDb.collection('errorLogs').add({
                        ...entry,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return true;
                } catch (error) {
                    console.error('Error adding error log:', error);
                    return false;
                }
            },
            
            // ==================== MIGRATION ====================
            
            // Migrate all data from localStorage to Firebase
            migrateFromLocalStorage: async function(progressCallback) {
                if (!firebaseReady) {
                    throw new Error('Firebase not ready');
                }
                
                const log = (msg) => {
                    console.log('üî• Migration:', msg);
                    if (progressCallback) progressCallback(msg);
                };
                
                try {
                    log('Starting migration...');
                    
                    // 1. Migrate Masters (Custom Data)
                    log('Migrating masters...');
                    const masterTypes = ['client', 'product', 'design', 'color'];
                    let masterCount = 0;
                    
                    for (const type of masterTypes) {
                        // Predefined masters
                        if (predefinedData[type]) {
                            for (const name of predefinedData[type]) {
                                await this.addMaster(type, name.toUpperCase(), 'predefined');
                                masterCount++;
                            }
                        }
                        
                        // Custom masters
                        const customSaved = localStorage.getItem(`snehaCustom_${type}`);
                        if (customSaved) {
                            try {
                                const customs = JSON.parse(customSaved);
                                for (const name of customs) {
                                    await this.addMaster(type, name.toUpperCase(), 'custom');
                                    masterCount++;
                                }
                            } catch (e) {
                                console.warn(`Migration: Could not add ${type} master:`, e.message);
                            }
                        }
                        
                        log(`  ${type}: done`);
                    }
                    log(`Masters migrated: ${masterCount}`);
                    
                    // 2. Migrate Inactive Masters
                    log('Migrating inactive status...');
                    const inactiveSaved = localStorage.getItem('snehaInactiveMasters');
                    if (inactiveSaved) {
                        try {
                            const inactive = JSON.parse(inactiveSaved);
                            for (const type in inactive) {
                                for (const name of inactive[type]) {
                                    await this.updateMasterStatus(type, name, 'inactive');
                                }
                            }
                        } catch (e) { }
                    }
                    
                    // 3. Migrate Deleted Masters
                    log('Migrating deleted status...');
                    const deletedSaved = localStorage.getItem('snehaDeletedMasters');
                    if (deletedSaved) {
                        try {
                            const deleted = JSON.parse(deletedSaved);
                            for (const type in deleted) {
                                for (const name of deleted[type]) {
                                    await this.updateMasterStatus(type, name, 'deleted');
                                }
                            }
                        } catch (e) {
                            console.warn('Migration: Could not update deleted masters status:', e.message);
                        }
                    }
                    
                    // 4. Migrate Print Log
                    log('Migrating print log...');
                    const printLogSaved = localStorage.getItem('snehaPrintLog');
                    let labelCount = 0;
                    if (printLogSaved) {
                        try {
                            const labels = JSON.parse(printLogSaved);
                            // Batch write for performance
                            const batchSize = 500;
                            for (let i = 0; i < labels.length; i += batchSize) {
                                const batch = firebaseDb.batch();
                                const chunk = labels.slice(i, i + batchSize);
                                
                                for (const label of chunk) {
                                    const docId = `${label.rollNo}_${label.id}`;
                                    const ref = firebaseDb.collection('labels').doc(docId);
                                    batch.set(ref, {
                                        ...label,
                                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                    labelCount++;
                                }
                                
                                await batch.commit();
                                log(`  Labels: ${Math.min(i + batchSize, labels.length)}/${labels.length}`);
                            }
                        } catch (e) {
                            log(`  Error: ${e.message}`);
                        }
                    }
                    log(`Labels migrated: ${labelCount}`);
                    
                    // 5. Migrate Sequences
                    log('Migrating sequences...');
                    let seqCount = 0;
                    const allKeys = Object.keys(localStorage);
                    for (const key of allKeys) {
                        if (key.startsWith('snehaRollSerial_') || key.startsWith('snehaRejectSerial_')) {
                            const value = localStorage.getItem(key);
                            // Parse key: snehaRollSerial_sys1_202601
                            const parts = key.replace('sneha', '').split('_');
                            const type = parts[0].replace('Serial', '').toLowerCase(); // roll or reject
                            const sys = parts[1].replace('sys', '');
                            const yearMonth = parts[2];
                            const year = yearMonth.substring(0, 4);
                            const month = yearMonth.substring(4, 6);
                            
                            await this.setSequence(sys, type, month, year, value);
                            seqCount++;
                        }
                    }
                    log(`Sequences migrated: ${seqCount}`);
                    
                    // 6. Migrate Layouts
                    log('Migrating layouts...');
                    const layoutWithHeader = localStorage.getItem('snehaLayout_withHeader_v3');
                    const layoutWithoutHeader = localStorage.getItem('snehaLayout_withoutHeader_v3');
                    const layoutMode = localStorage.getItem('snehaLayout_mode');
                    
                    if (layoutWithHeader) {
                        await this.saveLayout('withHeader', JSON.parse(layoutWithHeader));
                    }
                    if (layoutWithoutHeader) {
                        await this.saveLayout('withoutHeader', JSON.parse(layoutWithoutHeader));
                    }
                    log('Layouts migrated');
                    
                    // 7. Migrate Settings
                    log('Migrating settings...');
                    await firebaseDb.collection('settings').doc('app').set({
                        masterLockEnabled: localStorage.getItem('snehaMasterLock') === 'true',
                        lastSystem: localStorage.getItem('snehaLastSystem') || '1',
                        layoutMode: layoutMode || 'header',
                        backupSchedule: localStorage.getItem('snehaBackupSchedule') || 'daily',
                        migrated: true,
                        migratedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    log('Settings migrated');
                    
                    // Mark as migrated
                    firebaseMigrated = true;
                    this.updateSyncIndicator('online', 'Cloud Synced');
                    
                    log('‚úÖ Migration complete!');
                    return {
                        success: true,
                        masters: masterCount,
                        labels: labelCount,
                        sequences: seqCount
                    };
                    
                } catch (error) {
                    log(`‚ùå Migration failed: ${error.message}`);
                    throw error;
                }
            },
            
            // Get migration preview (counts)
            getMigrationPreview: function() {
                const preview = {
                    masters: { client: 0, product: 0, design: 0, color: 0 },
                    labels: 0,
                    sequences: 0
                };
                
                // Count predefined masters
                for (const type in predefinedData) {
                    preview.masters[type] += predefinedData[type].length;
                }
                
                // Count custom masters
                ['client', 'product', 'design', 'color'].forEach(type => {
                    const saved = localStorage.getItem(`snehaCustom_${type}`);
                    if (saved) {
                        try {
                            preview.masters[type] += JSON.parse(saved).length;
                        } catch (e) {
                            console.warn(`Preview: Invalid JSON for ${type} masters:`, e.message);
                        }
                    }
                });
                
                // Count labels
                const printLogSaved = localStorage.getItem('snehaPrintLog');
                if (printLogSaved) {
                    try {
                        preview.labels = JSON.parse(printLogSaved).length;
                    } catch (e) {
                        console.warn('Preview: Invalid JSON for print log:', e.message);
                    }
                }
                
                // Count sequences
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('snehaRollSerial_') || key.startsWith('snehaRejectSerial_')) {
                        preview.sequences++;
                    }
                });
                
                return preview;
            }
        };
        
        // Firebase Migration Modal Functions
        function openFirebaseMigration() {
            document.getElementById('firebaseMigrationModal').style.display = 'flex';
            document.getElementById('fbMigrationPreview').style.display = 'none';
            document.getElementById('fbMigrationProgress').style.display = 'none';
            document.getElementById('fbMigrationComplete').style.display = 'none';
            document.getElementById('fbPreviewBtn').disabled = false;
            document.getElementById('fbExecuteBtn').disabled = true;
            
            // Update status
            const statusText = document.getElementById('fbStatusText');
            if (!firebaseReady) {
                statusText.innerHTML = '‚ùå Firebase not connected. Check internet connection.';
            } else if (firebaseMigrated) {
                statusText.innerHTML = '‚úÖ Already migrated! Data is syncing with Firebase cloud.';
                document.getElementById('fbPreviewBtn').disabled = true;
            } else {
                statusText.innerHTML = 'üîÑ Ready to migrate. Click "Preview Data" to see what will be uploaded.';
            }
        }
        
        function closeFirebaseMigration() {
            document.getElementById('firebaseMigrationModal').style.display = 'none';
        }
        
        function previewFirebaseMigration() {
            const preview = SnehaFirebase.getMigrationPreview();
            
            const totalMasters = Object.values(preview.masters).reduce((a, b) => a + b, 0);
            
            const statsHtml = `
                <table style="width: 100%; font-size: 11px;">
                    <tr><td><b>üë• Clients:</b></td><td>${preview.masters.client}</td></tr>
                    <tr><td><b>üì¶ Products:</b></td><td>${preview.masters.product}</td></tr>
                    <tr><td><b>üé® Designs:</b></td><td>${preview.masters.design}</td></tr>
                    <tr><td><b>üåà Colors:</b></td><td>${preview.masters.color}</td></tr>
                    <tr><td colspan="2" style="border-top: 1px solid #ddd; padding-top: 5px;"></td></tr>
                    <tr><td><b>üìä Total Masters:</b></td><td>${totalMasters}</td></tr>
                    <tr><td><b>üè∑Ô∏è Labels (Print Log):</b></td><td>${preview.labels}</td></tr>
                    <tr><td><b>üî¢ Sequences:</b></td><td>${preview.sequences}</td></tr>
                </table>
            `;
            
            document.getElementById('fbMigrationStats').innerHTML = statsHtml;
            document.getElementById('fbMigrationPreview').style.display = 'block';
            document.getElementById('fbExecuteBtn').disabled = false;
        }
        
        async function executeFirebaseMigration() {
            if (!confirm('This will upload all your local data to Firebase cloud. Continue?')) {
                return;
            }
            
            document.getElementById('fbMigrationProgress').style.display = 'block';
            document.getElementById('fbPreviewBtn').disabled = true;
            document.getElementById('fbExecuteBtn').disabled = true;
            
            const logEl = document.getElementById('fbMigrationLog');
            const progressBar = document.getElementById('fbMigrationProgressBar');
            
            const log = (msg) => {
                logEl.innerHTML += msg + '<br>';
                logEl.scrollTop = logEl.scrollHeight;
            };
            
            try {
                // Simulate progress
                let progress = 0;
                const updateProgress = (p) => {
                    progress = p;
                    progressBar.style.width = p + '%';
                };
                
                updateProgress(5);
                
                const result = await SnehaFirebase.migrateFromLocalStorage((msg) => {
                    log(msg);
                    if (msg.includes('masters')) updateProgress(20);
                    if (msg.includes('inactive')) updateProgress(30);
                    if (msg.includes('deleted')) updateProgress(40);
                    if (msg.includes('Labels:')) {
                        const match = msg.match(/(\d+)\/(\d+)/);
                        if (match) {
                            const pct = 40 + (parseInt(match[1]) / parseInt(match[2])) * 40;
                            updateProgress(Math.min(80, pct));
                        }
                    }
                    if (msg.includes('Sequences')) updateProgress(85);
                    if (msg.includes('Layouts')) updateProgress(90);
                    if (msg.includes('Settings')) updateProgress(95);
                    if (msg.includes('complete')) updateProgress(100);
                });
                
                // Show completion
                document.getElementById('fbMigrationComplete').style.display = 'block';
                log(`‚úÖ Success! Migrated ${result.masters} masters, ${result.labels} labels, ${result.sequences} sequences.`);
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                document.getElementById('fbExecuteBtn').disabled = false;
            }
        }
        
        // ============================================================
        // END FIREBASE SERVICE
        // ============================================================

        let selectedElement = null;
        let selectedElements = []; // For multi-select
        let qzConnected = false;
        let selectedPrinter = null;
        let showHeader = true;
        let isDragging = false;
        let dragElement = null;
        let dragStartX, dragStartY, elemStartX, elemStartY;
        let multiDragStarts = {}; // Store starting positions for all selected elements
        let contentScale = 130;
        let contentScaleNoHeader = 130;
        let printLog = [];
        let editLocked = false; // Edit lock state
        
        // Separate layouts for with/without header
        let layoutWithHeader = { elements: {} };
        let layoutWithoutHeader = { elements: {} };

        // Predefined dropdown data (never modified)
        const predefinedData = {
            design: ["Caprinova", "Volvo", "Nappa", "Liberty", "SV-78", "D-6", "SV-88", "Hock", "Lara", "Breamer", "Perforation", "Navajo", "Innova", "Lotus", "Coventry", "Holes", "Big Nimbus", "Small Nimbus", "SV-98", "Big Punching", "Soave", "Siracco", "Cedro", "Leto", "Inka", "R-8", "Crumble", "German", "Simphony", "G-15", "Nimbus", "Silky", "Punching", "Royale", "Fine pin", "Waves", "Maruthi", "Button", "Small Diamond", "Football", "Glamour", "Sherwood", "Omega", "Slink", "Satin", "Prince", "Hitech", "Picasso", "Taiwan", "jeans", "Lama", "Siera", "Amber", "R-61", "R-64", "Altis", "Nepolian", "Sapphire", "Ceat", "Dolfin", "Fashion Plus", "New Maruthi", "Fiesta", "Flex"],
            color: ["Black", "White", "Red", "Maroon", "D.Brown", "Lt.Brown", "Brown", "Grey", "Lt.Grey", "Dk.Grey", "Ch.Grey", "Innova Grey", "Blue", "R.Blue", "Mustard", "Mushroom", "Royal Beige", "Tan", "Dark.Tan", "Butter Scotch", "Spl.Butter Scotch", "Lt Beige", "Off White", "Cream", "Silver", "Lt.Tan", "B.Tan", "Fawn", "Beige", "Camel", "Spl.Camel", "Navy Blue", "Innova Teeak", "N.Beige", "V-Mec", "Yellow", "Zinc Yellow", "Orange", "Parrot Green", "Green", "Dk Maroon", "Lt Maroon", "Chatney Green", "Dettol", "Dk Blue", "Lt.Blue", "Lilac Blue", "Oceanic Blue", "Purple", "Violet", "Innova Beige", "Honda Beige"],
            product: ["Trident Spl", "110 Century", "Spl. Breamer Top", "150 HPV", "150 HPV Hard", "85 10 P Top", "Spl. 90 Top HS", "90 7 P Top", "SPL 90 TOP HS P", "90 HPV", "180 HPV", "130 HPV Soft", "Spl.Satin Top", "SPl.Satin Top 100", "300 14 Poly", "130 HPV", "Eco Soft 180", "ECO Soft 200", "200 14 Poly", "BJ 1000 Omega CR", "BJ 1000 Navaja CR", "90 Soft PVD", "140 HSP", "180 8 PV Sahara", "Car Matt-300", "170 8 Pv", "W K F 90", "Nova Premium", "Amber-140", "R-64-90", "Nova Strong", "180 LKP Hard", "Amaravathi", "Privilage", "120 Poly", "170 HPV", "170 HPV Hard", "170 LKP Sahara", "160 8 PV", "120 HPV", "CENTURY ECO P", "NAPPA", "PRIYA SPL", "ECO 180", "NAPPA PV", "OMEGA PV", "NOVA 110", "NOVA 100", "NOVA 130", "120 CENTURY", "AMBER 130", "85 HPV", "100 CENTURY", "85 LKP", "90 LKP", "100 LKP", "110 LKP", "120 LKP", "85 POLY", "90 POLY", "100 POLY", "110 POLY", "120 POLY", "OMEGA PREMIUM", "98 PREMIUM", "CAPRINOVA", "CARMATT 160", "130 LKP", "80 HPV", "SNEHA IMPERIAL", "180 8 PV", "140 HPV", "NAPPA 200", "ECO 160", "CARMATT 150", "80 PV", "Polo", "Prince", "Hitech 80", "Century 100", "Crash", "Mercedes", "170 LKP Hard", "Eco Soft 200", "ORIGINS (85)", "80 Dyed Poly", "100 DYDE POLY", "180 8 PV HARD", "120 LKP HARD", "120 POLY HARD", "PRIVILAGE ECO", "ECO SOFT 200 METALIC", "ECO 180 METALIC"],
            client: [
                "A.V.Thomas Leather & Allied Products(P) Ltd",
                "Nutan Rexin House",
                "Cosmo Energy Design Studio",
                "Sri Santhosh Enterprises",
                "M.A.S.Industries",
                "Mercantile Corporation",
                "Keerthi Enterprises",
                "Setner",
                "Vijaya Sai Enterprises",
                "Arif Rexine",
                "Tharun Kumar Matss",
                "Car Interiors & Co",
                "Rexin Sea (India)",
                "Khimjee Hunsraj",
                "IRS Coated Fabrics",
                "Unity Fabtext Industries Private Ltd",
                "Trenz India Products",
                "Lakshmi Balaji Enterprises",
                "Vinyork Leather Works",
                "Lanka Vinyl Pvt Ltd",
                "Shri Saravanaa Coach & Builders",
                "Eyeball Agency",
                "Thirumalla Distributors",
                "Saipatham Enterprises",
                "Vishwa Leathers",
                "Success Leather Product",
                "Plasti Lami Coats Pvt Ltd",
                "Balaji Distributor"
            ]
        };
        
        // User-added custom data (loaded from localStorage)
        let customData = {
            design: [],
            color: [],
            product: [],
            client: []
        };
        
        // Combined dropdown data (predefined + custom)
        let dropdownData = {
            design: [],
            color: [],
            product: [],
            client: []
        };
        
        // Load custom data from localStorage
        function loadCustomData() {
            ['design', 'color', 'product', 'client'].forEach(type => {
                const saved = localStorage.getItem(`snehaCustom_${type}`);
                if (saved) {
                    try {
                        customData[type] = JSON.parse(saved);
                    } catch(e) {
                        console.warn(`Invalid JSON data for ${type}, using empty array:`, e.message);
                        customData[type] = [];
                    }
                }
            });
            updateDropdownData();
        }
        
        // Save custom data to localStorage
        function saveCustomData(type) {
            localStorage.setItem(`snehaCustom_${type}`, JSON.stringify(customData[type]));
            
            // üî• Sync to Firebase if migrated (v27)
            if (firebaseMigrated && firebaseReady) {
                customData[type].forEach(name => {
                    SnehaFirebase.addMaster(type, name, 'custom').catch(err => {
                        console.warn('Firebase sync error:', err);
                    });
                });
            }
        }
        
        // ============================================
        // üîß DATA SANITIZATION & ERROR LOGGING
        // ============================================
        
        // Error log storage
        let errorLog = [];
        
        function loadErrorLog() {
            const saved = localStorage.getItem('snehaErrorLog');
            errorLog = saved ? JSON.parse(saved) : [];
        }
        
        function saveErrorLog() {
            // Keep only last 500 entries
            if (errorLog.length > 500) {
                errorLog = errorLog.slice(-500);
            }
            localStorage.setItem('snehaErrorLog', JSON.stringify(errorLog));
        }
        
        /**
         * Log an error to the error log system
         * @param {string} module - Module name where error occurred
         * @param {string} action - Action being performed when error occurred
         * @param {string} message - Error message
         * @param {string} [severity='ERROR'] - Severity level: 'INFO', 'WARN', 'ERROR'
         * @param {string} [entityType=null] - Type of entity involved
         * @param {string} [entityId=null] - ID of entity involved
         * @returns {Object} The error log entry
         */
        function logError(module, action, message, severity = 'ERROR', entityType = null, entityId = null) {
            const entry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                module: module,
                action: action,
                message: message,
                severity: severity,
                entityType: entityType,
                entityId: entityId
            };
            errorLog.push(entry);
            saveErrorLog();
            console.error(`[${severity}] ${module}/${action}: ${message}`);
            return entry;
        }
        
        function logInfo(module, action, message, entityType = null) {
            return logError(module, action, message, 'INFO', entityType);
        }
        
        function logWarn(module, action, message, entityType = null) {
            return logError(module, action, message, 'WARN', entityType);
        }
        
        /**
         * Sanitize master data value - removes problematic characters
         * @param {string} value - Value to sanitize
         * @returns {string} Sanitized uppercase value
         * @example
         * sanitizeMasterValue("  Test's Value  ") // Returns "TESTS VALUE"
         */
        function sanitizeMasterValue(value) {
            if (!value) return '';
            let sanitized = value
                .trim()                              // Remove leading/trailing whitespace
                .replace(/[\\\/'"`]/g, '')           // Remove backslashes, quotes
                .replace(/[\x00-\x1F\x7F]/g, '')     // Remove control characters
                .replace(/\s+/g, ' ')                // Collapse multiple spaces
                .toUpperCase();                      // Force uppercase
            return sanitized;
        }
        
        // üîê ESCAPE FOR JAVASCRIPT - Safe strings for onclick handlers
        function escapeForJS(str) {
            if (!str) return '';
            return str
                .replace(/\\/g, '\\\\')   // Escape backslashes first
                .replace(/'/g, "\\'")      // Escape single quotes
                .replace(/"/g, '\\"')      // Escape double quotes
                .replace(/\n/g, '\\n')     // Escape newlines
                .replace(/\r/g, '\\r');    // Escape carriage returns
        }
        
        // üîê ESCAPE FOR HTML ATTRIBUTE
        function escapeForHTML(str) {
            if (!str) return '';
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
        
        // ============================================
        // ‚úÖ DATA VALIDATION UTILITIES
        // ============================================
        
        /**
         * @namespace SnehaValidation
         * @description Comprehensive data validation utilities
         */
        const SnehaValidation = {
            /**
             * Validate label data before printing
             * @param {Object} data - Label data object
             * @returns {{valid: boolean, errors: string[]}} Validation result
             */
            validateLabelData: function(data) {
                const errors = [];
                
                // Required fields check
                if (!data.client || data.client.trim() === '') {
                    errors.push('Client is required');
                }
                if (!data.product || data.product.trim() === '') {
                    errors.push('Product is required');
                }
                
                // Numeric fields validation
                if (data.meters !== undefined && data.meters !== '') {
                    const meters = parseFloat(data.meters);
                    if (isNaN(meters) || meters < 0) {
                        errors.push('Meters must be a positive number');
                    } else if (meters > SnehaConfig.validation.maxMeters) {
                        errors.push(`Meters cannot exceed ${SnehaConfig.validation.maxMeters}`);
                    }
                }
                
                if (data.weight !== undefined && data.weight !== '') {
                    const weight = parseFloat(data.weight);
                    if (isNaN(weight) || weight < 0) {
                        errors.push('Weight must be a positive number');
                    } else if (weight > SnehaConfig.validation.maxWeight) {
                        errors.push(`Weight cannot exceed ${SnehaConfig.validation.maxWeight}`);
                    }
                }
                
                // Grade validation
                if (data.grade && !SnehaConfig.gradeOptions.includes(data.grade)) {
                    errors.push(`Invalid grade. Must be one of: ${SnehaConfig.gradeOptions.join(', ')}`);
                }
                
                return {
                    valid: errors.length === 0,
                    errors: errors
                };
            },
            
            /**
             * Validate master data entry
             * @param {string} type - Master type (client, product, design, color)
             * @param {string} value - Value to validate
             * @returns {{valid: boolean, error: string|null, sanitized: string}} Validation result
             */
            validateMasterEntry: function(type, value) {
                if (!value || typeof value !== 'string') {
                    return { valid: false, error: 'Value is required', sanitized: '' };
                }
                
                const sanitized = sanitizeMasterValue(value);
                
                if (sanitized.length === 0) {
                    return { valid: false, error: 'Value is empty after sanitization', sanitized: '' };
                }
                
                if (sanitized.length > SnehaConfig.validation.maxMasterLength) {
                    return { 
                        valid: false, 
                        error: `Value exceeds maximum length of ${SnehaConfig.validation.maxMasterLength}`,
                        sanitized: sanitized 
                    };
                }
                
                if (!SnehaConfig.masterTypes.includes(type)) {
                    return { valid: false, error: 'Invalid master type', sanitized: sanitized };
                }
                
                return { valid: true, error: null, sanitized: sanitized };
            },
            
            /**
             * Validate roll number format
             * @param {string} rollNo - Roll number to validate
             * @returns {boolean} True if valid format
             */
            isValidRollNumber: function(rollNo) {
                if (!rollNo || typeof rollNo !== 'string') return false;
                return SnehaConfig.validation.rollNumberFormat.test(rollNo);
            },
            
            /**
             * Validate numeric input
             * @param {*} value - Value to check
             * @param {number} [min=0] - Minimum allowed value
             * @param {number} [max=Infinity] - Maximum allowed value
             * @returns {{valid: boolean, value: number|null, error: string|null}}
             */
            validateNumber: function(value, min = 0, max = Infinity) {
                if (value === '' || value === null || value === undefined) {
                    return { valid: true, value: null, error: null }; // Allow empty
                }
                
                const num = parseFloat(value);
                
                if (isNaN(num)) {
                    return { valid: false, value: null, error: 'Invalid number' };
                }
                
                if (num < min) {
                    return { valid: false, value: num, error: `Value must be at least ${min}` };
                }
                
                if (num > max) {
                    return { valid: false, value: num, error: `Value cannot exceed ${max}` };
                }
                
                return { valid: true, value: num, error: null };
            },
            
            /**
             * Validate and sanitize all label inputs before print
             * @returns {{valid: boolean, data: Object, errors: string[]}}
             */
            validateCurrentForm: function() {
                const data = {
                    client: document.getElementById('clientInput')?.value?.trim().toUpperCase() || '',
                    product: document.getElementById('productInput')?.value?.trim().toUpperCase() || '',
                    design: document.getElementById('designInput')?.value?.trim().toUpperCase() || '',
                    color: document.getElementById('colorInput')?.value?.trim().toUpperCase() || '',
                    grade: document.getElementById('gradeSelect')?.value || '',
                    meters: document.getElementById('metersInput')?.value || '',
                    weight: document.getElementById('weightInput')?.value || ''
                };
                
                return this.validateLabelData(data);
            }
        };
        
        // ============================================
        // üßπ CLEANUP & MAINTENANCE FUNCTIONS
        // ============================================
        
        // üßπ CLEANUP ALL MASTER DATA - Remove corrupted entries
        function cleanupMasterData() {
            let cleanedCount = 0;
            
            ['client', 'product', 'design', 'color'].forEach(type => {
                const original = customData[type] || [];
                const cleaned = [];
                
                original.forEach(value => {
                    const sanitized = sanitizeMasterValue(value);
                    if (sanitized && sanitized.length > 0) {
                        // Check for duplicates after sanitization
                        if (!cleaned.some(v => v === sanitized)) {
                            cleaned.push(sanitized);
                            if (sanitized !== value) {
                                cleanedCount++;
                                logInfo('Cleanup', 'Sanitize', `Cleaned "${value}" ‚Üí "${sanitized}"`, type);
                            }
                        } else {
                            cleanedCount++;
                            logInfo('Cleanup', 'RemoveDuplicate', `Removed duplicate after sanitize: "${value}"`, type);
                        }
                    } else {
                        cleanedCount++;
                        logWarn('Cleanup', 'RemoveEmpty', `Removed empty/invalid value: "${value}"`, type);
                    }
                });
                
                if (JSON.stringify(original) !== JSON.stringify(cleaned)) {
                    customData[type] = cleaned;
                    saveCustomData(type);
                }
            });
            
            if (cleanedCount > 0) {
                console.log(`üßπ Cleanup completed: ${cleanedCount} entries fixed/removed`);
            }
            
            return cleanedCount;
        }
        
        // üîß AUTO-RECONCILE: Ensure all printLog values have master entries
        // This runs on startup to fix missing masters after backup restore/migration
        function autoReconcileMasters() {
            let totalAdded = 0;
            
            ['client', 'product', 'design', 'color'].forEach(type => {
                // Get all unique values from printLog for this type
                const valuesInLog = new Set();
                printLog.forEach(item => {
                    const val = (item[type] || '').trim().toUpperCase();
                    if (val && val.length > 0) {
                        valuesInLog.add(val);
                    }
                });
                
                // Get all master values (predefined + custom)
                const deleted = deletedMasters[type] || [];
                const allMasters = new Set([
                    ...(predefinedData[type] || []).map(v => v.toUpperCase()),
                    ...(customData[type] || []).map(v => v.toUpperCase())
                ]);
                
                // Find values in printLog that have no master entry
                let addedForType = 0;
                valuesInLog.forEach(val => {
                    if (!allMasters.has(val) && !deleted.includes(val)) {
                        // Add to customData
                        if (!customData[type].some(c => c.toUpperCase() === val)) {
                            customData[type].push(val);
                            addedForType++;
                            totalAdded++;
                        }
                    }
                });
                
                if (addedForType > 0) {
                    saveCustomData(type);
                    logInfo('Reconcile', 'AutoAdd', `Auto-added ${addedForType} missing ${type} masters from labels`, type);
                    console.log(`üîß Auto-reconcile: Added ${addedForType} missing ${type} masters`);
                }
            });
            
            if (totalAdded > 0) {
                updateDropdownData();
                console.log(`üîß Auto-reconcile complete: Added ${totalAdded} total missing masters`);
            }
            
            return totalAdded;
        }
        
        // Combine predefined + custom data, filtering out deleted and inactive
        function updateDropdownData() {
            ['design', 'color', 'product', 'client'].forEach(type => {
                // Get deleted and inactive lists
                const deleted = (deletedMasters && deletedMasters[type]) || [];
                const inactive = (inactiveMasters && inactiveMasters[type]) || [];
                
                // Combine predefined + custom, remove duplicates, filter deleted/inactive
                const combined = [...predefinedData[type]];
                customData[type].forEach(item => {
                    if (!combined.some(p => p.toLowerCase() === item.toLowerCase())) {
                        combined.push(item);
                    }
                });
                
                // Filter out deleted and inactive, then sort
                dropdownData[type] = combined
                    .filter(v => !deleted.includes(v.toUpperCase()) && !inactive.includes(v.toUpperCase()))
                    .sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
            });
        }
        
        // Check if value exists in dropdown data (case-insensitive)
        function valueExistsInDropdown(type, value) {
            if (!value || !value.trim()) return true; // Empty values don't need saving
            return dropdownData[type].some(item => item.toLowerCase() === value.trim().toLowerCase());
        }
        
        // Add new value to custom data if not exists
        function addCustomValue(type, value) {
            if (!value || !value.trim()) return { added: false, blocked: false };
            const trimmedValue = value.trim().toUpperCase();
            
            // Check if already exists in predefined or custom
            if (predefinedData[type].some(item => item.toUpperCase() === trimmedValue)) {
                return { added: false, blocked: false }; // Already in predefined
            }
            if (customData[type].some(item => item.toUpperCase() === trimmedValue)) {
                return { added: false, blocked: false }; // Already in custom
            }
            
            // üîê MASTER LOCK CHECK - BLOCK NEW ENTRIES IF LOCK IS ON
            if (masterLockEnabled) {
                console.log('MASTER LOCK: Blocked new entry:', type, '=', trimmedValue);
                return { added: false, blocked: true, type: type, value: trimmedValue }; // Blocked by master lock
            }
            
            // Add to custom data (only if lock is OFF)
            customData[type].push(trimmedValue);
            saveCustomData(type);
            updateDropdownData();
            return { added: true, blocked: false };
        }
        
        // Check and save all new values from inputs
        // Returns: { newValues: [], blockedValues: [] }
        function checkAndSaveNewValues() {
            let newValuesAdded = [];
            let blockedValues = [];
            
            ['client', 'product', 'design', 'color'].forEach(type => {
                const input = document.getElementById(type + 'Input');
                if (input && input.value.trim()) {
                    const result = addCustomValue(type, input.value);
                    if (result.added) {
                        newValuesAdded.push(`${type}: "${input.value.trim()}"`);
                    } else if (result.blocked) {
                        blockedValues.push({ type: type, value: input.value.trim().toUpperCase() });
                    }
                }
            });
            
            return { newValues: newValuesAdded, blockedValues: blockedValues };
        }
        
        // üîê MASTER LOCK VALIDATION - Check if all field values exist in masters
        function validateFieldsAgainstMasterLock() {
            if (!masterLockEnabled) return { valid: true, invalidFields: [] };
            
            const invalidFields = [];
            const fieldsToCheck = [
                { id: 'clientInput', type: 'client', name: 'Client' },
                { id: 'productInput', type: 'product', name: 'Product' },
                { id: 'designInput', type: 'design', name: 'Design' },
                { id: 'colorInput', type: 'color', name: 'Color' }
            ];
            
            // Also check inactive masters
            const inactiveList = inactiveMasters || {};
            
            fieldsToCheck.forEach(field => {
                const input = document.getElementById(field.id);
                if (input && input.value.trim()) {
                    const value = input.value.trim().toUpperCase();
                    
                    // Get all valid values (predefined + custom, excluding inactive)
                    const inactive = inactiveList[field.type] || [];
                    const allValues = [
                        ...(predefinedData[field.type] || []),
                        ...(customData[field.type] || [])
                    ].map(v => v.toUpperCase())
                     .filter(v => !inactive.includes(v));
                    
                    if (!allValues.includes(value)) {
                        invalidFields.push({ type: field.type, name: field.name, value: value });
                    }
                }
            });
            
            return { valid: invalidFields.length === 0, invalidFields: invalidFields };
        }

        // ============ ROLL NUMBER AUTO-GENERATION ============
        // üî• CRITICAL FIX v27.2 - Firebase is the source of truth for sequences
        // Format: [System 1 digit][Month 2 digits][Serial 5 digits]
        // Example: 10100001 = System 1, January, Serial 00001
        
        function getCurrentMonth() {
            return String(new Date().getMonth() + 1).padStart(2, '0');
        }
        
        function getCurrentYear() {
            return new Date().getFullYear().toString();
        }
        
        function getStorageKey(systemNum) {
            const month = getCurrentMonth();
            const year = getCurrentYear();
            return `snehaRollSerial_sys${systemNum}_${year}${month}`;
        }
        
        /**
         * Get current sequence from localStorage (cache only - fallback)
         */
        function getLocalSerial(systemNum) {
            const key = getStorageKey(systemNum);
            return parseInt(localStorage.getItem(key)) || 0;
        }
        
        /**
         * Save serial to localStorage (cache)
         */
        function saveLocalSerial(systemNum, serial) {
            const key = getStorageKey(systemNum);
            localStorage.setItem(key, serial.toString());
        }
        
        /**
         * üî• FIREBASE-FIRST: Get the next serial number
         * Reads from Firebase if available, falls back to localStorage
         */
        async function getNextSerialFromFirebase(systemNum) {
            const month = getCurrentMonth();
            const year = getCurrentYear();
            
            // Try Firebase first (source of truth)
            if (firebaseMigrated && firebaseReady) {
                try {
                    const currentSerial = await SnehaFirebase.getCurrentSequence(systemNum, 'roll', month, year);
                    if (currentSerial !== null) {
                        // Update local cache
                        saveLocalSerial(systemNum, currentSerial);
                        return currentSerial + 1;
                    }
                } catch (error) {
                    console.warn('Firebase sequence read failed, using local:', error);
                }
            }
            
            // Fallback to localStorage
            return getLocalSerial(systemNum) + 1;
        }
        
        /**
         * üî• FIREBASE-FIRST: Atomically increment and save sequence
         * Uses Firebase transaction to prevent duplicates across devices
         */
        async function incrementAndSaveSerial(systemNum) {
            const month = getCurrentMonth();
            const year = getCurrentYear();
            
            // Try Firebase first (atomic increment)
            if (firebaseMigrated && firebaseReady) {
                try {
                    const newSerial = await SnehaFirebase.getNextSequence(systemNum, 'roll', month, year);
                    if (newSerial !== null) {
                        // Update local cache
                        saveLocalSerial(systemNum, newSerial);
                        console.log(`üî• Firebase sequence incremented: System ${systemNum} ‚Üí ${newSerial}`);
                        return newSerial;
                    }
                } catch (error) {
                    console.error('Firebase sequence increment failed:', error);
                    logError('Sequence', 'Increment', `Firebase increment failed: ${error.message}`, 'ERROR');
                }
            }
            
            // Fallback to localStorage
            const localSerial = getLocalSerial(systemNum) + 1;
            saveLocalSerial(systemNum, localSerial);
            console.log(`üì± Local sequence incremented: System ${systemNum} ‚Üí ${localSerial}`);
            return localSerial;
        }
        
        /**
         * Generate roll number - displays the NEXT available roll number
         * Format: [System][Month][5-digit Serial]
         * @param {boolean} autoIncrement - If true, increments AFTER displaying (used after print)
         */
        async function generateRollNumber(autoIncrement = false) {
            const systemNum = document.getElementById('systemSelect').value;
            const month = getCurrentMonth();
            
            // Save system preference
            localStorage.setItem('snehaLastSystem', systemNum);
            
            let serial;
            
            if (autoIncrement) {
                // After print: Atomically increment in Firebase
                serial = await incrementAndSaveSerial(systemNum);
            } else {
                // Display: Get next available from Firebase
                serial = await getNextSerialFromFirebase(systemNum);
            }
            
            // Format: [System][Month][5-digit Serial]
            const rollNo = systemNum + month + String(serial).padStart(5, '0');
            
            document.getElementById('rollNoInput').value = rollNo;
            window.lastAutoRollNo = rollNo;
            window.manualRollEntry = false;
            updateLabelText();

            return rollNo;
        }

        // v29: Manual roll number entry support
        window.manualRollEntry = false;
        window.lastAutoRollNo = '';

        function detectManualRollEntry() {
            const currentVal = document.getElementById('rollNoInput').value;
            if (currentVal !== window.lastAutoRollNo) {
                window.manualRollEntry = true;
            }
        }

        /**
         * Set sequence counter to a specific serial value (for manual roll entry).
         * Updates both localStorage and Firebase.
         */
        async function setSequenceToSerial(systemNum, serial, month) {
            const year = getCurrentYear();
            const key = `snehaRollSerial_sys${systemNum}_${year}${month}`;
            localStorage.setItem(key, serial.toString());

            if (firebaseMigrated && firebaseReady) {
                try {
                    await SnehaFirebase.setSequence(systemNum, 'roll', month, year, serial);
                    console.log(`Manual entry: Set sequence System ${systemNum} Month ${month} ‚Üí ${serial}`);
                } catch (err) {
                    console.warn('Could not push manual sequence to Firebase:', err);
                }
            }
        }

        /**
         * Increment roll number after printing
         */
        async function incrementRollNumber() {
            await generateRollNumber(true);
        }
        
        /**
         * üî• FIREBASE-FIRST: Initialize roll number on page load
         * Syncs from Firebase to ensure correct sequence
         */
        async function initRollNumber() {
            // Load saved system preference
            const savedSystem = localStorage.getItem('snehaLastSystem') || '1';
            document.getElementById('systemSelect').value = savedSystem;
            
            // Show loading state
            const rollInput = document.getElementById('rollNoInput');
            rollInput.value = 'Syncing...';
            rollInput.disabled = true;
            
            try {
                // Generate initial roll number (reads from Firebase)
                await generateRollNumber(false);
            } catch (error) {
                console.error('Error initializing roll number:', error);
                // Fallback: generate from local
                const serial = getLocalSerial(savedSystem) + 1;
                const month = getCurrentMonth();
                rollInput.value = savedSystem + month + String(serial).padStart(5, '0');
            }
            
            rollInput.disabled = false;
        }
        
        /**
         * üî• Sync sequence from Firebase to localStorage on startup
         * Called after Firebase is ready
         */
        async function syncSequenceFromFirebase() {
            if (!firebaseMigrated || !firebaseReady) return;
            
            console.log('üî• Syncing sequences from Firebase...');
            const month = getCurrentMonth();
            const year = getCurrentYear();
            
            // Sync both systems
            for (const sys of ['1', '2']) {
                try {
                    const firebaseSerial = await SnehaFirebase.getCurrentSequence(sys, 'roll', month, year);
                    const localSerial = getLocalSerial(sys);
                    
                    if (firebaseSerial !== null) {
                        // Firebase has data - use it if higher
                        if (firebaseSerial > localSerial) {
                            saveLocalSerial(sys, firebaseSerial);
                            console.log(`üî• Synced sequence for System ${sys}: local ${localSerial} ‚Üí firebase ${firebaseSerial}`);
                        } else if (localSerial > firebaseSerial) {
                            // Local is higher - push to Firebase
                            await SnehaFirebase.setSequence(sys, 'roll', month, year, localSerial);
                            console.log(`üì§ Pushed local sequence to Firebase for System ${sys}: ${localSerial}`);
                        }
                    } else if (localSerial > 0) {
                        // Firebase doesn't have data but local does - push to Firebase
                        await SnehaFirebase.setSequence(sys, 'roll', month, year, localSerial);
                        console.log(`üì§ Initialized Firebase sequence for System ${sys}: ${localSerial}`);
                    }
                } catch (error) {
                    console.warn(`Could not sync sequence for System ${sys}:`, error);
                }
            }
            
            // Regenerate current display
            await generateRollNumber(false);
        }

        /**
         * v29: Reconcile sequence counter against actual label data.
         * Scans printLog for the highest roll number per system for the current month.
         * If actual data is higher than the counter, updates the counter.
         * This prevents the "next number" from ever being lower than an existing label.
         */
        async function reconcileSequenceFromReports() {
            const month = getCurrentMonth();
            const year = getCurrentYear();
            const prefix = {}; // { '1': '102', '2': '202' }

            for (const sys of ['1', '2']) {
                prefix[sys] = sys + month; // e.g., '102' for System 1 Feb
            }

            // Scan all labels for highest serial per system in current month
            const highestSerial = { '1': 0, '2': 0 };

            printLog.forEach(item => {
                const rollNo = String(item.rollNo || '');
                // Valid format: [System 1][Month 2][Serial 5] = exactly 8 digits
                if (rollNo.length !== 8) return;

                for (const sys of ['1', '2']) {
                    if (rollNo.startsWith(prefix[sys])) {
                        const serialStr = rollNo.substring(prefix[sys].length);
                        if (serialStr.length !== 5) continue; // Must be exactly 5-digit serial
                        const serial = parseInt(serialStr, 10);
                        if (!isNaN(serial) && serial > 0 && serial <= 99999 && serial > highestSerial[sys]) {
                            highestSerial[sys] = serial;
                        }
                    }
                }
            });

            // SET counter to match report data (RULE 3: report data is the truth)
            for (const sys of ['1', '2']) {
                const localSerial = getLocalSerial(sys);

                if (highestSerial[sys] !== localSerial) {
                    saveLocalSerial(sys, highestSerial[sys]);
                    console.log(`üîß Reconciled sequence for System ${sys}: counter ${localSerial} ‚Üí report max ${highestSerial[sys]}`);

                    // Also push to Firebase
                    if (firebaseMigrated && firebaseReady) {
                        try {
                            await SnehaFirebase.setSequence(sys, 'roll', month, year, highestSerial[sys]);
                            console.log(`üîß Pushed reconciled sequence to Firebase for System ${sys}: ${highestSerial[sys]}`);
                        } catch (err) {
                            console.warn(`Could not push reconciled sequence for System ${sys}:`, err);
                        }
                    }
                } else {
                    console.log(`‚úÖ Sequence for System ${sys} OK: counter=${localSerial}, report max=${highestSerial[sys]}`);
                }
            }
        }
        // ============ END ROLL NUMBER ============

        // Elements that belong to header only (includes separate phone and email)
        const headerOnlyElements = ['el_logo', 'el_company', 'el_since', 'el_address', 'el_phone', 'el_email', 'el_separator'];
        
        // Field elements (shared between modes but with different positions)
        const fieldElements = [
            'el_product_label', 'el_product_colon', 'el_product_value',
            'el_design_label', 'el_design_colon', 'el_design_value',
            'el_color_label', 'el_color_colon', 'el_color_value',
            'el_grade_label', 'el_grade_colon', 'el_grade_value',
            'el_meters_label', 'el_meters_colon', 'el_meters_value',
            'el_weight_label', 'el_weight_colon', 'el_weight_value',
            'el_rollno_label', 'el_rollno_colon', 'el_rollno_value'
        ];

        // Get element properties
        function getElementProps(el) {
            return {
                left: el.style.left,
                top: el.style.top,
                fontSize: el.style.fontSize,
                fontWeight: el.style.fontWeight,
                fontFamily: el.style.fontFamily,
                height: el.style.height,
                width: el.style.width,
                text: (el.id.includes('_value') || el.id === 'el_separator') ? '' : (el.innerText || el.textContent || '')
            };
        }

        // Apply properties to element
        function applyElementProps(el, props) {
            if (!props) return;
            if (props.left) el.style.left = props.left;
            if (props.top) el.style.top = props.top;
            if (props.fontSize) el.style.fontSize = props.fontSize;
            if (props.fontWeight) el.style.fontWeight = props.fontWeight;
            if (props.fontFamily) el.style.fontFamily = props.fontFamily;
            if (props.height) el.style.height = props.height;
            
            // Logo size
            if (el.id === 'el_logo' && props.width) {
                el.style.width = props.width;
                el.style.height = props.width;
                // Image will auto-scale with parent div
            }
            
            // Text content (not for value fields, logo, or separator)
            if (props.text && !el.id.includes('_value') && !el.id.includes('logo') && el.id !== 'el_separator') {
                el.textContent = props.text;
            }
        }

        /**
         * Save current layout configuration to memory and localStorage
         * Handles both header and no-header modes separately
         * @fires layoutSaved - When layout is saved successfully
         */
        function saveCurrentLayoutToMemory() {
            const modeName = showHeader ? 'WITH HEADER' : 'WITHOUT HEADER';
            console.log('Saving layout for mode:', modeName);
            
            const layout = {
                scale: showHeader ? contentScale : contentScaleNoHeader,
                contactPhone: document.getElementById('contactPhone').value,
                contactEmail: document.getElementById('contactEmail').value,
                contactFontSize: document.getElementById('contactFontSize').value,
                elements: {}
            };
            
            if (showHeader) {
                // Save ALL elements for with-header mode
                document.querySelectorAll('.label-element').forEach(el => {
                    layout.elements[el.id] = getElementProps(el);
                });
                layoutWithHeader = layout;
                localStorage.setItem('snehaLayout_withHeader_v3', JSON.stringify(layout));
                console.log('Saved WITH HEADER layout:', Object.keys(layout.elements).length, 'elements');
                
                // üî• Sync to Firebase if migrated (v27)
                if (firebaseMigrated && firebaseReady) {
                    SnehaFirebase.saveLayout('withHeader', layout).catch(err => {
                        console.warn('Firebase layout sync error:', err);
                    });
                }
            } else {
                // Save ONLY field elements for without-header mode (they fill entire label)
                fieldElements.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        layout.elements[id] = getElementProps(el);
                    }
                });
                layoutWithoutHeader = layout;
                localStorage.setItem('snehaLayout_withoutHeader_v3', JSON.stringify(layout));
                console.log('Saved WITHOUT HEADER layout:', Object.keys(layout.elements).length, 'elements');
                
                // üî• Sync to Firebase if migrated (v27)
                if (firebaseMigrated && firebaseReady) {
                    SnehaFirebase.saveLayout('withoutHeader', layout).catch(err => {
                        console.warn('Firebase layout sync error:', err);
                    });
                }
            }
        }
        
        /**
         * Load and apply layout configuration for current mode
         * Restores element positions, sizes, and styles from saved layout
         */
        function loadLayoutForCurrentMode() {
            const layout = showHeader ? layoutWithHeader : layoutWithoutHeader;
            const modeName = showHeader ? 'WITH HEADER' : 'WITHOUT HEADER';
            console.log('Loading layout for mode:', modeName);
            
            const hasElements = layout && layout.elements && Object.keys(layout.elements).length > 0;
            
            if (!hasElements) {
                console.log('No saved ' + modeName + ' layout found');
                if (!showHeader) {
                    // For without-header mode, set default positions to fill the label
                    setDefaultNoHeaderLayout();
                }
                return;
            }
            
            // Apply element properties from saved layout
            if (showHeader) {
                // For with-header mode, apply ALL saved elements
                Object.keys(layout.elements).forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        applyElementProps(el, layout.elements[id]);
                    }
                });
            } else {
                // For without-header mode, apply ONLY field elements
                fieldElements.forEach(id => {
                    if (layout.elements[id]) {
                        const el = document.getElementById(id);
                        if (el) {
                            applyElementProps(el, layout.elements[id]);
                        }
                    }
                });
            }
            console.log('Applied layout positions');
            
            // Apply scale
            if (layout.scale) {
                if (showHeader) {
                    contentScale = layout.scale;
                } else {
                    contentScaleNoHeader = layout.scale;
                }
            }
            const currentScale = showHeader ? contentScale : contentScaleNoHeader;
            document.getElementById('scaleSlider').value = currentScale;
            document.getElementById('scaleValue').textContent = currentScale + '%';
            document.getElementById('labelCanvas').style.transform = `scale(${currentScale / 100})`;
            
            // Restore contact bar settings (only for with-header mode)
            if (showHeader && layout) {
                const phoneEl = document.getElementById('el_phone');
                const emailEl = document.getElementById('el_email');
                
                if (layout.contactPhone && phoneEl) {
                    document.getElementById('contactPhone').value = layout.contactPhone;
                    phoneEl.textContent = layout.contactPhone;
                }
                if (layout.contactEmail && emailEl) {
                    document.getElementById('contactEmail').value = layout.contactEmail;
                    emailEl.textContent = layout.contactEmail;
                }
                if (layout.contactFontSize) {
                    document.getElementById('contactFontSize').value = layout.contactFontSize;
                    if (phoneEl) phoneEl.style.fontSize = layout.contactFontSize + 'px';
                    if (emailEl) emailEl.style.fontSize = layout.contactFontSize + 'px';
                }
            }
        }

        // For backward compatibility with toggleHeader visibility
        const headerElements = ['el_logo', 'el_company', 'el_since', 'el_address', 'el_phone', 'el_email', 'el_separator'];

        document.addEventListener('DOMContentLoaded', async () => {
            // ============================================================
            // üöÄ APPLICATION STARTUP - v27.1
            // ============================================================
            console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë     SNEHA VINYL LABEL PRINTER                                 ‚ïë
‚ïë     Version: ${SnehaConfig.VERSION}                                          ‚ïë
‚ïë     Build: ${SnehaConfig.BUILD_DATE}                                       ‚ïë
‚ïë     ¬© Sneha Vinyl Products PVT LTD - Since 1984               ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            `);
            
            // üì¶ Load local data FIRST (before Firebase sync)
            loadErrorLog(); // Load error log first
            loadCustomData(); // Load custom values first
            loadInactiveMasters(); // Load inactive masters
            loadDeletedMasters(); // Load permanently deleted masters
            loadPrintLog(); // Load print log BEFORE Firebase sync so merge works correctly
            // v28: One-time cleanup of auto-backup localStorage entries (storage bomb fix)
            if (!localStorage.getItem('snehaAutoBackupCleanedV28')) {
                cleanupOldAutoBackups(0); // Remove ALL auto-backups from localStorage
                localStorage.removeItem('snehaLastAutoBackupDate');
                localStorage.removeItem('snehaAutoBackupEnabled');
                localStorage.removeItem('snehaBackupLogs');
                localStorage.setItem('snehaAutoBackupCleanedV28', '1');
                console.log('v28: Cleaned up auto-backup localStorage entries');
            }

            // üî• Initialize Firebase (v27) - after local data is loaded
            try {
                await SnehaFirebase.init();
                console.log('üî• Firebase initialization complete');

                // üî• CRITICAL: Sync sequences from Firebase BEFORE displaying roll number
                if (firebaseMigrated && firebaseReady) {
                    await syncSequenceFromFirebase();
                    console.log('üî• Sequences synced from Firebase');

                    // Also sync print log from Firebase (printLog already loaded from localStorage)
                    await syncPrintLogFromFirebase();

                    // v29: Auto Cloud Push if pending (after backup restore)
                    if (localStorage.getItem('snehaPendingCloudPush') === '1') {
                        localStorage.removeItem('snehaPendingCloudPush');
                        console.log('üî• Pending Cloud Push detected ‚Äî pushing restored data to Firebase...');
                        pushLocalToFirebase().then(() => {
                            console.log('üî• Cloud Push after backup restore complete');
                        }).catch(err => {
                            console.warn('Cloud Push after restore failed:', err);
                        });
                    }
                }
            } catch (error) {
                console.warn('Firebase init failed, using localStorage:', error);
            }

            // v29: ALWAYS reconcile sequence from report data (works offline and online)
            await reconcileSequenceFromReports();
            await generateRollNumber(false);
            console.log('üîß Sequence reconciled with report data');

            // üßπ Run data cleanup on startup
            const cleaned = cleanupMasterData();
            if (cleaned > 0) {
                console.log(`üßπ Auto-cleaned ${cleaned} corrupted master entries`);
            }
            
            initDraggable();
            initDropdowns();
            updateDropdownData(); // Refresh dropdown data after loading deleted/inactive
            loadLayout();

            // üîß Auto-reconcile: Ensure all printLog values have master entries
            autoReconcileMasters();
            
            updateLogDisplay();
            await initRollNumber(); // Initialize auto roll number (now async)
            
            // Set default report date
            document.getElementById('reportDate').valueAsDate = new Date();
            
            // Log successful startup
            logInfo('App', 'Startup', `Application v${SnehaConfig.VERSION} initialized successfully`);
            
            // Add blur event to auto-save new values and UPPERCASE enforcement
            // üîê MASTER LOCK: Auto-save is now checked inside addCustomValue
            ['client', 'product', 'design', 'color'].forEach(type => {
                const input = document.getElementById(type + 'Input');
                if (input) {
                    input.addEventListener('blur', () => {
                        // Force UPPERCASE
                        input.value = input.value.toUpperCase();
                        // MASTER LOCK check is inside addCustomValue
                        const result = addCustomValue(type, input.value);
                        if (result.added) {
                            console.log(`New ${type} saved: ${input.value.trim()}`);
                            refreshDropdown(type);
                        } else if (result.blocked) {
                            console.log(`MASTER LOCK: Blocked new ${type}: ${input.value.trim()}`);
                            // Don't show alert on blur, only on print attempt
                        }
                    });
                    // Also enforce on input
                    input.addEventListener('input', () => {
                        const cursorPos = input.selectionStart;
                        input.value = input.value.toUpperCase();
                        input.setSelectionRange(cursorPos, cursorPos);
                    });
                }
            });
            
            // UPPERCASE enforcement for grade input
            const gradeInput = document.getElementById('gradeInput');
            if (gradeInput) {
                gradeInput.addEventListener('change', () => {
                    gradeInput.value = gradeInput.value.toUpperCase();
                    updateLabelText();
                });
            }
            
            // Keyboard shortcuts for multi-select
            document.addEventListener('keydown', (e) => {
                // Only handle shortcuts when not typing in an input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'a' || e.key === 'A') {
                        e.preventDefault();
                        selectAll();
                    }
                }
                if (e.key === 'Escape') {
                    clearAllSelections();
                }
                // Arrow keys to move selected elements
                if (!editLocked && selectedElements.length > 0 && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                    e.preventDefault();
                    const step = e.shiftKey ? 10 : 1;
                    selectedElements.forEach(el => {
                        let x = parseInt(el.style.left) || 0;
                        let y = parseInt(el.style.top) || 0;
                        if (e.key === 'ArrowUp') y = Math.max(0, y - step);
                        if (e.key === 'ArrowDown') y = Math.min(280, y + step);
                        if (e.key === 'ArrowLeft') x = Math.max(0, x - step);
                        if (e.key === 'ArrowRight') x = Math.min(280, x + step);
                        el.style.left = x + 'px';
                        el.style.top = y + 'px';
                    });
                    updatePropsPanel();
                    autoSaveLayout();
                }
            });
            
            // Load backup schedule and check for reminder
            loadBackupSchedule();
            checkBackupReminder();
            
            // v28: Show cloud sync status (auto-backup to localStorage removed)
            setTimeout(() => {
                checkAutoBackup();
            }, 1000); // Delay to let app fully load
            
            // Load edit lock state
            loadEditLockState();
            
            // Load master lock state
            loadMasterLockState();
            
            // Load inactive masters
            loadInactiveMasters();
        });

        // Tab switching
        function switchTab(tab) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Find and activate the clicked tab
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => {
                if (t.getAttribute('onclick') === `switchTab('${tab}')`) {
                    t.classList.add('active');
                }
            });
            
            // Activate the content
            const content = document.getElementById(`tab-${tab}`);
            if (content) {
                content.classList.add('active');
            }
        }

        // Scale control
        function updateScale() {
            const newScale = parseInt(document.getElementById('scaleSlider').value);
            document.getElementById('scaleValue').textContent = newScale + '%';
            document.getElementById('labelCanvas').style.transform = `scale(${newScale / 100})`;
            
            // Save to the appropriate mode
            if (showHeader) {
                contentScale = newScale;
            } else {
                contentScaleNoHeader = newScale;
            }
            
            autoSaveLayout();
        }

        // Dragging
        function initDraggable() {
            document.querySelectorAll('.label-element').forEach(el => {
                el.addEventListener('mousedown', startDrag);
            });
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            
            // Click on canvas background to deselect all
            document.getElementById('labelCanvas').addEventListener('mousedown', (e) => {
                if (e.target.id === 'labelCanvas') {
                    clearAllSelections();
                }
            });
        }

        function startDrag(e) {
            // Prevent dragging if edit is locked
            if (editLocked) {
                return;
            }
            
            e.preventDefault();
            e.stopPropagation();
            isDragging = true;
            dragElement = e.target.closest('.label-element');
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            
            // Handle Ctrl+Click for multi-select
            if (e.ctrlKey || e.metaKey) {
                toggleElementSelection(dragElement);
            } else {
                // If clicking on an already selected element in a multi-selection, keep the selection
                if (!selectedElements.includes(dragElement)) {
                    clearAllSelections();
                    addToSelection(dragElement);
                }
            }
            
            // Store starting positions for all selected elements
            multiDragStarts = {};
            selectedElements.forEach(el => {
                multiDragStarts[el.id] = {
                    x: parseInt(el.style.left) || 0,
                    y: parseInt(el.style.top) || 0
                };
            });
            
            elemStartX = parseInt(dragElement.style.left) || 0;
            elemStartY = parseInt(dragElement.style.top) || 0;
            
            updatePropsPanel();
        }

        function drag(e) {
            if (!isDragging || !dragElement) return;
            const scale = (showHeader ? contentScale : contentScaleNoHeader) / 100;
            const dx = (e.clientX - dragStartX) / scale;
            const dy = (e.clientY - dragStartY) / scale;
            
            // Move all selected elements
            selectedElements.forEach(el => {
                const startPos = multiDragStarts[el.id];
                if (startPos) {
                    let newX = Math.max(0, Math.min(startPos.x + dx, 280));
                    let newY = Math.max(0, Math.min(startPos.y + dy, 280));
                    el.style.left = newX + 'px';
                    el.style.top = newY + 'px';
                }
            });
            
            // Update props panel for primary element
            if (selectedElement) {
                document.getElementById('propX').value = Math.round(parseInt(selectedElement.style.left) || 0);
                document.getElementById('propY').value = Math.round(parseInt(selectedElement.style.top) || 0);
            }
        }

        function stopDrag() {
            if (isDragging) autoSaveLayout();
            isDragging = false;
            dragElement = null;
        }
        
        function clearAllSelections() {
            document.querySelectorAll('.label-element').forEach(e => {
                e.classList.remove('selected', 'multi-selected', 'primary');
            });
            selectedElements = [];
            selectedElement = null;
            document.getElementById('elementProps').style.display = 'none';
            document.getElementById('noSelection').style.display = 'block';
        }
        
        function addToSelection(el) {
            if (!selectedElements.includes(el)) {
                selectedElements.push(el);
            }
            selectedElement = el; // Primary element for props panel
            updateSelectionVisuals();
            updatePropsPanel();
        }
        
        function removeFromSelection(el) {
            const idx = selectedElements.indexOf(el);
            if (idx > -1) {
                selectedElements.splice(idx, 1);
            }
            if (selectedElement === el) {
                selectedElement = selectedElements.length > 0 ? selectedElements[selectedElements.length - 1] : null;
            }
            updateSelectionVisuals();
            updatePropsPanel();
        }
        
        function toggleElementSelection(el) {
            if (selectedElements.includes(el)) {
                removeFromSelection(el);
            } else {
                addToSelection(el);
            }
        }
        
        function updateSelectionVisuals() {
            document.querySelectorAll('.label-element').forEach(e => {
                e.classList.remove('selected', 'multi-selected', 'primary');
            });
            
            if (selectedElements.length === 1) {
                selectedElements[0].classList.add('selected');
            } else if (selectedElements.length > 1) {
                selectedElements.forEach(el => {
                    el.classList.add('multi-selected');
                });
                if (selectedElement) {
                    selectedElement.classList.add('primary');
                }
            }
        }
        
        function updatePropsPanel() {
            if (selectedElements.length === 0) {
                document.getElementById('elementProps').style.display = 'none';
                document.getElementById('noSelection').style.display = 'block';
                return;
            }
            
            document.getElementById('elementProps').style.display = 'block';
            document.getElementById('noSelection').style.display = 'none';
            
            if (selectedElements.length > 1) {
                document.getElementById('selectedName').textContent = `${selectedElements.length} ELEMENTS SELECTED`;
                document.getElementById('textEditGroup').style.display = 'none';
                document.getElementById('fontSizeGroup').style.display = 'block';
                document.getElementById('fontWeightGroup').style.display = 'block';
                document.getElementById('fontFamilyGroup').style.display = 'none';
                document.getElementById('lineHeightGroup').style.display = 'none';
                document.getElementById('logoSizeGroup').style.display = 'none';
                
                // Show average position
                let avgX = 0, avgY = 0;
                selectedElements.forEach(el => {
                    avgX += parseInt(el.style.left) || 0;
                    avgY += parseInt(el.style.top) || 0;
                });
                document.getElementById('propX').value = Math.round(avgX / selectedElements.length);
                document.getElementById('propY').value = Math.round(avgY / selectedElements.length);
            } else if (selectedElement) {
                showSingleElementProps(selectedElement);
            }
        }
        
        function showSingleElementProps(el) {
            const elId = el.id;
            document.getElementById('selectedName').textContent = elId.replace('el_', '').replace(/_/g, ' ').toUpperCase();
            document.getElementById('propX').value = parseInt(el.style.left) || 0;
            document.getElementById('propY').value = parseInt(el.style.top) || 0;
            document.getElementById('propFontSize').value = parseInt(el.style.fontSize) || 15;
            document.getElementById('propFontWeight').value = el.style.fontWeight || '700';
            document.getElementById('propFontFamily').value = el.style.fontFamily || 'Arial, sans-serif';
            
            const textContent = el.innerText || el.textContent || '';
            document.getElementById('propText').value = textContent;
            
            const isLine = elId === 'el_separator';
            const isValueField = elId.includes('_value');
            const isLogo = elId === 'el_logo';
            const isPhoneOrEmail = elId === 'el_phone' || elId === 'el_email';
            
            // Phone and email are editable, but also update via Contact Bar panel
            document.getElementById('textEditGroup').style.display = (isValueField || isLogo) ? 'none' : 'block';
            document.getElementById('fontSizeGroup').style.display = (isLine || isLogo) ? 'none' : 'block';
            document.getElementById('fontWeightGroup').style.display = (isLine || isLogo) ? 'none' : 'block';
            document.getElementById('fontFamilyGroup').style.display = (isLine || isLogo) ? 'none' : 'block';
            document.getElementById('lineHeightGroup').style.display = isLine ? 'block' : 'none';
            document.getElementById('logoSizeGroup').style.display = isLogo ? 'block' : 'none';
            
            if (isLine) {
                document.getElementById('propLineHeight').value = parseInt(el.style.height) || 2;
            }
            if (isLogo) {
                document.getElementById('propLogoSize').value = parseInt(el.style.width) || 50;
            }
        }
        
        // Quick select functions
        function selectAllHeader() {
            clearAllSelections();
            headerElements.forEach(id => {
                const el = document.getElementById(id);
                if (el && el.style.display !== 'none') {
                    addToSelection(el);
                }
            });
        }
        
        function selectAllFields() {
            clearAllSelections();
            document.querySelectorAll('.label-element').forEach(el => {
                if (!headerElements.includes(el.id) && el.style.display !== 'none') {
                    addToSelection(el);
                }
            });
        }
        
        function selectAll() {
            clearAllSelections();
            document.querySelectorAll('.label-element').forEach(el => {
                if (el.style.display !== 'none') {
                    addToSelection(el);
                }
            });
        }

        function updateElementText() {
            if (selectedElement && selectedElement.id !== 'el_separator') {
                const newText = document.getElementById('propText').value;
                // Don't update value fields (those come from form inputs)
                if (!selectedElement.id.includes('_value')) {
                    selectedElement.textContent = newText;
                    autoSaveLayout();
                }
            }
        }

        function updateLineThickness() {
            if (selectedElement && selectedElement.id === 'el_separator') {
                const thickness = document.getElementById('propLineHeight').value + 'px';
                selectedElement.style.height = thickness;
                autoSaveLayout();
            }
        }

        function updateLogoSize() {
            if (selectedElement && selectedElement.id === 'el_logo') {
                const size = document.getElementById('propLogoSize').value;
                selectedElement.style.width = size + 'px';
                selectedElement.style.height = size + 'px';
                // Image auto-scales with parent div
                autoSaveLayout();
            }
        }

        function updateContactBar() {
            const phone = document.getElementById('contactPhone').value;
            const email = document.getElementById('contactEmail').value;
            const fontSize = document.getElementById('contactFontSize').value + 'px';
            
            // Update separate phone and email elements
            const phoneEl = document.getElementById('el_phone');
            const emailEl = document.getElementById('el_email');
            
            if (phoneEl) {
                phoneEl.textContent = phone;
                phoneEl.style.fontSize = fontSize;
            }
            if (emailEl) {
                emailEl.textContent = email;
                emailEl.style.fontSize = fontSize;
            }
            
            autoSaveLayout();
        }

        function updateElementPosition() {
            if (selectedElements.length > 1) {
                // For multi-select, calculate the offset from current average
                let avgX = 0, avgY = 0;
                selectedElements.forEach(el => {
                    avgX += parseInt(el.style.left) || 0;
                    avgY += parseInt(el.style.top) || 0;
                });
                avgX = avgX / selectedElements.length;
                avgY = avgY / selectedElements.length;
                
                const newAvgX = parseInt(document.getElementById('propX').value) || 0;
                const newAvgY = parseInt(document.getElementById('propY').value) || 0;
                const dx = newAvgX - avgX;
                const dy = newAvgY - avgY;
                
                selectedElements.forEach(el => {
                    const currX = parseInt(el.style.left) || 0;
                    const currY = parseInt(el.style.top) || 0;
                    el.style.left = Math.max(0, Math.min(currX + dx, 280)) + 'px';
                    el.style.top = Math.max(0, Math.min(currY + dy, 280)) + 'px';
                });
                autoSaveLayout();
            } else if (selectedElement) {
                selectedElement.style.left = document.getElementById('propX').value + 'px';
                selectedElement.style.top = document.getElementById('propY').value + 'px';
                autoSaveLayout();
            }
        }

        function updateElementStyle() {
            if (selectedElements.length > 1) {
                // Apply to all selected elements
                const fontSize = document.getElementById('propFontSize').value + 'px';
                const fontWeight = document.getElementById('propFontWeight').value;
                selectedElements.forEach(el => {
                    if (el.id !== 'el_separator' && el.id !== 'el_logo') {
                        el.style.fontSize = fontSize;
                        el.style.fontWeight = fontWeight;
                    }
                });
                autoSaveLayout();
            } else if (selectedElement) {
                selectedElement.style.fontSize = document.getElementById('propFontSize').value + 'px';
                selectedElement.style.fontWeight = document.getElementById('propFontWeight').value;
                selectedElement.style.fontFamily = document.getElementById('propFontFamily').value;
                autoSaveLayout();
            }
        }

        /**
         * Toggle sidebar section expanded/collapsed state
         * @param {string} sectionId - ID of the section element
         */
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.toggle('expanded');
            }
        }

        function toggleHeader() {
            // IMPORTANT: Save current layout BEFORE switching modes
            saveCurrentLayoutToMemory();
            
            const toggle = document.getElementById('headerToggle');
            showHeader = !showHeader;
            toggle.classList.toggle('active', showHeader);
            
            // Update mode indicator
            updateModeIndicator();
            
            // Show/hide header elements
            headerElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = showHeader ? '' : 'none';
            });
            
            // Load the OTHER mode's layout (this restores positions for that mode)
            loadLayoutForCurrentMode();
            
            // Update scale slider to match current mode
            const currentScale = showHeader ? contentScale : contentScaleNoHeader;
            document.getElementById('scaleSlider').value = currentScale;
            document.getElementById('scaleValue').textContent = currentScale + '%';
            document.getElementById('labelCanvas').style.transform = `scale(${currentScale / 100})`;
            
            // Save the current mode preference
            localStorage.setItem('snehaLayout_mode', showHeader ? 'header' : 'noheader');
        }
        
        function setDefaultNoHeaderLayout() {
            // Default positions for fields when there's no header (fills entire 3"x3" label)
            const defaultPositions = {
                'el_product_label': { left: '10px', top: '15px', fontSize: '20px', fontWeight: '900' },
                'el_product_colon': { left: '110px', top: '15px', fontSize: '20px', fontWeight: '900' },
                'el_product_value': { left: '125px', top: '15px', fontSize: '20px', fontWeight: '700' },
                
                'el_design_label': { left: '10px', top: '55px', fontSize: '20px', fontWeight: '900' },
                'el_design_colon': { left: '110px', top: '55px', fontSize: '20px', fontWeight: '900' },
                'el_design_value': { left: '125px', top: '55px', fontSize: '20px', fontWeight: '700' },
                
                'el_color_label': { left: '10px', top: '95px', fontSize: '20px', fontWeight: '900' },
                'el_color_colon': { left: '110px', top: '95px', fontSize: '20px', fontWeight: '900' },
                'el_color_value': { left: '125px', top: '95px', fontSize: '20px', fontWeight: '700' },
                
                'el_grade_label': { left: '10px', top: '135px', fontSize: '20px', fontWeight: '900' },
                'el_grade_colon': { left: '110px', top: '135px', fontSize: '20px', fontWeight: '900' },
                'el_grade_value': { left: '125px', top: '135px', fontSize: '20px', fontWeight: '700' },
                
                'el_meters_label': { left: '10px', top: '175px', fontSize: '20px', fontWeight: '900' },
                'el_meters_colon': { left: '110px', top: '175px', fontSize: '20px', fontWeight: '900' },
                'el_meters_value': { left: '125px', top: '175px', fontSize: '20px', fontWeight: '700' },
                
                'el_weight_label': { left: '10px', top: '215px', fontSize: '20px', fontWeight: '900' },
                'el_weight_colon': { left: '110px', top: '215px', fontSize: '20px', fontWeight: '900' },
                'el_weight_value': { left: '125px', top: '215px', fontSize: '20px', fontWeight: '700' },
                
                'el_rollno_label': { left: '10px', top: '255px', fontSize: '20px', fontWeight: '900' },
                'el_rollno_colon': { left: '110px', top: '255px', fontSize: '20px', fontWeight: '900' },
                'el_rollno_value': { left: '125px', top: '255px', fontSize: '20px', fontWeight: '700' }
            };
            
            Object.entries(defaultPositions).forEach(([id, pos]) => {
                const el = document.getElementById(id);
                if (el) {
                    el.style.left = pos.left;
                    el.style.top = pos.top;
                    if (pos.fontSize) el.style.fontSize = pos.fontSize;
                    if (pos.fontWeight) el.style.fontWeight = pos.fontWeight;
                }
            });
        }

        function updateLabelText() {
            // Get values and convert to UPPERCASE
            const product = (document.getElementById('productInput').value || '').toUpperCase();
            const design = (document.getElementById('designInput').value || '').toUpperCase();
            const color = (document.getElementById('colorInput').value || '').toUpperCase();
            const grade = (document.getElementById('gradeInput').value || '').toUpperCase();
            const meters = document.getElementById('metersInput').value;
            const bits = document.getElementById('bitsInput').value;
            const weight = document.getElementById('weightInput').value;
            const rollNo = document.getElementById('rollNoInput').value;
            
            // Update input fields with UPPERCASE (for text fields)
            document.getElementById('productInput').value = product;
            document.getElementById('designInput').value = design;
            document.getElementById('colorInput').value = color;
            document.getElementById('gradeInput').value = grade;
            
            // Update label elements
            document.getElementById('el_product_value').textContent = product;
            document.getElementById('el_design_value').textContent = design;
            document.getElementById('el_color_value').textContent = color;
            document.getElementById('el_grade_value').textContent = grade;
            document.getElementById('el_meters_value').textContent = meters;
            document.getElementById('el_rollno_value').textContent = rollNo;
            
            // Handle BITS display - show as "(15+ 5)" inline with meters
            const bitsEl = document.getElementById('el_bits_value');
            if (bitsEl) {
                if (bits && bits.trim()) {
                    // Format bits like "(15+ 5)" inline next to meters
                    const formattedBits = '(' + bits.replace(/\s*\+\s*/g, '+ ').trim() + ')';
                    bitsEl.textContent = formattedBits;
                    bitsEl.style.display = '';
                } else {
                    bitsEl.textContent = '';
                    bitsEl.style.display = 'none';
                }
            }
            
            // Handle WEIGHT display - ALWAYS show (even if empty)
            const weightEl = document.getElementById('el_weight_value');
            if (weightEl) {
                if (weight && parseFloat(weight) > 0) {
                    weightEl.textContent = weight + ' KG';
                } else {
                    weightEl.textContent = ''; // Empty but line still visible
                }
            }
        }
        
        function toggleBitsField() {
            const meters = document.getElementById('metersInput').value;
            const bitsGroup = document.getElementById('bitsGroup');
            if (meters && parseFloat(meters) > 0) {
                bitsGroup.style.display = '';
            } else {
                bitsGroup.style.display = 'none';
                document.getElementById('bitsInput').value = '';
            }
        }
        
        // Force UPPERCASE on text inputs
        function enforceUppercase(input) {
            input.value = input.value.toUpperCase();
        }

        function initDropdowns() {
            ['product', 'design', 'color', 'client'].forEach(type => {
                refreshDropdown(type);
            });
        }
        
        function refreshDropdown(type) {
            const dropdown = document.getElementById(type + 'Dropdown');
            dropdown.innerHTML = '';
            dropdownData[type].forEach(item => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                // Mark custom items with a subtle indicator
                const isCustom = customData[type].some(c => c.toLowerCase() === item.toLowerCase());
                div.textContent = item;
                if (isCustom) {
                    div.style.borderLeft = '3px solid #059669';
                    div.style.paddingLeft = '9px';
                }
                div.onmousedown = () => {
                    document.getElementById(type + 'Input').value = item;
                    updateLabelText();
                };
                dropdown.appendChild(div);
            });
        }

        function filterDropdown(type) {
            const input = document.getElementById(type + 'Input').value.toLowerCase();
            const dropdown = document.getElementById(type + 'Dropdown');
            dropdown.innerHTML = '';
            
            const filtered = dropdownData[type].filter(item => item.toLowerCase().includes(input));
            
            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                const isCustom = customData[type].some(c => c.toLowerCase() === item.toLowerCase());
                div.textContent = item;
                if (isCustom) {
                    div.style.borderLeft = '3px solid #059669';
                    div.style.paddingLeft = '9px';
                }
                div.onmousedown = () => {
                    document.getElementById(type + 'Input').value = item;
                    updateLabelText();
                };
                dropdown.appendChild(div);
            });
            
            // üîê MASTER LOCK CHECK - If no matches and input is not empty
            if (filtered.length === 0 && input.trim()) {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                
                // Check if Master Lock is ON
                if (masterLockEnabled) {
                    // Show warning instead of "Add new" option
                    div.style.color = '#dc2626';
                    div.style.fontStyle = 'italic';
                    div.style.background = '#fef2f2';
                    div.textContent = `üîí "${document.getElementById(type + 'Input').value.trim()}" not found. Master Lock is ON.`;
                    div.onmousedown = () => {
                        alert('üîí MASTER LOCK ENABLED\n\nNew master entries are not allowed.\n\nTo add new values:\n1. Turn OFF Master Lock\n2. Then add new entry');
                    };
                } else {
                    // Master Lock is OFF - show Add option
                    div.style.color = '#059669';
                    div.style.fontStyle = 'italic';
                    div.textContent = `‚ûï Add "${document.getElementById(type + 'Input').value.trim()}" as new ${type}`;
                    div.onmousedown = () => {
                        const newValue = document.getElementById(type + 'Input').value.trim().toUpperCase();
                        const result = addCustomValue(type, newValue);
                        if (result.added) {
                            refreshDropdown(type);
                            console.log(`New ${type} added: ${newValue}`);
                            // Clear input and show popup
                            document.getElementById(type + 'Input').value = '';
                            updateLabelText();
                            alert(`‚úÖ NEW MASTER ENTRY CREATED\n\n"${newValue}" has been added to ${type} list.\n\n‚ö†Ô∏è IMPORTANT:\nPlease re-select the value from dropdown to create a label.\n\nThis ensures data integrity.`);
                        } else if (result.blocked) {
                            alert('üîí MASTER LOCK ENABLED\n\nNew master entries are not allowed.');
                        }
                    };
                }
                dropdown.appendChild(div);
            }
        }

        function showDropdown(type) { document.getElementById(type + 'Dropdown').classList.add('show'); }
        function hideDropdown(type) { setTimeout(() => document.getElementById(type + 'Dropdown').classList.remove('show'), 150); }

        function autoSaveLayout() {
            saveCurrentLayoutToMemory();
        }

        function saveLayout() {
            saveCurrentLayoutToMemory();
            // Also save the current mode
            localStorage.setItem('snehaLayout_mode', showHeader ? 'header' : 'noheader');
            
            // Enable edit lock after saving
            setEditLock(true);
            
            alert(`‚úÖ Layout saved for "${showHeader ? 'With Header' : 'Without Header'}" mode!\n\nüîí Edit Lock has been enabled to protect your layout.\nToggle "Edit Lock" OFF if you need to make changes.`);
        }
        
        // Edit Lock Functions
        function toggleEditLock() {
            const checkbox = document.getElementById('editLockToggle');
            setEditLock(checkbox.checked);
        }
        
        function setEditLock(locked) {
            editLocked = locked;
            const checkbox = document.getElementById('editLockToggle');
            const status = document.getElementById('editLockStatus');
            const canvas = document.getElementById('labelCanvas');
            
            checkbox.checked = locked;
            
            if (locked) {
                status.innerHTML = 'üîí Layout Locked';
                status.style.color = '#dc2626';
                canvas.classList.add('edit-locked');
                // Clear any selection
                clearAllSelections();
            } else {
                status.innerHTML = '‚úèÔ∏è Editing Enabled';
                status.style.color = '#059669';
                canvas.classList.remove('edit-locked');
            }
            
            // Save lock state
            localStorage.setItem('snehaEditLocked', locked ? '1' : '0');
        }
        
        function loadEditLockState() {
            const saved = localStorage.getItem('snehaEditLocked');
            if (saved === '1') {
                setEditLock(true);
            }
        }

        function loadLayout() {
            console.log('Loading layouts from storage...');
            
            // Load both layouts from localStorage (v3 format)
            let savedWithHeader = localStorage.getItem('snehaLayout_withHeader_v3');
            let savedWithoutHeader = localStorage.getItem('snehaLayout_withoutHeader_v3');
            const savedMode = localStorage.getItem('snehaLayout_mode');
            
            // Try older formats for backward compatibility
            if (!savedWithHeader) {
                savedWithHeader = localStorage.getItem('snehaLayout_withHeader_v2') || 
                                  localStorage.getItem('snehaLayout_withHeader') ||
                                  localStorage.getItem('snehaLayout_unified');
                if (savedWithHeader) console.log('Migrating from older layout format');
            }
            if (!savedWithoutHeader) {
                savedWithoutHeader = localStorage.getItem('snehaLayout_withoutHeader_v2') || 
                                     localStorage.getItem('snehaLayout_withoutHeader');
            }
            
            // Parse WITH HEADER layout
            if (savedWithHeader) {
                try {
                    const parsed = JSON.parse(savedWithHeader);
                    if (parsed.elements) {
                        layoutWithHeader = parsed;
                    } else {
                        // Old format - convert it
                        layoutWithHeader = {
                            scale: parsed.scale || 100,
                            contactPhone: parsed.contactPhone || '+91-9000317333',
                            contactEmail: parsed.contactEmail || 'info@snehavinyl.in',
                            contactFontSize: parsed.contactFontSize || '9',
                            elements: {}
                        };
                        Object.keys(parsed).forEach(key => {
                            if (key.startsWith('el_')) {
                                layoutWithHeader.elements[key] = parsed[key];
                            }
                        });
                    }
                    if (layoutWithHeader.scale) contentScale = layoutWithHeader.scale;
                    console.log('Loaded WITH HEADER layout:', Object.keys(layoutWithHeader.elements || {}).length, 'elements');
                } catch(e) { 
                    console.error('Error loading with-header layout:', e);
                    layoutWithHeader = { elements: {} };
                }
            }
            
            // Parse WITHOUT HEADER layout
            if (savedWithoutHeader) {
                try {
                    const parsed = JSON.parse(savedWithoutHeader);
                    if (parsed.elements) {
                        layoutWithoutHeader = parsed;
                    } else {
                        layoutWithoutHeader = {
                            scale: parsed.scale || 100,
                            elements: {}
                        };
                        Object.keys(parsed).forEach(key => {
                            if (key.startsWith('el_')) {
                                layoutWithoutHeader.elements[key] = parsed[key];
                            }
                        });
                    }
                    if (layoutWithoutHeader.scale) contentScaleNoHeader = layoutWithoutHeader.scale;
                    console.log('Loaded WITHOUT HEADER layout:', Object.keys(layoutWithoutHeader.elements || {}).length, 'elements');
                } catch(e) { 
                    console.error('Error loading without-header layout:', e);
                    layoutWithoutHeader = { elements: {} };
                }
            }
            
            // Restore the last used mode
            if (savedMode === 'noheader') {
                // Switch to no-header mode without triggering save
                showHeader = false;
                document.getElementById('headerToggle').classList.remove('active');
                headerElements.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });
            }
            
            // Load the current mode's layout
            loadLayoutForCurrentMode();
            
            // Update scale slider
            const currentScale = showHeader ? contentScale : contentScaleNoHeader;
            document.getElementById('scaleSlider').value = currentScale;
            document.getElementById('scaleValue').textContent = currentScale + '%';
            document.getElementById('labelCanvas').style.transform = `scale(${currentScale / 100})`;
            
            // Update mode indicator
            updateModeIndicator();
            
            // If no layouts were found, save current defaults
            if (!savedWithHeader && !savedWithoutHeader) {
                console.log('No saved layouts found, saving current defaults...');
                setTimeout(() => saveCurrentLayoutToMemory(), 500);
            }
        }
        
        // EXPORT layout to file (for transferring to another system)
        function exportLayout() {
            // Save current state first
            saveCurrentLayoutToMemory();
            
            const exportData = {
                version: 5,
                exportDate: new Date().toISOString(),
                withHeader: layoutWithHeader,
                withoutHeader: layoutWithoutHeader,
                lastMode: localStorage.getItem('snehaLayout_mode') || 'header',
                printLog: printLog,
                customData: customData // Include user-added dropdown values
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sneha-label-layout-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Layout exported! Includes BOTH header layouts and custom dropdown values.');
        }
        
        // IMPORT layout from file
        function importLayout() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.style.display = 'none';
            document.body.appendChild(input);
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                document.body.removeChild(input);
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    // Handle v5 format (separate layouts)
                    if (data.withHeader) {
                        layoutWithHeader = data.withHeader;
                        localStorage.setItem('snehaLayout_withHeader_v3', JSON.stringify(data.withHeader));
                    }
                    if (data.withoutHeader) {
                        layoutWithoutHeader = data.withoutHeader;
                        localStorage.setItem('snehaLayout_withoutHeader_v3', JSON.stringify(data.withoutHeader));
                    }
                    // Handle unified format (v4) - use as withHeader
                    if (data.unified && !data.withHeader) {
                        layoutWithHeader = data.unified;
                        localStorage.setItem('snehaLayout_withHeader_v3', JSON.stringify(data.unified));
                    }
                    
                    if (data.lastMode) {
                        localStorage.setItem('snehaLayout_mode', data.lastMode);
                    }
                    
                    if (data.printLog && Array.isArray(data.printLog)) {
                        printLog = data.printLog;
                        localStorage.setItem('snehaPrintLog', JSON.stringify(data.printLog));
                        updateLogDisplay();
                    }
                    
                    // Import custom dropdown values
                    if (data.customData) {
                        ['design', 'color', 'product', 'client'].forEach(type => {
                            if (data.customData[type] && Array.isArray(data.customData[type])) {
                                data.customData[type].forEach(item => {
                                    if (!customData[type].some(c => c.toLowerCase() === item.toLowerCase())) {
                                        customData[type].push(item);
                                    }
                                });
                                saveCustomData(type);
                            }
                        });
                        updateDropdownData();
                        ['design', 'color', 'product', 'client'].forEach(refreshDropdown);
                    }
                    
                    alert('‚úÖ Layout imported successfully! The page will reload to apply changes.');
                    location.reload();
                    
                } catch(err) {
                    alert('‚ùå Error importing layout: ' + err.message);
                }
            };
            input.click();
        }
        
        // ============ FULL DATA BACKUP & RESTORE ============
        
        // Backup schedule functions (legacy - now using auto backup)
        // v29: Legacy backup schedule functions (kept for backward compatibility)
        function saveBackupSchedule() { }
        function loadBackupSchedule() { updateLastBackupInfo(); }
        
        function updateLastBackupInfo() {
            const lastBackup = localStorage.getItem('snehaLastBackupDate');
            const infoEl = document.getElementById('lastBackupInfo');
            
            if (lastBackup) {
                const date = new Date(lastBackup);
                const now = new Date();
                const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
                
                let timeAgo = '';
                if (diffDays === 0) {
                    timeAgo = 'Today';
                } else if (diffDays === 1) {
                    timeAgo = 'Yesterday';
                } else if (diffDays < 7) {
                    timeAgo = `${diffDays} days ago`;
                } else if (diffDays < 30) {
                    timeAgo = `${Math.floor(diffDays / 7)} week(s) ago`;
                } else {
                    timeAgo = `${Math.floor(diffDays / 30)} month(s) ago`;
                }
                
                const dateStr = date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
                
                infoEl.innerHTML = `üìÖ Last backup: <strong>${timeAgo}</strong><br><span style="color:#888">${dateStr} at ${timeStr}</span>`;
            } else {
                infoEl.innerHTML = '‚ö†Ô∏è Last backup: <strong style="color:#dc2626">Never</strong>';
            }
        }
        
        // v29: Legacy - kept for backward compatibility
        function checkBackupReminder() { }
        
        function createFullBackup() {
            // Save current state first
            saveCurrentLayoutToMemory();
            
            // Collect all roll number serials from localStorage
            const rollSerials = {};
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('snehaRollSerial_')) {
                    rollSerials[key] = localStorage.getItem(key);
                }
            });
            
            const backupData = {
                backupVersion: 4,  // Updated version for master data inclusion
                backupDate: new Date().toISOString(),
                backupType: 'FULL_BACKUP',
                
                // Predefined data (for reference/recovery)
                predefinedData: predefinedData,
                
                // User-added custom data
                customData: customData,
                
                // üî¥ NEW: Deleted masters (permanently deleted items)
                deletedMasters: deletedMasters,
                
                // üî¥ NEW: Inactive masters (deactivated items)
                inactiveMasters: inactiveMasters,
                
                // Layout settings (SEPARATE for each mode)
                layouts: {
                    withHeader: layoutWithHeader,
                    withoutHeader: layoutWithoutHeader,
                    lastMode: localStorage.getItem('snehaLayout_mode') || 'header'
                },
                
                // Print log (all labels ever printed)
                printLog: printLog,
                
                // Roll number serials
                rollSerials: rollSerials,
                lastSystem: localStorage.getItem('snehaLastSystem') || '1',
                
                // Backup schedule
                backupSchedule: localStorage.getItem('snehaBackupSchedule') || 'none',
                
                // Statistics
                stats: {
                    totalPrints: printLog.length,
                    totalMeters: printLog.reduce((sum, item) => sum + (parseFloat(item.meters) || 0), 0),
                    totalWeight: printLog.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0),
                    customClients: customData.client.length,
                    customProducts: customData.product.length,
                    customDesigns: customData.design.length,
                    customColors: customData.color.length,
                    deletedClients: (deletedMasters.client || []).length,
                    deletedProducts: (deletedMasters.product || []).length,
                    inactiveClients: (inactiveMasters.client || []).length,
                    inactiveProducts: (inactiveMasters.product || []).length
                }
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const dateStr = new Date().toISOString().split('T')[0];
            const timeStr = new Date().toTimeString().split(' ')[0].replace(/:/g, '-');
            a.download = `SNEHA-BACKUP-${dateStr}-${timeStr}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Save last backup date
            localStorage.setItem('snehaLastBackupDate', new Date().toISOString());
            updateLastBackupInfo();
            
            alert(`‚úÖ Full Backup Created!\n\n` +
                  `üìä Backup includes:\n` +
                  `‚Ä¢ ${printLog.length} print records\n` +
                  `‚Ä¢ ${customData.client.length} custom clients\n` +
                  `‚Ä¢ ${customData.product.length} custom products\n` +
                  `‚Ä¢ ${customData.design.length} custom designs\n` +
                  `‚Ä¢ ${customData.color.length} custom colors\n` +
                  `‚Ä¢ ${(deletedMasters.client || []).length + (deletedMasters.product || []).length + (deletedMasters.design || []).length + (deletedMasters.color || []).length} deleted masters\n` +
                  `‚Ä¢ ${(inactiveMasters.client || []).length + (inactiveMasters.product || []).length + (inactiveMasters.design || []).length + (inactiveMasters.color || []).length} inactive masters\n` +
                  `‚Ä¢ Layout settings\n` +
                  `‚Ä¢ Roll number sequences\n\n` +
                  `üíæ Save this file in a safe location!`);
        }
        
        function restoreFullBackup() {
            if (!confirm('‚ö†Ô∏è Restore from Backup?\n\n' +
                        'This will replace ALL current data with the backup data:\n' +
                        '‚Ä¢ Print log/records\n' +
                        '‚Ä¢ Custom dropdown values\n' +
                        '‚Ä¢ Layout settings\n' +
                        '‚Ä¢ Roll number sequences\n\n' +
                        'Your current data will be lost!\n\n' +
                        'Do you want to continue?')) {
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.style.display = 'none';
            document.body.appendChild(input);
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                document.body.removeChild(input);
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    // Validate backup file
                    if (!data.backupType || data.backupType !== 'FULL_BACKUP') {
                        if (!confirm('‚ö†Ô∏è This doesn\'t look like a full backup file.\n\n' +
                                    'It might be a layout export file. Try importing anyway?')) {
                            return;
                        }
                    }
                    
                    let restored = [];
                    
                    // Restore layouts
                    if (data.layouts) {
                        if (data.layouts.withHeader) {
                            layoutWithHeader = data.layouts.withHeader;
                            localStorage.setItem('snehaLayout_withHeader_v3', JSON.stringify(data.layouts.withHeader));
                            restored.push('With Header Layout');
                        }
                        if (data.layouts.withoutHeader) {
                            layoutWithoutHeader = data.layouts.withoutHeader;
                            localStorage.setItem('snehaLayout_withoutHeader_v3', JSON.stringify(data.layouts.withoutHeader));
                            restored.push('Without Header Layout');
                        }
                        // Handle unified format from v2 backups
                        if (data.layouts.unified && !data.layouts.withHeader) {
                            layoutWithHeader = data.layouts.unified;
                            localStorage.setItem('snehaLayout_withHeader_v3', JSON.stringify(data.layouts.unified));
                            restored.push('Layout (from unified format)');
                        }
                        if (data.layouts.lastMode) {
                            localStorage.setItem('snehaLayout_mode', data.layouts.lastMode);
                        }
                    } else {
                        // Backward compatibility with old export format
                        if (data.withHeader) {
                            layoutWithHeader = data.withHeader;
                            localStorage.setItem('snehaLayout_withHeader_v3', JSON.stringify(data.withHeader));
                            restored.push('With Header Layout');
                        }
                        if (data.withoutHeader) {
                            layoutWithoutHeader = data.withoutHeader;
                            localStorage.setItem('snehaLayout_withoutHeader_v3', JSON.stringify(data.withoutHeader));
                            restored.push('Without Header Layout');
                        }
                    }
                    
                    // Restore print log
                    if (data.printLog && Array.isArray(data.printLog)) {
                        printLog = data.printLog;
                        localStorage.setItem('snehaPrintLog', JSON.stringify(data.printLog));
                        restored.push(`${data.printLog.length} Print Records`);
                    }
                    
                    // Restore custom data
                    if (data.customData) {
                        ['design', 'color', 'product', 'client'].forEach(type => {
                            if (data.customData[type] && Array.isArray(data.customData[type])) {
                                customData[type] = data.customData[type];
                                saveCustomData(type);
                            }
                        });
                        updateDropdownData();
                        restored.push('Custom Dropdown Values');
                    }
                    
                    // üî¥ NEW: Restore deleted masters
                    if (data.deletedMasters) {
                        deletedMasters = data.deletedMasters;
                        saveDeletedMasters();
                        const deletedCount = Object.values(data.deletedMasters).reduce((sum, arr) => sum + (arr ? arr.length : 0), 0);
                        if (deletedCount > 0) {
                            restored.push(`${deletedCount} Deleted Master Records`);
                        }
                    }
                    
                    // üî¥ NEW: Restore inactive masters
                    if (data.inactiveMasters) {
                        inactiveMasters = data.inactiveMasters;
                        saveInactiveMasters();
                        const inactiveCount = Object.values(data.inactiveMasters).reduce((sum, arr) => sum + (arr ? arr.length : 0), 0);
                        if (inactiveCount > 0) {
                            restored.push(`${inactiveCount} Inactive Master Records`);
                        }
                    }
                    
                    // Restore roll serials (v29: skip ‚Äî reconciliation will derive from report data)
                    // Roll serials from backup are ignored because the reconciliation function
                    // calculates the correct sequence from actual printLog labels on startup.
                    if (data.rollSerials) {
                        restored.push('Roll Sequences (will reconcile from labels)');
                    }
                    
                    // Restore last system
                    if (data.lastSystem) {
                        localStorage.setItem('snehaLastSystem', data.lastSystem);
                    }
                    
                    // Restore backup schedule
                    if (data.backupSchedule) {
                        localStorage.setItem('snehaBackupSchedule', data.backupSchedule);
                        restored.push('Backup Schedule Settings');
                    }
                    
                    // Set last backup date to now (since we just restored)
                    localStorage.setItem('snehaLastBackupDate', new Date().toISOString());

                    // v29: Flag for auto Cloud Push after reload (ensures Firebase stays authoritative)
                    localStorage.setItem('snehaPendingCloudPush', '1');

                    alert(`‚úÖ Backup Restored Successfully!\n\n` +
                          `Restored items:\n‚Ä¢ ${restored.join('\n‚Ä¢ ')}\n\n` +
                          `Data will be pushed to cloud after reload.\n` +
                          `The page will reload to apply changes.`);

                    location.reload();
                    
                } catch(err) {
                    alert('‚ùå Error restoring backup: ' + err.message + '\n\nMake sure you selected a valid backup file.');
                }
            };
            input.click();
        }
        
        // ============================================
        // CLOUD SYNC STATUS (v29: auto-backup to localStorage eliminated)
        // ============================================

        function checkAutoBackup() {
            const statusEl = document.getElementById('autoBackupStatus');
            if (!statusEl) return;

            if (firebaseMigrated && firebaseReady) {
                statusEl.innerHTML = '&#9989; Cloud Sync: <strong>Active</strong> - Data is safe in Firestore';
                statusEl.style.background = '#f0fdf4';
                statusEl.style.borderColor = '#86efac';
                statusEl.style.color = '#166534';
            } else if (firebaseReady && !firebaseMigrated) {
                statusEl.innerHTML = '&#9888;&#65039; Cloud Sync: <strong>Not migrated</strong> - Run Cloud Sync setup';
                statusEl.style.background = '#fef3c7';
                statusEl.style.borderColor = '#fcd34d';
                statusEl.style.color = '#92400e';
            } else {
                statusEl.innerHTML = '&#9888;&#65039; Cloud Sync: <strong>Offline</strong> - Take a manual backup';
                statusEl.style.background = '#fef2f2';
                statusEl.style.borderColor = '#fecaca';
                statusEl.style.color = '#dc2626';
            }
        }
        
        // v28: Auto-backup to localStorage removed. Firestore cloud sync is the backup.
        function runAutoBackup() {
            console.log('v28: Auto-backup to localStorage disabled. Data syncs to Firestore cloud.');
            checkAutoBackup();
        }
        
        // v28: Dead backup folder functions removed (PWA cannot write to filesystem)
        function showAutoBackupNotification() { }
        function addBackupLog() { }
        function openBackupSettings() { }
        function closeBackupSettings() { }
        function saveBackupSettings() { }
        function updateBackupStatus() { }
        function updateBackupFolderStatusUI() { }
        
        // ============================================
        // MASTER LOCK FUNCTIONS
        // ============================================
        
        let masterLockEnabled = true;
        
        function loadMasterLockState() {
            masterLockEnabled = localStorage.getItem('snehaMasterLock') !== 'false';
            const toggle = document.getElementById('masterLockToggle');
            if (toggle) toggle.checked = masterLockEnabled;
            updateMasterLockStatus();
        }
        
        function toggleMasterLock() {
            masterLockEnabled = document.getElementById('masterLockToggle').checked;
            localStorage.setItem('snehaMasterLock', masterLockEnabled ? 'true' : 'false');
            updateMasterLockStatus();
            
            // üî• Sync to Firebase if migrated (v27)
            if (firebaseMigrated && firebaseReady) {
                SnehaFirebase.setSetting('masterLockEnabled', masterLockEnabled).catch(err => {
                    console.warn('Firebase masterLock sync error:', err);
                });
            }
        }
        
        function updateMasterLockStatus() {
            const statusEl = document.getElementById('masterLockStatus');
            if (statusEl) {
                if (masterLockEnabled) {
                    statusEl.innerHTML = 'üîí Locked - New entries blocked';
                    statusEl.style.color = '#dc2626';
                } else {
                    statusEl.innerHTML = 'üîì Unlocked - Admin mode';
                    statusEl.style.color = '#059669';
                }
            }
        }
        
        function checkMasterLock(fieldName, value) {
            if (!masterLockEnabled) return true; // Allow if lock is off
            
            // Check if value exists in predefined or custom data
            const allValues = [
                ...(predefinedData[fieldName] || []),
                ...(customData[fieldName] || [])
            ].map(v => v.toUpperCase());
            
            if (allValues.includes(value.toUpperCase())) {
                return true; // Value exists, allow
            }
            
            // Value is new and lock is on
            alert('üîí Master Lock is enabled.\n\nNew entries are not allowed.\n\nTo add new values, disable Master Lock first.');
            return false;
        }
        
        // ============================================
        // MASTER DATA MANAGEMENT FUNCTIONS
        // ============================================
        
        // Track inactive masters
        let inactiveMasters = {};
        
        function loadInactiveMasters() {
            const saved = localStorage.getItem('snehaInactiveMasters');
            inactiveMasters = saved ? JSON.parse(saved) : {
                client: [],
                product: [],
                design: [],
                color: []
            };
        }
        
        function saveInactiveMasters() {
            localStorage.setItem('snehaInactiveMasters', JSON.stringify(inactiveMasters));
            
            // üî• Sync to Firebase if migrated (v27)
            // Note: Individual status updates are handled in toggle functions
        }
        
        // üóëÔ∏è Track PERMANENTLY DELETED masters (separate from inactive)
        let deletedMasters = {};
        
        function loadDeletedMasters() {
            const saved = localStorage.getItem('snehaDeletedMasters');
            deletedMasters = saved ? JSON.parse(saved) : {
                client: [],
                product: [],
                design: [],
                color: []
            };
        }
        
        function saveDeletedMasters() {
            localStorage.setItem('snehaDeletedMasters', JSON.stringify(deletedMasters));
        }
        
        // Track selected masters for merge/bulk delete
        let selectedMasters = [];
        let lastMasterTab = 'client';
        
        // üîò SWITCH MASTER TAB (replaces dropdown)
        function switchMasterTab(type) {
            // Update hidden select for compatibility
            document.getElementById('masterTypeSelect').value = type;
            
            // Update button styles
            document.querySelectorAll('.master-tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === type) {
                    btn.classList.add('active');
                }
            });
            
            // Save last selected tab
            lastMasterTab = type;
            localStorage.setItem('snehaLastMasterTab', type);
            
            // Clear search when switching tabs
            const searchInput = document.getElementById('masterSearchInput');
            if (searchInput) searchInput.value = '';
            
            // Load the list
            loadMasterList();
        }
        
        // üîç FILTER MASTER LIST BY SEARCH
        function filterMasterList() {
            const searchInput = document.getElementById('masterSearchInput');
            const searchTerm = (searchInput?.value || '').toLowerCase().trim();
            const tbody = document.getElementById('masterListBody');
            
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const nameCell = row.querySelector('td:nth-child(2)');
                if (nameCell) {
                    const name = nameCell.textContent.toLowerCase();
                    if (!searchTerm || name.includes(searchTerm)) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
            
            // Show "no results" message if needed
            const existingNoResults = tbody.querySelector('.no-results-row');
            if (existingNoResults) existingNoResults.remove();
            
            if (visibleCount === 0 && searchTerm) {
                const noResultsRow = document.createElement('tr');
                noResultsRow.className = 'no-results-row';
                noResultsRow.innerHTML = `<td colspan="5" style="padding: 20px; text-align: center; color: #94a3b8;">No results for "${searchTerm}"</td>`;
                tbody.appendChild(noResultsRow);
            }
        }
        
        function openMasterManagement() {
            document.getElementById('masterManagementModal').classList.add('show');
            loadInactiveMasters();
            loadDeletedMasters();
            selectedMasters = [];
            
            // Clear search input
            const searchInput = document.getElementById('masterSearchInput');
            if (searchInput) searchInput.value = '';
            
            // Restore last selected tab
            const savedTab = localStorage.getItem('snehaLastMasterTab') || 'client';
            switchMasterTab(savedTab);
            
            // Update UI based on Master Lock state
            updateMasterManagementLockUI();
            
            // Hide bulk actions initially
            document.getElementById('bulkActionsSection').style.display = 'none';
            document.getElementById('mergeSection').style.display = 'none';
        }
        
        function updateMasterManagementLockUI() {
            const lockBanner = document.getElementById('masterLockBanner');
            const addSection = document.getElementById('addMasterSection');
            const addInput = document.getElementById('newMasterValue');
            const addBtn = document.getElementById('addMasterBtn');
            const lockMsg = document.getElementById('addMasterLockMsg');
            
            if (masterLockEnabled) {
                // Show lock banner
                if (lockBanner) lockBanner.style.display = 'block';
                
                // Disable Add section
                if (addInput) {
                    addInput.disabled = true;
                    addInput.placeholder = 'üîí Master Lock is ON';
                    addInput.style.background = '#f1f5f9';
                }
                if (addBtn) {
                    addBtn.disabled = true;
                    addBtn.style.opacity = '0.5';
                    addBtn.style.cursor = 'not-allowed';
                }
                if (lockMsg) lockMsg.style.display = 'block';
                if (addSection) addSection.style.background = '#fef2f2';
            } else {
                // Hide lock banner
                if (lockBanner) lockBanner.style.display = 'none';
                
                // Enable Add section
                if (addInput) {
                    addInput.disabled = false;
                    addInput.placeholder = 'Enter new value...';
                    addInput.style.background = '';
                }
                if (addBtn) {
                    addBtn.disabled = false;
                    addBtn.style.opacity = '';
                    addBtn.style.cursor = '';
                }
                if (lockMsg) lockMsg.style.display = 'none';
                if (addSection) addSection.style.background = '#f8fafc';
            }
        }
        
        function closeMasterManagement() {
            document.getElementById('masterManagementModal').classList.remove('show');
            selectedMasters = [];
        }
        
        function loadMasterList() {
            const type = document.getElementById('masterTypeSelect').value;
            const tbody = document.getElementById('masterListBody');
            
            // Reset selections when type changes
            selectedMasters = [];
            document.getElementById('selectAllMasters').checked = false;
            updateBulkActionsUI();
            
            // Get deleted masters list
            const deleted = deletedMasters[type] || [];
            
            // Combine predefined and custom data, EXCLUDING permanently deleted
            const allValues = [
                ...(predefinedData[type] || []).map(v => ({ value: v.toUpperCase(), source: 'predefined' })),
                ...(customData[type] || []).map(v => ({ value: v.toUpperCase(), source: 'custom' }))
            ].filter(item => !deleted.includes(item.value));
            
            // Remove duplicates (keep first occurrence)
            const uniqueValues = [];
            const seen = new Set();
            allValues.forEach(item => {
                if (!seen.has(item.value)) {
                    seen.add(item.value);
                    uniqueValues.push(item);
                }
            });
            
            // Sort alphabetically
            uniqueValues.sort((a, b) => a.value.localeCompare(b.value));
            
            // Count usage for each value
            const usageCount = {};
            printLog.forEach(item => {
                const val = (item[type] || '').toUpperCase();
                if (val) {
                    usageCount[val] = (usageCount[val] || 0) + 1;
                }
            });
            
            // Check inactive status
            const inactive = inactiveMasters[type] || [];
            
            let html = '';
            uniqueValues.forEach(item => {
                const upperVal = item.value;
                // üîê ESCAPE special characters for safe JS/HTML usage
                const safeVal = escapeForJS(upperVal);
                const htmlVal = escapeForHTML(upperVal);
                const count = usageCount[upperVal] || 0;
                const isInactive = inactive.includes(upperVal);
                // Allow delete for ANY unused master (including built-in)
                const canDelete = count === 0;
                
                html += `
                    <tr style="${isInactive ? 'background: #fef2f2;' : ''}" data-value="${htmlVal}">
                        <td style="padding: 4px 6px; text-align: center; border-bottom: 1px solid #f1f5f9;">
                            <input type="checkbox" class="master-checkbox" value="${htmlVal}" onchange="toggleMasterSelection('${safeVal}')" ${isInactive ? 'disabled' : ''}>
                        </td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #f1f5f9; font-size: 11px;">
                            ${htmlVal}
                            ${item.source === 'predefined' ? '<span style="font-size: 8px; color: #94a3b8;">(built-in)</span>' : ''}
                        </td>
                        <td style="padding: 4px 6px; text-align: center; border-bottom: 1px solid #f1f5f9; font-size: 11px;">
                            ${count > 0 ? `<span style="color: #059669; font-weight: 600;">${count}</span>` : '<span style="color: #94a3b8;">0</span>'}
                        </td>
                        <td style="padding: 4px 6px; text-align: center; border-bottom: 1px solid #f1f5f9;">
                            ${isInactive ? '<span style="color: #dc2626; font-size: 9px;">Inactive</span>' : '<span style="color: #059669; font-size: 9px;">Active</span>'}
                        </td>
                        <td style="padding: 4px 6px; text-align: center; border-bottom: 1px solid #f1f5f9;">
                            <div style="display: flex; gap: 3px; justify-content: center;">
                                <!-- Edit button for ALL masters -->
                                <button onclick="editMaster('${type}', '${safeVal}', '${item.source}')" style="padding: 2px 5px; font-size: 9px; background: #dbeafe; border: 1px solid #93c5fd; color: #1d4ed8; border-radius: 3px; cursor: pointer;" title="Edit/Rename">‚úèÔ∏è</button>
                                ${canDelete ? 
                                    `<button onclick="deleteMaster('${type}', '${safeVal}', '${item.source}')" style="padding: 2px 5px; font-size: 9px; background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; border-radius: 3px; cursor: pointer;" title="Delete">üóëÔ∏è</button>` :
                                    `<button onclick="toggleMasterActive('${type}', '${safeVal}')" style="padding: 2px 5px; font-size: 9px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 3px; cursor: pointer;" title="${isInactive ? 'Activate' : 'Deactivate'}">${isInactive ? '‚úÖ' : 'üö´'}</button>`
                                }
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html || '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #94a3b8;">No entries found</td></tr>';
            
            // Update merge target dropdown
            updateMergeTargetDropdown(uniqueValues, inactive);
        }
        
        // üîß RECONCILE MASTERS - Fix usage counts and find orphans
        function reconcileMasters() {
            const type = document.getElementById('masterTypeSelect').value;
            const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
            
            // Get all unique values from printLog for this type
            const valuesInLog = new Set();
            printLog.forEach(item => {
                const val = (item[type] || '').trim().toUpperCase();
                if (val) {
                    valuesInLog.add(val);
                }
            });
            
            // Get all master values (predefined + custom, excluding deleted)
            const deleted = deletedMasters[type] || [];
            const allMasters = new Set([
                ...(predefinedData[type] || []).map(v => v.toUpperCase()),
                ...(customData[type] || []).map(v => v.toUpperCase())
            ].filter(v => !deleted.includes(v)));
            
            // Find orphan masters (in master list but NOT in printLog)
            const orphanMasters = [...allMasters].filter(m => !valuesInLog.has(m));
            
            // Find unlinked values (in printLog but NOT in master list)
            const unlinkedValues = [...valuesInLog].filter(v => !allMasters.has(v));
            
            // Count usage for each value in printLog
            const usageCount = {};
            printLog.forEach(item => {
                const val = (item[type] || '').trim().toUpperCase();
                if (val) {
                    usageCount[val] = (usageCount[val] || 0) + 1;
                }
            });
            
            // Build report
            let report = `üîß MASTER RECONCILIATION REPORT\n`;
            report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            report += `Type: ${typeLabel}s\n`;
            report += `Total labels in system: ${printLog.length}\n`;
            report += `Unique ${typeLabel}s in labels: ${valuesInLog.size}\n`;
            report += `Master entries: ${allMasters.size}\n\n`;
            
            if (orphanMasters.length > 0) {
                report += `‚ö†Ô∏è ORPHAN MASTERS (0 usage - can be deleted):\n`;
                orphanMasters.slice(0, 10).forEach(m => {
                    report += `  ‚Ä¢ ${m}\n`;
                });
                if (orphanMasters.length > 10) {
                    report += `  ... and ${orphanMasters.length - 10} more\n`;
                }
                report += `\n`;
            } else {
                report += `‚úÖ No orphan masters found.\n\n`;
            }
            
            if (unlinkedValues.length > 0) {
                report += `‚ùå UNLINKED VALUES (in labels but NO master entry):\n`;
                unlinkedValues.slice(0, 10).forEach(v => {
                    const count = usageCount[v] || 0;
                    report += `  ‚Ä¢ ${v} (${count} labels)\n`;
                });
                if (unlinkedValues.length > 10) {
                    report += `  ... and ${unlinkedValues.length - 10} more\n`;
                }
                report += `\n`;
            } else {
                report += `‚úÖ All label values have matching master entries.\n\n`;
            }
            
            // Show top used values
            const topUsed = [...valuesInLog]
                .map(v => ({ value: v, count: usageCount[v] || 0 }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);
            
            if (topUsed.length > 0) {
                report += `üìä TOP USED ${typeLabel.toUpperCase()}S:\n`;
                topUsed.forEach((item, i) => {
                    report += `  ${i + 1}. ${item.value}: ${item.count} labels\n`;
                });
            }
            
            // Offer to fix unlinked values
            if (unlinkedValues.length > 0) {
                report += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                report += `Click OK to automatically add ${unlinkedValues.length} missing master entries.`;
                
                if (confirm(report)) {
                    // Add unlinked values to customData
                    let added = 0;
                    unlinkedValues.forEach(val => {
                        if (!customData[type].some(c => c.toUpperCase() === val)) {
                            customData[type].push(val);
                            added++;
                        }
                    });
                    
                    if (added > 0) {
                        saveCustomData(type);
                        updateDropdownData();
                        loadMasterList();
                        logInfo('Master', 'Reconcile', `Added ${added} missing ${type} masters`, type);
                        alert(`‚úÖ Added ${added} missing ${typeLabel} masters.\n\nUsage counts are now correct.`);
                    }
                }
            } else {
                alert(report);
            }
        }
        
        function toggleSelectAllMasters() {
            const selectAll = document.getElementById('selectAllMasters').checked;
            const checkboxes = document.querySelectorAll('.master-checkbox:not(:disabled)');
            
            selectedMasters = [];
            checkboxes.forEach(cb => {
                cb.checked = selectAll;
                if (selectAll) {
                    selectedMasters.push(cb.value);
                }
            });
            
            updateMergeSection();
        }
        
        function toggleMasterSelection(value) {
            const idx = selectedMasters.indexOf(value);
            if (idx > -1) {
                selectedMasters.splice(idx, 1);
            } else {
                selectedMasters.push(value);
            }
            
            // Update select all checkbox
            const checkboxes = document.querySelectorAll('.master-checkbox:not(:disabled)');
            const allChecked = selectedMasters.length === checkboxes.length && checkboxes.length > 0;
            document.getElementById('selectAllMasters').checked = allChecked;
            
            updateBulkActionsUI();
        }
        
        // Update bulk actions section visibility
        function updateBulkActionsUI() {
            const bulkSection = document.getElementById('bulkActionsSection');
            const mergeSection = document.getElementById('mergeSection');
            const countText = document.getElementById('selectedCountText');
            
            if (selectedMasters.length >= 1) {
                bulkSection.style.display = 'block';
                countText.textContent = `${selectedMasters.length} selected`;
            } else {
                bulkSection.style.display = 'none';
                mergeSection.style.display = 'none';
            }
        }
        
        function showMergeSection() {
            if (selectedMasters.length < 2) {
                alert('‚ö†Ô∏è Select at least 2 items to merge.');
                return;
            }
            document.getElementById('mergeSection').style.display = 'block';
        }
        
        // üóëÔ∏è BULK DELETE MASTERS
        function bulkDeleteMasters() {
            // v29: Respect master lock
            if (masterLockEnabled) {
                alert('üîí Master Lock is ON\n\nCannot delete master entries while the lock is enabled.\n\nGo to Master Database ‚Üí turn OFF the lock toggle first.');
                return;
            }

            const type = document.getElementById('masterTypeSelect').value;

            if (selectedMasters.length === 0) {
                alert('‚ö†Ô∏è No items selected.');
                return;
            }
            
            // Count usage for each selected
            const usageCount = {};
            printLog.forEach(item => {
                const val = (item[type] || '').toUpperCase();
                if (val) {
                    usageCount[val] = (usageCount[val] || 0) + 1;
                }
            });
            
            // Separate into deletable and in-use
            const deletable = [];
            const inUse = [];
            
            selectedMasters.forEach(value => {
                if ((usageCount[value] || 0) === 0) {
                    deletable.push(value);
                } else {
                    inUse.push(value);
                }
            });
            
            if (deletable.length === 0) {
                alert('‚ùå CANNOT DELETE\n\nAll selected items are in use and cannot be deleted.\n\nUse "Merge" to consolidate them instead.');
                return;
            }
            
            let msg = `üóëÔ∏è BULK DELETE CONFIRMATION\n\nYou are about to permanently delete ${deletable.length} master record(s):\n`;
            msg += deletable.slice(0, 5).join(', ');
            if (deletable.length > 5) msg += ` ... and ${deletable.length - 5} more`;
            
            if (inUse.length > 0) {
                msg += `\n\n‚ö†Ô∏è ${inUse.length} item(s) will be SKIPPED because they are in use.`;
            }
            
            msg += '\n\nThis action cannot be undone. Are you sure?';
            
            if (!confirm(msg)) {
                return;
            }
            
            // Perform delete
            let deletedCount = 0;
            deletable.forEach(value => {
                // Add to permanently deleted list
                if (!deletedMasters[type]) deletedMasters[type] = [];
                if (!deletedMasters[type].includes(value)) {
                    deletedMasters[type].push(value);
                }
                
                // Also remove from customData if it's there
                const customIdx = customData[type].findIndex(v => v.toUpperCase() === value);
                if (customIdx > -1) {
                    customData[type].splice(customIdx, 1);
                }
                
                deletedCount++;
            });
            
            // Save changes
            saveDeletedMasters();
            saveCustomData();
            
            // Reset selection and reload
            selectedMasters = [];
            document.getElementById('selectAllMasters').checked = false;
            loadMasterList();
            refreshDropdown(type);
            
            // Show result
            let resultMsg = `‚úÖ BULK DELETE COMPLETE\n\nDeleted: ${deletedCount}`;
            if (inUse.length > 0) {
                resultMsg += `\nSkipped (in use): ${inUse.length}`;
            }
            alert(resultMsg);
        }
        
        function updateMergeSection() {
            // Kept for compatibility - actual logic moved to updateBulkActionsUI
        }
        
        function updateMergeTargetDropdown(allValues, inactive) {
            const select = document.getElementById('mergeTargetSelect');
            select.innerHTML = '<option value="">-- Select Target --</option>';
            
            allValues.filter(item => !inactive.includes(item.value)).forEach(item => {
                select.innerHTML += `<option value="${item.value}">${item.value}</option>`;
            });
        }
        
        function executeMerge() {
            const type = document.getElementById('masterTypeSelect').value;
            const target = document.getElementById('mergeTargetSelect').value;
            
            if (!target) {
                alert('‚ö†Ô∏è Please select a target to merge into.');
                return;
            }
            
            if (selectedMasters.length < 2) {
                alert('‚ö†Ô∏è Please select at least 2 items to merge.');
                return;
            }
            
            // Sources are all selected items except the target
            const sources = selectedMasters.filter(v => v !== target);
            
            if (sources.length === 0) {
                alert('‚ö†Ô∏è Please select source items different from target.');
                return;
            }
            
            const sourceList = sources.join(', ');
            if (!confirm(`üîÄ MERGE CONFIRMATION\n\nYou are about to move all labels and reports from:\n${sourceList}\n\nInto target:\n${target}\n\nSource items will be marked as INACTIVE.\nThis action cannot be undone.\n\nAre you sure?`)) {
                return;
            }
            
            // Perform merge - update all printLog entries
            let mergedCount = 0;
            printLog.forEach(item => {
                const currentVal = (item[type] || '').toUpperCase();
                if (sources.includes(currentVal)) {
                    item[type] = target;
                    mergedCount++;
                }
            });
            
            // Save updated printLog
            savePrintLog();
            
            // Mark source items as inactive
            sources.forEach(source => {
                if (!inactiveMasters[type]) inactiveMasters[type] = [];
                if (!inactiveMasters[type].includes(source)) {
                    inactiveMasters[type].push(source);
                }
            });
            saveInactiveMasters();
            
            // Reset selections
            selectedMasters = [];
            document.getElementById('selectAllMasters').checked = false;
            
            // Reload list
            loadMasterList();
            refreshDropdown(type);
            
            alert(`‚úÖ MERGE COMPLETE!\n\n${mergedCount} labels/reports reassigned to "${target}".\n\n${sources.length} source items marked as inactive.`);
        }
        
        // ‚úèÔ∏è EDIT MASTER - Rename and update all linked data
        function editMaster(type, oldValue, source) {
            const newValue = prompt(`‚úèÔ∏è EDIT MASTER\n\nCurrent value: ${oldValue}\n\nEnter new value:`, oldValue);
            
            if (!newValue || newValue.trim() === '') {
                return;
            }
            
            // üßπ Sanitize the new value
            const newValueUpper = sanitizeMasterValue(newValue);
            
            if (!newValueUpper) {
                alert('‚ùå Invalid value. Please enter a valid name.');
                return;
            }
            
            if (newValueUpper === oldValue.toUpperCase()) {
                alert('No changes made.');
                return;
            }
            
            // Check if new value already exists (excluding the old value being renamed)
            const allValues = [
                ...(predefinedData[type] || []),
                ...(customData[type] || [])
            ].map(v => v.toUpperCase()).filter(v => v !== oldValue.toUpperCase());
            
            // Also check deleted masters (can't rename to a deleted name)
            const deleted = (deletedMasters[type] || []);
            
            if (allValues.includes(newValueUpper) && !deleted.includes(newValueUpper)) {
                alert(`‚ö†Ô∏è "${newValueUpper}" already exists.\n\nUse Merge instead to consolidate.`);
                return;
            }
            
            // If new value was previously deleted, remove from deleted list
            if (deleted.includes(newValueUpper)) {
                const delIdx = deleted.indexOf(newValueUpper);
                if (delIdx > -1) {
                    deletedMasters[type].splice(delIdx, 1);
                    saveDeletedMasters();
                }
            }
            
            // Count usage
            let usageCount = 0;
            printLog.forEach(item => {
                if ((item[type] || '').toUpperCase() === oldValue.toUpperCase()) {
                    usageCount++;
                }
            });
            
            if (!confirm(`‚úèÔ∏è RENAME MASTER (IN-PLACE UPDATE)\n\n"${oldValue}" ‚Üí "${newValueUpper}"\n\nThis will:\n‚Ä¢ Update master entry\n‚Ä¢ Update ${usageCount} labels/reports\n‚Ä¢ Old name will be permanently removed\n\nContinue?`)) {
                return;
            }
            
            try {
                // Update all printLog entries
                printLog.forEach(item => {
                    if ((item[type] || '').toUpperCase() === oldValue.toUpperCase()) {
                        item[type] = newValueUpper;
                    }
                });
                savePrintLog();
                
                // üî¥ TRUE IN-PLACE RENAME: Add new, DELETE old (not just inactive)
                if (source === 'predefined') {
                    // For predefined: Add new value to custom, DELETE old from view
                    if (!customData[type].some(v => v.toUpperCase() === newValueUpper)) {
                        customData[type].push(newValueUpper);
                        saveCustomData();
                    }
                    // PERMANENTLY DELETE old predefined value (not just inactive)
                    if (!deletedMasters[type]) deletedMasters[type] = [];
                    if (!deletedMasters[type].includes(oldValue.toUpperCase())) {
                        deletedMasters[type].push(oldValue.toUpperCase());
                    }
                    saveDeletedMasters();
                    // Also remove from inactive if it was there
                    if (inactiveMasters[type]) {
                        const inactIdx = inactiveMasters[type].indexOf(oldValue.toUpperCase());
                        if (inactIdx > -1) {
                            inactiveMasters[type].splice(inactIdx, 1);
                            saveInactiveMasters();
                        }
                    }
                } else {
                    // For custom: TRUE in-place update
                    const idx = customData[type].findIndex(v => v.toUpperCase() === oldValue.toUpperCase());
                    if (idx > -1) {
                        customData[type][idx] = newValueUpper;
                        saveCustomData();
                    }
                }
                
                logInfo('Master', 'Rename', `Renamed "${oldValue}" ‚Üí "${newValueUpper}" (${usageCount} refs updated)`, type);
                
                // üî• Sync to Firebase if migrated (v27)
                if (firebaseMigrated && firebaseReady) {
                    SnehaFirebase.renameMaster(type, oldValue, newValueUpper).catch(err => {
                        console.warn('Firebase rename sync error:', err);
                    });
                }
                
                // Reload
                updateDropdownData();
                loadMasterList();
                refreshDropdown(type);
                
                alert(`‚úÖ RENAME COMPLETE!\n\n"${oldValue}" ‚Üí "${newValueUpper}"\n\n${usageCount} labels/reports updated.\n\nOld name has been permanently removed.`);
            } catch (err) {
                logError('Master', 'RenameFailed', `Failed to rename "${oldValue}": ${err.message}`, 'ERROR', type);
                alert(`‚ùå Error renaming master:\n\n${err.message}`);
            }
        }
        
        // üóëÔ∏è DELETE MASTER - Works for ALL masters including built-in
        // Uses deletedMasters for PERMANENT persistence across refreshes
        function deleteMaster(type, value, source) {
            // v29: Respect master lock
            if (masterLockEnabled) {
                alert('üîí Master Lock is ON\n\nCannot delete master entries while the lock is enabled.\n\nGo to Master Database ‚Üí turn OFF the lock toggle first.');
                return;
            }

            // Check if used anywhere
            const used = printLog.some(item => (item[type] || '').toUpperCase() === value.toUpperCase());
            
            if (used) {
                logWarn('Master', 'DeleteBlocked', `Cannot delete "${value}" - in use`, type);
                alert('‚ùå Cannot delete!\n\nThis value is used in existing labels/reports.\n\nOptions:\n‚Ä¢ Mark it as "Inactive"\n‚Ä¢ Use "Merge" to consolidate with another entry\n‚Ä¢ Use "Edit" to rename');
                return;
            }
            
            const sourceLabel = source === 'predefined' ? ' (built-in)' : '';
            if (!confirm(`‚ö†Ô∏è PERMANENTLY DELETE "${value}"${sourceLabel}?\n\nThis action cannot be undone.\nThe entry will NOT reappear after refresh.`)) {
                return;
            }
            
            try {
                // Add to permanently deleted list (works for BOTH built-in and custom)
                if (!deletedMasters[type]) deletedMasters[type] = [];
                if (!deletedMasters[type].includes(value.toUpperCase())) {
                    deletedMasters[type].push(value.toUpperCase());
                }
                saveDeletedMasters();
                
                // Also remove from customData if it's a custom entry
                if (source !== 'predefined') {
                    const idx = customData[type].findIndex(v => v.toUpperCase() === value.toUpperCase());
                    if (idx > -1) {
                        customData[type].splice(idx, 1);
                        saveCustomData();
                    }
                }
                
                // üî• Sync to Firebase if migrated (v27)
                if (firebaseMigrated && firebaseReady) {
                    SnehaFirebase.updateMasterStatus(type, value, 'deleted').catch(err => {
                        console.warn('Firebase delete sync error:', err);
                    });
                }
                
                logInfo('Master', 'Delete', `Deleted "${value}" (${source})`, type);
                loadMasterList();
                refreshDropdown(type);
                alert(`‚úÖ "${value}" permanently deleted!\n\nIt will not reappear after refresh.`);
            } catch (err) {
                logError('Master', 'DeleteFailed', `Failed to delete "${value}": ${err.message}`, 'ERROR', type);
                alert(`‚ùå Error deleting "${value}":\n\n${err.message}\n\nCheck Error Log for details.`);
            }
        }
        
        function toggleMasterActive(type, value) {
            const inactive = inactiveMasters[type] || [];
            const idx = inactive.indexOf(value.toUpperCase());
            const newStatus = idx > -1 ? 'active' : 'inactive';
            
            if (idx > -1) {
                // Make active
                inactive.splice(idx, 1);
            } else {
                // Make inactive
                inactive.push(value.toUpperCase());
            }
            
            inactiveMasters[type] = inactive;
            saveInactiveMasters();
            loadMasterList();
            refreshDropdown(type);
            
            // üî• Sync to Firebase if migrated (v27)
            if (firebaseMigrated && firebaseReady) {
                SnehaFirebase.updateMasterStatus(type, value, newStatus).catch(err => {
                    console.warn('Firebase master status sync error:', err);
                });
            }
        }
        
        function addNewMaster() {
            // üîê MASTER LOCK CHECK - ABSOLUTE BLOCK
            if (masterLockEnabled) {
                alert('üîí MASTER LOCK ENABLED\n\nNew master entries are not allowed.\n\nTo add new entries:\n1. Go to main screen\n2. Turn OFF Master Lock\n3. Return here to add entries');
                return;
            }
            
            const type = document.getElementById('masterTypeSelect').value;
            const input = document.getElementById('newMasterValue');
            const value = input.value.trim().toUpperCase();
            
            if (!value) {
                alert('‚ö†Ô∏è Please enter a value.');
                return;
            }
            
            // Check if already exists
            const allValues = [
                ...(predefinedData[type] || []),
                ...(customData[type] || [])
            ].map(v => v.toUpperCase());
            
            if (allValues.includes(value)) {
                alert('‚ö†Ô∏è This value already exists.');
                return;
            }
            
            // Add to custom data
            customData[type].push(value);
            saveCustomData();
            
            input.value = '';
            loadMasterList();
            refreshDropdown(type);
            
            alert(`‚úÖ "${value}" added successfully!`);
        }
        
        function refreshDropdown(type) {
            // Refresh the corresponding dropdown in the form
            const dropdownIds = {
                client: 'clientInput',
                product: 'productInput',
                design: 'designInput',
                color: 'colorInput'
            };
            
            const dropdownId = dropdownIds[type];
            if (!dropdownId) return;
            
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;
            
            // Get inactive and deleted lists
            const inactive = inactiveMasters[type] || [];
            const deleted = deletedMasters[type] || [];
            
            // Get all values except inactive and deleted ones
            const allValues = [
                ...(predefinedData[type] || []),
                ...(customData[type] || [])
            ].filter(v => !inactive.includes(v.toUpperCase()) && !deleted.includes(v.toUpperCase()))
             .map(v => v.toUpperCase())
             .sort();
            
            // Update dropdownData for consistency
            dropdownData[type] = allValues;
            
            // Recreate datalist
            let datalistId = dropdown.getAttribute('list');
            if (datalistId) {
                let datalist = document.getElementById(datalistId);
                if (datalist) {
                    datalist.innerHTML = allValues.map(v => `<option value="${v}">`).join('');
                }
            }
        }
        
        // ============================================
        // ERROR LOG VIEWER FUNCTIONS
        // ============================================
        
        function openErrorLog() {
            document.getElementById('errorLogModal').classList.add('show');
            displayErrorLog();
        }
        
        function closeErrorLog() {
            document.getElementById('errorLogModal').classList.remove('show');
        }
        
        function displayErrorLog() {
            const tbody = document.getElementById('errorLogBody');
            const countEl = document.getElementById('errorLogCount');
            const severityFilter = document.getElementById('errorSeverityFilter').value;
            const moduleFilter = document.getElementById('errorModuleFilter').value;
            
            // Filter logs
            let filtered = errorLog.filter(entry => {
                if (severityFilter && entry.severity !== severityFilter) return false;
                if (moduleFilter && entry.module !== moduleFilter) return false;
                return true;
            });
            
            // Sort by timestamp descending (newest first)
            filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            countEl.textContent = `üìä Showing ${filtered.length} of ${errorLog.length} entries`;
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="padding: 80px 20px; text-align: center; color: #64748b; background: #f8fafc;">
                            <div style="font-size: 60px; margin-bottom: 15px;">üìã</div>
                            <div style="font-size: 18px; font-weight: 700; color: #334155;">No log entries found</div>
                            <div style="font-size: 14px; margin-top: 8px; color: #64748b;">Errors and warnings will appear here</div>
                        </td>
                    </tr>`;
                return;
            }
            
            let html = '';
            filtered.forEach((entry, index) => {
                const date = new Date(entry.timestamp);
                const dateStr = date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                
                // Severity badge styles - LARGE & CLEAR
                let severityBadge = '';
                switch(entry.severity) {
                    case 'INFO': 
                        severityBadge = '<span style="background: #3b82f6; color: white; padding: 6px 14px; border-radius: 6px; font-size: 12px; font-weight: 700; display: inline-block;">‚ÑπÔ∏è INFO</span>'; 
                        break;
                    case 'WARN': 
                        severityBadge = '<span style="background: #f59e0b; color: white; padding: 6px 14px; border-radius: 6px; font-size: 12px; font-weight: 700; display: inline-block;">‚ö†Ô∏è WARN</span>'; 
                        break;
                    case 'ERROR': 
                        severityBadge = '<span style="background: #ef4444; color: white; padding: 6px 14px; border-radius: 6px; font-size: 12px; font-weight: 700; display: inline-block;">‚ùå ERROR</span>'; 
                        break;
                    case 'CRITICAL': 
                        severityBadge = '<span style="background: #7f1d1d; color: white; padding: 6px 14px; border-radius: 6px; font-size: 12px; font-weight: 700; display: inline-block; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">üî¥ CRITICAL</span>'; 
                        break;
                }
                
                const safeMessage = escapeForHTML(entry.message || '');
                
                html += `
                    <tr>
                        <td style="padding: 16px 20px; border-bottom: 1px solid #e2e8f0; vertical-align: top;">
                            <div style="font-size: 14px; font-weight: 700; color: #1e293b;">${dateStr}</div>
                            <div style="font-size: 13px; color: #64748b; margin-top: 2px;">${timeStr}</div>
                        </td>
                        <td style="padding: 16px 20px; border-bottom: 1px solid #e2e8f0; text-align: center; vertical-align: top;">
                            ${severityBadge}
                        </td>
                        <td style="padding: 16px 20px; border-bottom: 1px solid #e2e8f0; vertical-align: top;">
                            <div style="font-size: 14px; font-weight: 700; color: #1e293b;">${entry.module || '-'}</div>
                            <div style="font-size: 13px; color: #64748b; margin-top: 2px;">${entry.action || '-'}</div>
                        </td>
                        <td style="padding: 16px 20px; border-bottom: 1px solid #e2e8f0; font-size: 14px; color: #334155; line-height: 1.6; vertical-align: top;" title="${safeMessage}">
                            ${safeMessage}
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        function clearErrorLog() {
            if (!confirm('‚ö†Ô∏è Clear all error log entries?\n\nThis cannot be undone.')) {
                return;
            }
            errorLog = [];
            saveErrorLog();
            displayErrorLog();
            alert('‚úÖ Error log cleared.');
        }
        
        function exportErrorLog() {
            if (errorLog.length === 0) {
                alert('No log entries to export.');
                return;
            }
            
            let csv = 'Timestamp,Severity,Module,Action,Entity Type,Message\n';
            errorLog.forEach(entry => {
                csv += `"${entry.timestamp}","${entry.severity}","${entry.module}","${entry.action}","${entry.entityType || ''}","${(entry.message || '').replace(/"/g, '""')}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sneha-error-log-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ============================================
        // DATA MIGRATION TOOL FUNCTIONS
        // ============================================
        
        let migrationData = null;
        let migrationStats = null;
        
        function openMigrationTool() {
            document.getElementById('migrationModal').classList.add('show');
            document.getElementById('migrationPreview').style.display = 'none';
            document.getElementById('migrationProgress').style.display = 'none';
            document.getElementById('executeMigrationBtn').disabled = true;
            document.getElementById('migrationFile').value = '';
            migrationData = null;
            migrationStats = null;
        }
        
        function closeMigrationTool() {
            document.getElementById('migrationModal').classList.remove('show');
        }
        
        function previewMigration() {
            const fileInput = document.getElementById('migrationFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('‚ö†Ô∏è Please select a backup file first.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    migrationData = data;
                    
                    // Analyze and clean data
                    migrationStats = analyzeMigrationData(data);
                    
                    // Show preview
                    const previewEl = document.getElementById('migrationPreview');
                    const statsEl = document.getElementById('migrationStats');
                    
                    statsEl.innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <b>üìä Original Data:</b><br>
                                ‚Ä¢ Clients: ${migrationStats.originalClients}<br>
                                ‚Ä¢ Products: ${migrationStats.originalProducts}<br>
                                ‚Ä¢ Designs: ${migrationStats.originalDesigns}<br>
                                ‚Ä¢ Colors: ${migrationStats.originalColors}<br>
                                ‚Ä¢ Labels: ${migrationStats.totalLabels}
                            </div>
                            <div>
                                <b>‚ú® After Cleaning:</b><br>
                                ‚Ä¢ Clients: ${migrationStats.cleanedClients} <span style="color: #dc2626;">(${migrationStats.clientDuplicates} merged)</span><br>
                                ‚Ä¢ Products: ${migrationStats.cleanedProducts} <span style="color: #dc2626;">(${migrationStats.productDuplicates} merged)</span><br>
                                ‚Ä¢ Designs: ${migrationStats.cleanedDesigns} <span style="color: #dc2626;">(${migrationStats.designDuplicates} merged)</span><br>
                                ‚Ä¢ Colors: ${migrationStats.cleanedColors} <span style="color: #dc2626;">(${migrationStats.colorDuplicates} merged)</span><br>
                                ‚Ä¢ Labels: ${migrationStats.totalLabels} <span style="color: #22c55e;">(preserved)</span>
                            </div>
                        </div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e2e8f0;">
                            <b>üîß Cleaning Actions:</b><br>
                            ‚Ä¢ Convert all text to UPPERCASE<br>
                            ‚Ä¢ Merge case-insensitive duplicates<br>
                            ‚Ä¢ Remove leading/trailing spaces<br>
                            ‚Ä¢ Clean special characters
                        </div>
                    `;
                    
                    previewEl.style.display = 'block';
                    document.getElementById('executeMigrationBtn').disabled = false;
                    
                } catch (err) {
                    alert('‚ùå Error reading file: ' + err.message);
                }
            };
            reader.readAsText(file);
        }
        
        function analyzeMigrationData(data) {
            const stats = {
                originalClients: 0,
                originalProducts: 0,
                originalDesigns: 0,
                originalColors: 0,
                cleanedClients: 0,
                cleanedProducts: 0,
                cleanedDesigns: 0,
                cleanedColors: 0,
                clientDuplicates: 0,
                productDuplicates: 0,
                designDuplicates: 0,
                colorDuplicates: 0,
                totalLabels: 0
            };
            
            // Count original items
            const allClients = [...(data.predefinedData?.client || []), ...(data.customData?.client || [])];
            const allProducts = [...(data.predefinedData?.product || []), ...(data.customData?.product || [])];
            const allDesigns = [...(data.predefinedData?.design || []), ...(data.customData?.design || [])];
            const allColors = [...(data.predefinedData?.color || []), ...(data.customData?.color || [])];
            
            stats.originalClients = allClients.length;
            stats.originalProducts = allProducts.length;
            stats.originalDesigns = allDesigns.length;
            stats.originalColors = allColors.length;
            stats.totalLabels = (data.printLog || []).length;
            
            // Clean and count unique
            const cleanSet = (arr) => [...new Set(arr.map(s => cleanString(s)).filter(Boolean))];
            
            stats.cleanedClients = cleanSet(allClients).length;
            stats.cleanedProducts = cleanSet(allProducts).length;
            stats.cleanedDesigns = cleanSet(allDesigns).length;
            stats.cleanedColors = cleanSet(allColors).length;
            
            stats.clientDuplicates = stats.originalClients - stats.cleanedClients;
            stats.productDuplicates = stats.originalProducts - stats.cleanedProducts;
            stats.designDuplicates = stats.originalDesigns - stats.cleanedDesigns;
            stats.colorDuplicates = stats.originalColors - stats.cleanedColors;
            
            return stats;
        }
        
        function cleanString(str) {
            if (!str || typeof str !== 'string') return '';
            return str
                .toUpperCase()
                .trim()
                .replace(/\s+/g, ' ')  // Multiple spaces to single
                .replace(/[\\\/,;]+$/, '')  // Remove trailing special chars
                .replace(/^[\\\/,;]+/, '')  // Remove leading special chars
                .replace(/\s*,\s*/g, ' ')   // Commas to spaces
                .trim();
        }
        
        function executeMigration() {
            if (!migrationData) {
                alert('‚ö†Ô∏è Please preview the data first.');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è Execute Migration?\n\nThis will:\n‚Ä¢ Import cleaned data into the app\n‚Ä¢ Merge duplicates\n‚Ä¢ Update all labels\n\nYour current data will be replaced.\n\nContinue?')) {
                return;
            }
            
            const progressEl = document.getElementById('migrationProgress');
            const progressBar = document.getElementById('migrationProgressBar');
            const logEl = document.getElementById('migrationLog');
            
            progressEl.style.display = 'block';
            logEl.innerHTML = '';
            
            let progress = 0;
            const log = (msg) => { logEl.innerHTML += msg + '<br>'; logEl.scrollTop = logEl.scrollHeight; };
            const setProgress = (p) => { progress = p; progressBar.style.width = p + '%'; };
            
            try {
                setProgress(10);
                log('üì¶ Reading backup data...');
                
                // Clean and merge masters
                setProgress(20);
                log('üîß Cleaning client data...');
                const cleanedClients = [...new Set([
                    ...(migrationData.predefinedData?.client || []).map(cleanString),
                    ...(migrationData.customData?.client || []).map(cleanString)
                ].filter(Boolean))];
                
                setProgress(30);
                log('üîß Cleaning product data...');
                const cleanedProducts = [...new Set([
                    ...(migrationData.predefinedData?.product || []).map(cleanString),
                    ...(migrationData.customData?.product || []).map(cleanString)
                ].filter(Boolean))];
                
                setProgress(40);
                log('üîß Cleaning design data...');
                const cleanedDesigns = [...new Set([
                    ...(migrationData.predefinedData?.design || []).map(cleanString),
                    ...(migrationData.customData?.design || []).map(cleanString)
                ].filter(Boolean))];
                
                setProgress(50);
                log('üîß Cleaning color data...');
                const cleanedColors = [...new Set([
                    ...(migrationData.predefinedData?.color || []).map(cleanString),
                    ...(migrationData.customData?.color || []).map(cleanString)
                ].filter(Boolean))];
                
                setProgress(60);
                log('üìù Updating label records...');
                const cleanedPrintLog = (migrationData.printLog || []).map(item => ({
                    ...item,
                    client: cleanString(item.client || ''),
                    product: cleanString(item.product || ''),
                    design: cleanString(item.design || ''),
                    color: cleanString(item.color || ''),
                    grade: cleanString(item.grade || '')
                }));
                
                setProgress(70);
                log('üíæ Saving custom data...');
                customData = {
                    client: cleanedClients.filter(c => !predefinedData.client.includes(c)),
                    product: cleanedProducts.filter(p => !predefinedData.product.includes(p)),
                    design: cleanedDesigns.filter(d => !predefinedData.design.includes(d)),
                    color: cleanedColors.filter(c => !predefinedData.color.includes(c))
                };
                saveCustomData();
                
                setProgress(80);
                log('üíæ Saving print log...');
                printLog = cleanedPrintLog;
                savePrintLog();
                
                setProgress(90);
                log('‚öôÔ∏è Restoring settings...');
                
                // Restore layouts if present
                if (migrationData.layouts) {
                    if (migrationData.layouts.withHeader) {
                        layoutWithHeader = migrationData.layouts.withHeader;
                        localStorage.setItem('snehaLayout_withHeader_v3', JSON.stringify(migrationData.layouts.withHeader));
                    }
                    if (migrationData.layouts.withoutHeader) {
                        layoutWithoutHeader = migrationData.layouts.withoutHeader;
                        localStorage.setItem('snehaLayout_withoutHeader_v3', JSON.stringify(migrationData.layouts.withoutHeader));
                    }
                }
                
                // Restore roll serials
                if (migrationData.rollSerials) {
                    Object.entries(migrationData.rollSerials).forEach(([key, value]) => {
                        localStorage.setItem(key, value);
                    });
                }
                
                setProgress(100);
                log('‚úÖ Migration completed!');
                
                setTimeout(() => {
                    alert(`‚úÖ Migration Completed Successfully!\n\n` +
                          `üìä Summary:\n` +
                          `‚Ä¢ ${cleanedClients.length} clients (${migrationStats.clientDuplicates} duplicates merged)\n` +
                          `‚Ä¢ ${cleanedProducts.length} products (${migrationStats.productDuplicates} duplicates merged)\n` +
                          `‚Ä¢ ${cleanedDesigns.length} designs (${migrationStats.designDuplicates} duplicates merged)\n` +
                          `‚Ä¢ ${cleanedColors.length} colors (${migrationStats.colorDuplicates} duplicates merged)\n` +
                          `‚Ä¢ ${cleanedPrintLog.length} labels preserved\n\n` +
                          `The page will reload to apply changes.`);
                    
                    location.reload();
                }, 500);
                
            } catch (err) {
                log('‚ùå Error: ' + err.message);
                alert('‚ùå Migration failed: ' + err.message);
            }
        }
        
        // ============================================
        // END AUTO BACKUP SYSTEM
        // ============================================
        
        function updateModeIndicator() {
            const indicator = document.getElementById('modeIndicator');
            if (showHeader) {
                indicator.innerHTML = 'üìê Editing: <strong>WITH HEADER</strong> layout';
                indicator.style.background = '#dbeafe';
                indicator.style.borderColor = '#3b82f6';
                indicator.style.color = '#1e40af';
            } else {
                indicator.innerHTML = 'üìê Editing: <strong>WITHOUT HEADER</strong> layout';
                indicator.style.background = '#fef3c7';
                indicator.style.borderColor = '#f59e0b';
                indicator.style.color = '#92400e';
            }
        }

        function resetLayout() {
            const resetOption = confirm('Reset CURRENT layout only?\n\nClick OK to reset current mode only\nClick Cancel to reset BOTH layouts');
            
            if (resetOption) {
                // Reset only current mode
                if (showHeader) {
                    localStorage.removeItem('snehaLayout_withHeader_v3');
                    localStorage.removeItem('snehaLayout_withHeader_v2');
                    localStorage.removeItem('snehaLayout_withHeader');
                    layoutWithHeader = { elements: {} };
                } else {
                    localStorage.removeItem('snehaLayout_withoutHeader_v3');
                    localStorage.removeItem('snehaLayout_withoutHeader_v2');
                    localStorage.removeItem('snehaLayout_withoutHeader');
                    layoutWithoutHeader = { elements: {} };
                }
                location.reload();
            } else {
                // Reset both
                localStorage.removeItem('snehaLayout_withHeader_v3');
                localStorage.removeItem('snehaLayout_withHeader_v2');
                localStorage.removeItem('snehaLayout_withHeader');
                localStorage.removeItem('snehaLayout_withoutHeader_v3');
                localStorage.removeItem('snehaLayout_withoutHeader_v2');
                localStorage.removeItem('snehaLayout_withoutHeader');
                localStorage.removeItem('snehaLayout_unified');
                localStorage.removeItem('snehaLayout_mode');
                layoutWithHeader = { elements: {} };
                layoutWithoutHeader = { elements: {} };
                location.reload();
            }
        }

        /**
         * üî• FIREBASE-FIRST: Sync print log from Firebase
         * Called on startup to ensure all labels are visible across devices
         */
        async function syncPrintLogFromFirebase() {
            if (!firebaseMigrated || !firebaseReady) return;
            
            console.log('üî• Syncing print log from Firebase...');
            
            try {
                const firebaseLabels = await SnehaFirebase.getAllLabels();
                
                if (firebaseLabels && firebaseLabels.length > 0) {
                    // Create a map of local labels by rollNo+id for quick lookup
                    const localMap = new Map();
                    printLog.forEach(item => {
                        const key = `${item.rollNo}_${item.id || item.timestamp}`;
                        localMap.set(key, item);
                    });
                    
                    // Add Firebase labels that don't exist locally
                    let addedCount = 0;
                    firebaseLabels.forEach(label => {
                        const key = `${label.rollNo}_${label.id || label.timestamp}`;
                        if (!localMap.has(key)) {
                            printLog.push(label);
                            addedCount++;
                        }
                    });
                    
                    if (addedCount > 0) {
                        // Sort by timestamp
                        printLog.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        savePrintLog();
                        console.log(`üî• Synced ${addedCount} labels from Firebase`);
                    } else {
                        console.log('üî• Print log already in sync with Firebase');
                    }
                }
            } catch (error) {
                console.error('Error syncing print log from Firebase:', error);
            }
        }

        // ============ v28: CLOUD RECOVERY ============
        async function recoverAllFromFirebase() {
            if (!firebaseReady || !firebaseMigrated) {
                alert('Cloud recovery requires Firebase to be connected and migrated.\n\nCheck your internet connection and ensure Cloud Sync has been set up.');
                return;
            }

            if (!confirm('CLOUD DATA RECOVERY\n\n' +
                'This will replace ALL local data with the cloud (Firestore) version:\n\n' +
                '- All print labels/records\n' +
                '- All custom dropdown values\n' +
                '- All layout settings\n' +
                '- Roll number sequences\n\n' +
                'A backup file will be auto-downloaded after recovery.\n\n' +
                'Continue with cloud recovery?')) {
                return;
            }

            const progressEl = document.getElementById('autoBackupStatus');
            const setProgress = (msg) => {
                if (progressEl) {
                    progressEl.innerHTML = '&#9203; Recovery: <strong>' + msg + '</strong>';
                    progressEl.style.background = '#dbeafe';
                    progressEl.style.borderColor = '#93c5fd';
                    progressEl.style.color = '#1e40af';
                }
                console.log('Recovery:', msg);
            };

            try {
                setProgress('Fetching labels from Firestore...');

                // 1. Recover ALL labels
                const firebaseLabels = await SnehaFirebase.getAllLabels();
                if (firebaseLabels && firebaseLabels.length > 0) {
                    printLog = firebaseLabels.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    savePrintLog();
                    setProgress('Recovered ' + printLog.length + ' labels. Fetching masters...');
                } else {
                    setProgress('No labels in Firestore. Fetching masters...');
                }

                // 2. Recover masters (custom, inactive, deleted)
                const masterTypes = ['client', 'product', 'design', 'color'];
                const recoveredCustom = { client: [], product: [], design: [], color: [] };
                const recoveredInactive = { client: [], product: [], design: [], color: [] };
                const recoveredDeleted = { client: [], product: [], design: [], color: [] };

                // Get predefined names for comparison
                const predefinedNames = {};
                masterTypes.forEach(type => {
                    predefinedNames[type] = new Set((predefinedData[type] || []).map(n => n.toUpperCase()));
                });

                for (const type of masterTypes) {
                    const masters = await SnehaFirebase.getMasters(type);
                    if (masters && masters.length > 0) {
                        masters.forEach(master => {
                            const name = (master.name || '').toUpperCase();
                            if (!name) return;

                            if (master.status === 'deleted') {
                                recoveredDeleted[type].push(name);
                            } else if (master.status === 'inactive') {
                                recoveredInactive[type].push(name);
                                // Also add to custom if not predefined
                                if (master.source === 'custom' && !predefinedNames[type].has(name)) {
                                    recoveredCustom[type].push(name);
                                }
                            } else {
                                // Active
                                if (master.source === 'custom' && !predefinedNames[type].has(name)) {
                                    recoveredCustom[type].push(name);
                                }
                            }
                        });
                    }
                }

                // Save recovered masters
                customData = recoveredCustom;
                inactiveMasters = recoveredInactive;
                deletedMasters = recoveredDeleted;

                masterTypes.forEach(type => {
                    localStorage.setItem('snehaCustom_' + type, JSON.stringify(customData[type]));
                });
                localStorage.setItem('snehaInactiveMasters', JSON.stringify(inactiveMasters));
                localStorage.setItem('snehaDeletedMasters', JSON.stringify(deletedMasters));

                setProgress('Masters recovered. Fetching layouts...');

                // 3. Recover layouts
                const withHeaderLayout = await SnehaFirebase.getLayout('withHeader');
                if (withHeaderLayout) {
                    layoutWithHeader = withHeaderLayout;
                    localStorage.setItem('snehaLayout_withHeader_v3', JSON.stringify(withHeaderLayout));
                }

                const withoutHeaderLayout = await SnehaFirebase.getLayout('withoutHeader');
                if (withoutHeaderLayout) {
                    layoutWithoutHeader = withoutHeaderLayout;
                    localStorage.setItem('snehaLayout_withoutHeader_v3', JSON.stringify(withoutHeaderLayout));
                }

                setProgress('Layouts recovered. Syncing sequences...');

                // 4. Recover sequences
                await syncSequenceFromFirebase();

                setProgress('Recovery complete! Generating backup file...');

                // 5. Auto-download a backup of the recovered data
                createFullBackup();

                // Summary
                const customCount = masterTypes.reduce((sum, t) => sum + recoveredCustom[t].length, 0);
                const inactiveCount = masterTypes.reduce((sum, t) => sum + recoveredInactive[t].length, 0);
                const deletedCount = masterTypes.reduce((sum, t) => sum + recoveredDeleted[t].length, 0);

                if (progressEl) {
                    progressEl.innerHTML = '&#9989; Recovery: <strong>Complete</strong>';
                    progressEl.style.background = '#f0fdf4';
                    progressEl.style.borderColor = '#86efac';
                    progressEl.style.color = '#166534';
                }

                alert('CLOUD RECOVERY COMPLETE!\n\n' +
                    'Recovered:\n' +
                    '- ' + printLog.length + ' print records\n' +
                    '- ' + customCount + ' custom master values\n' +
                    '- ' + inactiveCount + ' inactive masters\n' +
                    '- ' + deletedCount + ' deleted masters\n' +
                    '- Layout settings (both modes)\n' +
                    '- Roll number sequences\n\n' +
                    'A backup file has been downloaded.\n' +
                    'The page will now reload.');

                location.reload();

            } catch (error) {
                console.error('Cloud recovery failed:', error);
                if (progressEl) {
                    progressEl.innerHTML = '&#10060; Recovery: <strong>Failed</strong> - ' + error.message;
                    progressEl.style.background = '#fef2f2';
                    progressEl.style.borderColor = '#fecaca';
                    progressEl.style.color = '#dc2626';
                }
                alert('Cloud recovery failed: ' + error.message + '\n\nPlease check your internet connection and try again.');
            }
        }
        // ============ PUSH LOCAL DATA TO CLOUD ============
        async function pushLocalToFirebase() {
            if (!firebaseReady || !firebaseMigrated) {
                alert('Firebase must be connected and migrated to push data.\n\nCheck your internet connection.');
                return;
            }

            if (!confirm('PUSH LOCAL DATA TO CLOUD\n\n' +
                'This will upload all ' + printLog.length + ' local labels to Firestore.\n' +
                'Existing cloud records will be preserved (merge, not replace).\n\n' +
                'This fills any gaps where data exists locally but not in the cloud.\n\n' +
                'Continue?')) {
                return;
            }

            const progressEl = document.getElementById('autoBackupStatus');
            const setProgress = (msg) => {
                if (progressEl) {
                    progressEl.innerHTML = '&#9203; Push: <strong>' + msg + '</strong>';
                    progressEl.style.background = '#dbeafe';
                    progressEl.style.borderColor = '#93c5fd';
                    progressEl.style.color = '#1e40af';
                }
                console.log('Push to Cloud:', msg);
            };

            try {
                setProgress('Uploading labels to Firestore...');

                const batchSize = 500;
                let uploadedCount = 0;
                let skippedCount = 0;

                for (let i = 0; i < printLog.length; i += batchSize) {
                    const batch = firebaseDb.batch();
                    const chunk = printLog.slice(i, i + batchSize);

                    for (const label of chunk) {
                        if (!label.rollNo || !label.id) {
                            skippedCount++;
                            continue;
                        }
                        const docId = (label.rollNo + '_' + label.id).replace(/[\/\.]/g, '_');
                        const ref = firebaseDb.collection('labels').doc(docId);
                        batch.set(ref, {
                            ...label,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                        uploadedCount++;
                    }

                    await batch.commit();
                    setProgress('Uploaded ' + Math.min(i + batchSize, printLog.length) + '/' + printLog.length + ' labels...');
                }

                setProgress('Labels done. Syncing sequences...');
                await syncSequenceFromFirebase();

                if (progressEl) {
                    progressEl.innerHTML = '&#9989; Push: <strong>Complete</strong> - ' + uploadedCount + ' labels uploaded';
                    progressEl.style.background = '#f0fdf4';
                    progressEl.style.borderColor = '#86efac';
                    progressEl.style.color = '#166534';
                }

                alert('PUSH TO CLOUD COMPLETE!\n\n' +
                    'Uploaded: ' + uploadedCount + ' labels\n' +
                    'Skipped: ' + skippedCount + ' (missing ID/rollNo)\n\n' +
                    'Firebase cloud is now in sync with local data.');

            } catch (error) {
                console.error('Push to cloud failed:', error);
                if (progressEl) {
                    progressEl.innerHTML = '&#10060; Push: <strong>Failed</strong> - ' + error.message;
                    progressEl.style.background = '#fef2f2';
                    progressEl.style.borderColor = '#fecaca';
                    progressEl.style.color = '#dc2626';
                }
                alert('Push to cloud failed: ' + error.message);
            }
        }
        // ============ END PUSH LOCAL TO CLOUD ============

        // ============ END CLOUD RECOVERY ============

        // Print Log Functions
        function loadPrintLog() {
            const saved = localStorage.getItem('snehaPrintLog');
            printLog = saved ? JSON.parse(saved) : [];
            
            // Normalize existing data to UPPERCASE (migration)
            let needsSave = false;
            printLog.forEach(item => {
                if (item.client && item.client !== item.client.toUpperCase()) {
                    item.client = item.client.toUpperCase();
                    needsSave = true;
                }
                if (item.product && item.product !== item.product.toUpperCase()) {
                    item.product = item.product.toUpperCase();
                    needsSave = true;
                }
                if (item.design && item.design !== item.design.toUpperCase()) {
                    item.design = item.design.toUpperCase();
                    needsSave = true;
                }
                if (item.color && item.color !== item.color.toUpperCase()) {
                    item.color = item.color.toUpperCase();
                    needsSave = true;
                }
                if (item.grade && item.grade !== item.grade.toUpperCase()) {
                    item.grade = item.grade.toUpperCase();
                    needsSave = true;
                }
            });
            
            // Save if migration was needed
            if (needsSave) {
                savePrintLog();
                console.log('Print log migrated to UPPERCASE');
            }
        }

        function savePrintLog() {
            try {
                localStorage.setItem('snehaPrintLog', JSON.stringify(printLog));
            } catch (e) {
                if (e.name === 'QuotaExceededError' || e.code === 22 || e.code === 1014) {
                    // v28: No more auto-backup cleanup needed - localStorage is now lean
                    console.error('localStorage quota exceeded:', e);
                    logError('Storage', 'SavePrintLog', 'localStorage full: ' + e.message, 'CRITICAL');
                    showToast('Local storage full! Data is safe in Firestore cloud. Take a manual backup.', 'error');
                } else {
                    console.error('savePrintLog error:', e);
                    logError('Storage', 'SavePrintLog', e.message, 'ERROR');
                }
            }
        }

        /**
         * Clean up old auto-backup entries from localStorage
         * Each daily backup contains the FULL printLog, so keeping 3 is more than enough
         * @param {number} keepDays - Number of recent backups to keep (0 = remove all)
         * @returns {number} Number of backups removed
         */
        function cleanupOldAutoBackups(keepDays = 3) {
            const allKeys = Object.keys(localStorage);
            const backupKeys = allKeys.filter(k => k.startsWith('snehaAutoBackup_')).sort();

            if (backupKeys.length === 0) return 0;
            if (backupKeys.length <= keepDays) return 0;

            // Keys sort chronologically (snehaAutoBackup_YYYY-MM-DD)
            // Remove oldest, keep most recent 'keepDays'
            const toRemove = keepDays > 0 ? backupKeys.slice(0, backupKeys.length - keepDays) : backupKeys;

            let freedBytes = 0;
            toRemove.forEach(key => {
                const val = localStorage.getItem(key);
                if (val) freedBytes += val.length * 2; // rough byte estimate (UTF-16)
                localStorage.removeItem(key);
            });

            const freedMB = (freedBytes / (1024 * 1024)).toFixed(2);
            console.log(`üßπ Cleaned ${toRemove.length} old auto-backups, freed ~${freedMB}MB`);

            if (toRemove.length > 0) {
                logInfo('Storage', 'Cleanup', `Removed ${toRemove.length} old auto-backups, freed ~${freedMB}MB`);
            }

            return toRemove.length;
        }

        function addToLog(data) {
            // Ensure UPPERCASE for all text fields
            const normalizedData = {
                ...data,
                client: (data.client || '').toUpperCase(),
                product: (data.product || '').toUpperCase(),
                design: (data.design || '').toUpperCase(),
                color: (data.color || '').toUpperCase(),
                grade: (data.grade || '').toUpperCase()
            };

            // v29: Duplicate roll number check
            const rollNo = String(normalizedData.rollNo || '');
            if (rollNo) {
                const duplicate = printLog.find(entry => String(entry.rollNo) === rollNo);
                if (duplicate) {
                    alert(`Duplicate Roll Number!\n\nRoll No ${rollNo} already exists in the log.\nDate: ${duplicate.date}\nProduct: ${duplicate.product || '-'}\n\nThis entry will NOT be saved.`);
                    return false;
                }
            }

            // üî• FIX: Include system_id for proper filtering across devices
            const systemNum = document.getElementById('systemSelect').value || '1';

            const logEntry = {
                id: Date.now().toString(), // Unique ID for each entry
                timestamp: new Date().toISOString(),
                date: new Date().toISOString().split('T')[0],
                system_id: systemNum, // üî• CRITICAL: Store system explicitly
                ...normalizedData
            };

            printLog.push(logEntry);
            savePrintLog();
            updateLogDisplay();
            
            // üî• Sync to Firebase if migrated (v27)
            if (firebaseMigrated && firebaseReady) {
                SnehaFirebase.addLabel(logEntry).catch(err => {
                    console.warn('Firebase label sync error:', err);
                });
            }
            return true;
        }

        function getSelectedDate() {
            const datePicker = document.getElementById('logDatePicker');
            return datePicker.value || new Date().toISOString().split('T')[0];
        }
        
        function getLogForDate(date) {
            return printLog.filter(item => item.date === date);
        }
        
        function getTodayLog() {
            // For backward compatibility, this now returns log for selected date
            return getLogForDate(getSelectedDate());
        }

        function updateLogDisplay() {
            // Initialize date picker to today if not set
            const datePicker = document.getElementById('logDatePicker');
            if (!datePicker.value) {
                datePicker.value = new Date().toISOString().split('T')[0];
            }
            
            const selectedDate = getSelectedDate();
            const dateLog = getLogForDate(selectedDate);
            
            // Update stats
            document.getElementById('todayCount').textContent = dateLog.length;
            document.getElementById('todayMeters').textContent = dateLog.reduce((sum, item) => sum + (parseFloat(item.meters) || 0), 0).toFixed(1);
            document.getElementById('todayRolls').textContent = dateLog.length;
            document.getElementById('todayWeight').textContent = dateLog.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0).toFixed(1);

            // Update log list with PAGINATION
            const logList = document.getElementById('logList');
            if (dateLog.length === 0) {
                const displayDate = new Date(selectedDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                logList.innerHTML = `<div style="padding: 20px; text-align: center; color: #888;">No prints logged for ${displayDate}</div>`;
                return;
            }

            // Pagination settings
            const itemsPerPage = 20;
            const currentPage = window.logCurrentPage || 1;
            const totalPages = Math.ceil(dateLog.length / itemsPerPage);
            
            // Ensure current page is valid
            if (currentPage > totalPages) window.logCurrentPage = totalPages;
            if (currentPage < 1) window.logCurrentPage = 1;
            
            // Get items for current page (reversed for newest first)
            const reversedLog = dateLog.slice().reverse();
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageItems = reversedLog.slice(startIdx, endIdx);

            let html = '';
            
            // Pagination controls (top)
            if (totalPages > 1) {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f1f5f9; border-radius: 6px; margin-bottom: 10px;">
                        <button onclick="changeLogPage(-1)" ${currentPage === 1 ? 'disabled' : ''} style="padding: 4px 10px; font-size: 11px; border: 1px solid #cbd5e1; border-radius: 4px; cursor: pointer; ${currentPage === 1 ? 'opacity: 0.5;' : ''}">‚óÄ Prev</button>
                        <span style="font-size: 11px; color: #475569;">Page ${currentPage} of ${totalPages} (${dateLog.length} labels)</span>
                        <button onclick="changeLogPage(1)" ${currentPage === totalPages ? 'disabled' : ''} style="padding: 4px 10px; font-size: 11px; border: 1px solid #cbd5e1; border-radius: 4px; cursor: pointer; ${currentPage === totalPages ? 'opacity: 0.5;' : ''}">Next ‚ñ∂</button>
                    </div>
                `;
            }
            
            // Log items
            pageItems.forEach((item, idx) => {
                const time = new Date(item.timestamp).toLocaleTimeString();
                const actualIndex = dateLog.length - 1 - (startIdx + idx); // calculate correct index
                const isReject = item.isReject ? 'üö´' : '';
                const bitsDisplay = item.bits ? ` (${item.bits})` : '';
                const reeditInfo = item.reeditCount ? `<span style="color: #f59e0b; font-size: 9px; margin-left: 5px;">‚úèÔ∏è${item.reeditCount}</span>` : '';
                
                html += `
                    <div class="log-item" style="cursor: pointer;" onclick="previewLogItemByDate('${selectedDate}', ${actualIndex})">
                        <div class="time">${time} ${isReject}${reeditInfo}</div>
                        <div class="details">
                            <span class="product">${item.product || '-'}</span>
                            <span class="meta">${item.rollNo || '-'} | ${item.meters || 0}m${bitsDisplay} | ${item.grade || '-'}</span>
                        </div>
                        <div style="display: flex; gap: 5px; margin-top: 5px;">
                            <button onclick="event.stopPropagation(); previewLogItemByDate('${selectedDate}', ${actualIndex})" style="padding: 3px 8px; font-size: 11px; background: #3b82f6; color: white; border: none; border-radius: 3px; cursor: pointer;">üëÅÔ∏è Preview</button>
                            <button onclick="event.stopPropagation(); editLogItemByDate('${selectedDate}', ${actualIndex})" style="padding: 3px 8px; font-size: 11px; background: #f59e0b; color: white; border: none; border-radius: 3px; cursor: pointer;">‚úèÔ∏è Edit</button>
                            <button onclick="event.stopPropagation(); reprintLogItemByDate('${selectedDate}', ${actualIndex})" style="padding: 3px 8px; font-size: 11px; background: #10b981; color: white; border: none; border-radius: 3px; cursor: pointer;">üñ®Ô∏è Reprint</button>
                            <button onclick="event.stopPropagation(); deleteLogEntry('${selectedDate}', ${actualIndex})" style="padding: 3px 8px; font-size: 11px; background: #dc2626; color: white; border: none; border-radius: 3px; cursor: pointer;">&#128465; Delete</button>
                        </div>
                    </div>
                `;
            });
            
            // Pagination controls (bottom)
            if (totalPages > 1) {
                html += `
                    <div style="display: flex; justify-content: center; align-items: center; padding: 10px; gap: 5px; flex-wrap: wrap;">
                        <button onclick="goToLogPage(1)" ${currentPage === 1 ? 'disabled' : ''} style="padding: 4px 8px; font-size: 10px; border: 1px solid #cbd5e1; border-radius: 4px; cursor: pointer;">First</button>
                        ${generatePageButtons(currentPage, totalPages)}
                        <button onclick="goToLogPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''} style="padding: 4px 8px; font-size: 10px; border: 1px solid #cbd5e1; border-radius: 4px; cursor: pointer;">Last</button>
                    </div>
                `;
            }
            
            logList.innerHTML = html;
        }
        
        // Pagination helper functions
        window.logCurrentPage = 1;
        
        function changeLogPage(delta) {
            window.logCurrentPage = (window.logCurrentPage || 1) + delta;
            updateLogDisplay();
        }
        
        function goToLogPage(page) {
            window.logCurrentPage = page;
            updateLogDisplay();
        }
        
        function generatePageButtons(current, total) {
            let buttons = '';
            const maxButtons = 5;
            let start = Math.max(1, current - Math.floor(maxButtons / 2));
            let end = Math.min(total, start + maxButtons - 1);
            
            if (end - start < maxButtons - 1) {
                start = Math.max(1, end - maxButtons + 1);
            }
            
            for (let i = start; i <= end; i++) {
                const isActive = i === current;
                buttons += `<button onclick="goToLogPage(${i})" style="padding: 4px 8px; font-size: 10px; border: 1px solid ${isActive ? '#3b82f6' : '#cbd5e1'}; border-radius: 4px; cursor: pointer; ${isActive ? 'background: #3b82f6; color: white;' : ''}">${i}</button>`;
            }
            return buttons;
        }
        
        function previewLogItem(index) {
            // For backward compatibility
            previewLogItemByDate(getSelectedDate(), index);
        }
        
        function previewLogItemByDate(date, index) {
            const dateLog = getLogForDate(date);
            const item = dateLog[index];
            if (!item) return;
            
            // Store current values
            const currentValues = {
                client: document.getElementById('clientInput').value,
                product: document.getElementById('productInput').value,
                design: document.getElementById('designInput').value,
                color: document.getElementById('colorInput').value,
                grade: document.getElementById('gradeInput').value,
                meters: document.getElementById('metersInput').value,
                bits: document.getElementById('bitsInput').value,
                weight: document.getElementById('weightInput').value,
                rollNo: document.getElementById('rollNoInput').value
            };
            
            // Set values from log item
            document.getElementById('clientInput').value = item.client || '';
            document.getElementById('productInput').value = item.product || '';
            document.getElementById('designInput').value = item.design || '';
            document.getElementById('colorInput').value = item.color || '';
            document.getElementById('gradeInput').value = item.grade || '';
            document.getElementById('metersInput').value = item.meters || '';
            document.getElementById('bitsInput').value = item.bits || '';
            document.getElementById('weightInput').value = item.weight || '';
            document.getElementById('rollNoInput').value = item.rollNo || '';
            toggleBitsField();
            updateLabelText();
            
            // Show preview info
            const time = new Date(item.timestamp).toLocaleTimeString();
            const printDate = new Date(item.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            const isReject = item.isReject ? ' (REJECT)' : '';
            const bitsInfo = item.bits ? `\nBits: ${item.bits}` : '';
            
            alert(`üìã Previewing Label${isReject}\n\nRoll No: ${item.rollNo}\nClient: ${item.client}\nProduct: ${item.product}\nDesign: ${item.design}\nColor: ${item.color}\nGrade: ${item.grade || 'N/A'}\nMeters: ${item.meters}${bitsInfo}\nWeight: ${item.weight || 'N/A'}\n\nPrint Date: ${printDate}\nTime: ${time}\n\nüí° The label is now displayed in the preview area.\nClick "Edit" to modify, or "Reprint" to print again.`);
            
            // Store the current preview item for reprint/edit
            window.currentPreviewItem = item;
            window.currentPreviewIndex = index;
            window.currentPreviewDate = date;
            window.previousValues = currentValues;
        }
        
        // Edit existing log item - OVERWRITES, no duplicate
        function editLogItemByDate(date, index) {
            const dateLog = getLogForDate(date);
            const item = dateLog[index];
            if (!item) return;
            
            // Find actual index in printLog
            const actualIndex = printLog.findIndex(p => p.timestamp === item.timestamp && p.rollNo === item.rollNo);
            
            // Set values from log item for editing
            document.getElementById('clientInput').value = item.client || '';
            document.getElementById('productInput').value = item.product || '';
            document.getElementById('designInput').value = item.design || '';
            document.getElementById('colorInput').value = item.color || '';
            document.getElementById('gradeInput').value = item.grade || '';
            document.getElementById('metersInput').value = item.meters || '';
            document.getElementById('bitsInput').value = item.bits || '';
            document.getElementById('weightInput').value = item.weight || '';
            document.getElementById('rollNoInput').value = item.rollNo || '';
            toggleBitsField();
            updateLabelText();
            
            // Set edit mode - this will overwrite the existing record
            window.editMode = true;
            window.editIndex = actualIndex;
            window.editRollNo = item.rollNo;

            // v29: Highlight roll number field during edit (editable for corrections)
            const rollNoField = document.getElementById('rollNoInput');
            rollNoField.style.background = '#fef3c7';
            rollNoField.style.border = '2px solid #f59e0b';

            // Show Edit Mode indicator - buttons stacked vertically
            const editIndicator = document.createElement('div');
            editIndicator.id = 'editModeIndicator';
            editIndicator.innerHTML = `
                <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 15px; text-align: center;">
                    <div style="font-weight: 700; color: #92400e; font-size: 14px;">‚úèÔ∏è EDIT MODE</div>
                    <div style="font-size: 11px; color: #92400e; margin-top: 5px;">Roll No: ${item.rollNo} - Changes will OVERWRITE this label</div>
                    <div style="margin-top: 10px; display: flex; flex-direction: column; gap: 8px;">
                        <button onclick="saveEditedLabel()" style="background: #059669; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 5px;">üíæ Save Changes</button>
                        <button onclick="cancelEdit()" style="background: #dc2626; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 5px;">‚ùå Cancel</button>
                    </div>
                </div>
            `;
            
            // Remove any existing indicator
            const existing = document.getElementById('editModeIndicator');
            if (existing) existing.remove();
            
            // Insert at top of left panel
            const panel = document.querySelector('.panel');
            panel.insertBefore(editIndicator, panel.querySelector('.form-group'));
            
            // Switch to Print tab
            switchTab('print');
            
            alert(`‚úèÔ∏è EDIT MODE ACTIVATED\n\nEditing Roll No: ${item.rollNo}\n\nMake your changes and click "Save Changes".\nThe original record will be OVERWRITTEN (no duplicate).\n\nRoll number will remain the same.`);
        }
        
        function saveEditedLabel() {
            if (!window.editMode || window.editIndex === undefined) {
                alert('No label being edited');
                return;
            }
            
            const originalRecord = printLog[window.editIndex];
            
            // Get updated values (UPPERCASE enforced)
            const updatedData = {
                system: document.getElementById('systemSelect').value,
                client: document.getElementById('clientInput').value.toUpperCase(),
                product: document.getElementById('productInput').value.toUpperCase(),
                design: document.getElementById('designInput').value.toUpperCase(),
                color: document.getElementById('colorInput').value.toUpperCase(),
                grade: document.getElementById('gradeInput').value.toUpperCase(),
                rollNo: document.getElementById('rollNoInput').value || window.editRollNo, // Use form value (user may correct it)
                meters: document.getElementById('metersInput').value,
                bits: document.getElementById('bitsInput').value,
                weight: document.getElementById('weightInput').value,
                copies: originalRecord.copies || 1,
                isReject: originalRecord.isReject || false,
                timestamp: originalRecord.timestamp, // Keep original timestamp
                date: originalRecord.date, // Keep original date
                // üìä RE-EDIT TRACKING
                reeditCount: (originalRecord.reeditCount || 0) + 1,
                lastReeditDate: new Date().toISOString(),
                // v29: Preserve fields critical for Firebase docId matching
                id: originalRecord.id,
                system_id: originalRecord.system_id || document.getElementById('systemSelect').value
            };

            // OVERWRITE the existing record
            printLog[window.editIndex] = updatedData;
            savePrintLog();
            updateLogDisplay();

            // v29: Sync updated record to Firebase (prevents duplicates on cross-device sync)
            if (firebaseMigrated && firebaseReady && updatedData.id) {
                // If rollNo changed, delete the OLD Firebase document first (prevents ghost records)
                const oldRollNo = window.editRollNo;
                if (oldRollNo && updatedData.rollNo !== oldRollNo) {
                    SnehaFirebase.deleteLabel(oldRollNo, updatedData.id).catch(err => {
                        console.warn('Firebase old doc delete error:', err);
                    });
                }
                SnehaFirebase.updateLabel(updatedData).catch(err => {
                    console.warn('Firebase edit sync error:', err);
                });
            }

            // Exit edit mode (store rollNo before cancelEdit clears it)
            const savedRollNo = updatedData.rollNo;
            cancelEdit();

            alert(`‚úÖ Label UPDATED successfully!\n\nRoll No: ${savedRollNo}\nRe-edit Count: ${updatedData.reeditCount}\n\nThe record has been overwritten.\nNo duplicate was created.`);
        }
        
        function cancelEdit() {
            window.editMode = false;
            window.editIndex = undefined;
            window.editRollNo = undefined;

            // v29: Unlock roll number field
            const rollNoField = document.getElementById('rollNoInput');
            rollNoField.style.background = '';
            rollNoField.style.border = '';

            // Remove edit indicator
            const indicator = document.getElementById('editModeIndicator');
            if (indicator) indicator.remove();
            
            // Clear form
            clearForm();
        }
        
        function clearForm() {
            document.getElementById('clientInput').value = '';
            document.getElementById('productInput').value = '';
            document.getElementById('designInput').value = '';
            document.getElementById('colorInput').value = '';
            document.getElementById('gradeInput').value = '';
            document.getElementById('metersInput').value = '';
            document.getElementById('bitsInput').value = '';
            document.getElementById('weightInput').value = '';
            document.getElementById('rollNoInput').value = '';
            toggleBitsField();
            updateLabelText();
            generateRollNumber();
        }
        
        async function reprintLogItem(index) {
            // For backward compatibility
            await reprintLogItemByDate(getSelectedDate(), index);
        }
        
        async function reprintLogItemByDate(date, index) {
            const dateLog = getLogForDate(date);
            const item = dateLog[index];
            if (!item) return;
            
            if (!qzConnected || !selectedPrinter) {
                alert('Please connect and select a printer first');
                return;
            }
            
            if (!confirm(`üñ®Ô∏è Reprint this label?\n\nRoll No: ${item.rollNo}\nProduct: ${item.product}\nColor: ${item.color}\nMeters: ${item.meters}m\n\nThis will NOT create a new log entry.`)) {
                return;
            }
            
            // Store current values
            const currentValues = {
                client: document.getElementById('clientInput').value,
                product: document.getElementById('productInput').value,
                design: document.getElementById('designInput').value,
                color: document.getElementById('colorInput').value,
                grade: document.getElementById('gradeInput').value,
                meters: document.getElementById('metersInput').value,
                weight: document.getElementById('weightInput').value,
                rollNo: document.getElementById('rollNoInput').value,
                qty: document.getElementById('qtyInput').value
            };
            
            // Set values from log item
            document.getElementById('clientInput').value = item.client || '';
            document.getElementById('productInput').value = item.product || '';
            document.getElementById('designInput').value = item.design || '';
            document.getElementById('colorInput').value = item.color || '';
            document.getElementById('gradeInput').value = item.grade || '';
            document.getElementById('metersInput').value = item.meters || '';
            document.getElementById('weightInput').value = item.weight || '';
            document.getElementById('rollNoInput').value = item.rollNo || '';
            document.getElementById('qtyInput').value = '1';
            updateLabelText();
            
            // Print with skipLog=true and skipIncrement=true
            await printLabel(true, true);
            
            alert(`‚úÖ Reprinted: ${item.rollNo}`);
            
            // Restore original values
            document.getElementById('clientInput').value = currentValues.client;
            document.getElementById('productInput').value = currentValues.product;
            document.getElementById('designInput').value = currentValues.design;
            document.getElementById('colorInput').value = currentValues.color;
            document.getElementById('gradeInput').value = currentValues.grade;
            document.getElementById('metersInput').value = currentValues.meters;
            document.getElementById('weightInput').value = currentValues.weight;
            document.getElementById('rollNoInput').value = currentValues.rollNo;
            document.getElementById('qtyInput').value = currentValues.qty;
            updateLabelText();
        }

        function clearTodayLog() {
            // For backward compatibility
            clearSelectedDateLog();
        }
        
        function clearSelectedDateLog() {
            const selectedDate = getSelectedDate();
            const displayDate = new Date(selectedDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            
            if (confirm(`Clear log for ${displayDate}?`)) {
                printLog = printLog.filter(item => item.date !== selectedDate);
                savePrintLog();
                updateLogDisplay();
            }
        }

        // v29: Delete individual label from log
        async function deleteLogEntry(date, index) {
            const dateLog = getLogForDate(date);
            const item = dateLog[index];
            if (!item) return;

            if (!confirm('Delete this label?\n\n' +
                'Roll No: ' + (item.rollNo || '-') + '\n' +
                'Product: ' + (item.product || '-') + '\n' +
                'Color: ' + (item.color || '-') + '\n' +
                'Meters: ' + (item.meters || 0) + 'm\n\n' +
                'This will permanently remove this entry.\nThe roll number will NOT be reused.')) {
                return;
            }

            // Find actual index in printLog array
            const actualIndex = printLog.findIndex(p => p.timestamp === item.timestamp && p.rollNo === item.rollNo);
            if (actualIndex === -1) {
                alert('Error: Could not find this entry in the log.');
                return;
            }

            const removed = printLog.splice(actualIndex, 1)[0];
            savePrintLog();
            updateLogDisplay();

            // Delete from Firebase
            if (firebaseMigrated && firebaseReady && removed.rollNo) {
                const entryId = removed.id || removed.timestamp;
                SnehaFirebase.deleteLabel(removed.rollNo, entryId).catch(err => {
                    console.warn('Firebase delete error:', err);
                });
            }

            showToast('Label deleted successfully', 'info');
        }

        function exportLogCSV() {
            const dateLog = getLogForDate(getSelectedDate());
            if (dateLog.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = ['Time', 'Client', 'Product', 'Design', 'Color', 'Grade', 'Roll No', 'Meters', 'Weight'];
            const rows = dateLog.map(item => [
                new Date(item.timestamp).toLocaleTimeString(),
                item.client || '',
                item.product || '',
                item.design || '',
                item.color || '',
                item.grade || '',
                item.rollNo || '',
                item.meters || '',
                item.weight || ''
            ]);

            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `print-log-${getSelectedDate()}.csv`;
            a.click();
        }

        // QZ Tray
        async function connectQZ() {
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('connectBtn').textContent = '‚è≥ Connecting...';

            try {
                // ‚úÖ Check if QZ Tray library loaded
                if (typeof qz === 'undefined') {
                    throw new TypeError('QZ Tray library not loaded. Please refresh the page or check your internet connection.');
                }

                if (!qz.websocket.isActive()) await qz.websocket.connect();
                qzConnected = true;
                document.getElementById('qzStatus').className = 'status connected';
                document.getElementById('qzStatus').textContent = 'üü¢ Connected';
                
                const printers = await qz.printers.find();
                const labelSelect = document.getElementById('printerSelect');
                const dotMatrixSelect = document.getElementById('dotMatrixSelect');
                
                labelSelect.innerHTML = '<option value="">-- Select --</option>';
                dotMatrixSelect.innerHTML = '<option value="">-- Select --</option>';
                
                printers.forEach(p => {
                    // Label printer dropdown
                    const opt1 = document.createElement('option');
                    opt1.value = p; opt1.textContent = p;
                    if (p.toLowerCase().includes('xp') || p.toLowerCase().includes('426')) {
                        opt1.selected = true; selectedPrinter = p;
                    }
                    labelSelect.appendChild(opt1);

                    // Dot matrix dropdown
                    const opt2 = document.createElement('option');
                    opt2.value = p; opt2.textContent = p;
                    if (p.toLowerCase().includes('epson') || p.toLowerCase().includes('lq') || p.toLowerCase().includes('dot')) {
                        opt2.selected = true;
                    }
                    dotMatrixSelect.appendChild(opt2);
                });
                
                document.getElementById('printBtn').disabled = false;
            } catch(err) {
                console.error('QZ Tray connection error:', err);
                document.getElementById('qzStatus').className = 'status disconnected';
                document.getElementById('qzStatus').textContent = 'üî¥ Failed - ' + (err.message || 'Is QZ Tray running?');
            }

            document.getElementById('connectBtn').disabled = false;
            document.getElementById('connectBtn').textContent = qzConnected ? '‚úÖ Connected' : 'üîå Connect QZ Tray';
        }

        function adjustQty(d) {
            const input = document.getElementById('qtyInput');
            input.value = Math.max(1, Math.min(100, parseInt(input.value) + d));
        }

        /**
         * Print label to thermal printer via QZ Tray
         * @param {boolean} [skipLog=false] - Skip logging to print log
         * @param {boolean} [skipIncrement=false] - Skip roll number increment
         * @returns {Promise<void>}
         */
        async function printLabel(skipLog = false, skipIncrement = false) {
            if (!qzConnected || !selectedPrinter) {
                showToast('Please connect and select a printer', 'warning');
                return;
            }

            // v29: EDIT MODE GUARD ‚Äî re-edit must NEVER increment sequence or create new record
            if (window.editMode && window.editIndex !== undefined) {
                // Save the edit FIRST (updates existing record, preserves roll number)
                // But DON'T let saveEditedLabel clear the form yet ‚Äî we need form values for printing
                const editIndex = window.editIndex;
                const editRollNo = window.editRollNo;
                const originalRecord = printLog[editIndex];

                // Build updated record (same logic as saveEditedLabel)
                // Use current form roll number (user may have corrected it)
                const currentRollNo = document.getElementById('rollNoInput').value || editRollNo;
                const updatedData = {
                    system: document.getElementById('systemSelect').value,
                    client: document.getElementById('clientInput').value.toUpperCase(),
                    product: document.getElementById('productInput').value.toUpperCase(),
                    design: document.getElementById('designInput').value.toUpperCase(),
                    color: document.getElementById('colorInput').value.toUpperCase(),
                    grade: document.getElementById('gradeInput').value.toUpperCase(),
                    rollNo: currentRollNo,
                    meters: document.getElementById('metersInput').value,
                    bits: document.getElementById('bitsInput').value,
                    weight: document.getElementById('weightInput').value,
                    copies: originalRecord.copies || 1,
                    isReject: originalRecord.isReject || false,
                    timestamp: originalRecord.timestamp,
                    date: originalRecord.date,
                    reeditCount: (originalRecord.reeditCount || 0) + 1,
                    lastReeditDate: new Date().toISOString(),
                    id: originalRecord.id,
                    system_id: originalRecord.system_id || document.getElementById('systemSelect').value
                };

                // Overwrite the existing record
                printLog[editIndex] = updatedData;
                savePrintLog();

                // Sync to Firebase
                if (firebaseMigrated && firebaseReady && updatedData.id) {
                    // If rollNo changed, delete the OLD Firebase document first (prevents ghost records)
                    if (editRollNo && updatedData.rollNo !== editRollNo) {
                        SnehaFirebase.deleteLabel(editRollNo, updatedData.id).catch(err => {
                            console.warn('Firebase old doc delete error:', err);
                        });
                    }
                    SnehaFirebase.updateLabel(updatedData).catch(err => {
                        console.warn('Firebase edit sync error:', err);
                    });
                }

                // Print with current form values (skipLog + skipIncrement ‚Äî NO new record, NO sequence change)
                window.editMode = false; // Prevent infinite recursion
                await printLabel(true, true);

                // Now clean up edit mode UI
                window.editIndex = undefined;
                window.editRollNo = undefined;
                const rollNoField = document.getElementById('rollNoInput');
                rollNoField.style.background = '';
                rollNoField.style.border = '';
                const indicator = document.getElementById('editModeIndicator');
                if (indicator) indicator.remove();

                updateLogDisplay();
                showToast(`Label ${editRollNo} updated & printed`, 'success');
                return;
            }

            // ‚úÖ DATA VALIDATION (v27.1)
            if (!skipLog) {
                const formValidation = SnehaValidation.validateCurrentForm();
                if (!formValidation.valid) {
                    const errorList = formValidation.errors.join('\n‚Ä¢ ');
                    alert('‚ö†Ô∏è VALIDATION ERROR\n\nPlease correct the following:\n\n‚Ä¢ ' + errorList);
                    return;
                }
            }
            
            // üîê MASTER LOCK VALIDATION - Check BEFORE anything else
            if (!skipLog) {
                const validation = validateFieldsAgainstMasterLock();
                if (!validation.valid) {
                    const fieldList = validation.invalidFields.map(f => `‚Ä¢ ${f.name}: "${f.value}"`).join('\n');
                    alert('üîí MASTER LOCK ENABLED\n\n' +
                          'Cannot print label with unknown values:\n\n' +
                          fieldList + '\n\n' +
                          'Please select existing values from the dropdown,\n' +
                          'or disable Master Lock to add new entries.');
                    return;
                }
                
                // Check and save new values (will be blocked if lock is ON)
                const result = checkAndSaveNewValues();
                if (result.blockedValues && result.blockedValues.length > 0) {
                    const blockedList = result.blockedValues.map(f => `‚Ä¢ ${f.type}: "${f.value}"`).join('\n');
                    alert('üîí MASTER LOCK ENABLED\n\n' +
                          'New entries are blocked:\n\n' +
                          blockedList + '\n\n' +
                          'Please select existing values from the dropdown,\n' +
                          'or disable Master Lock to add new entries.');
                    return;
                }
                
                if (result.newValues && result.newValues.length > 0) {
                    console.log('New values auto-saved:', result.newValues);
                    // Refresh dropdowns to include new values
                    ['client', 'product', 'design', 'color'].forEach(refreshDropdown);
                }
            }

            const btn = document.getElementById('printBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Printing...';

            try {
                document.querySelectorAll('.label-element').forEach(el => el.classList.remove('selected'));

                const labelCanvas = document.getElementById('labelCanvas');
                const currentTransform = labelCanvas.style.transform;
                labelCanvas.style.transform = 'none';

                const dpi = parseInt(document.getElementById('dpiSelect').value);
                const printFill = parseInt(document.getElementById('printFillSlider').value) / 100;
                
                // For 3 inch paper at the specified DPI
                // At 203 DPI: 3 inches = 609 pixels
                // Our canvas is 288px, so scale = 609/288 = 2.11
                const targetPixels = 3 * dpi;
                const finalScale = (targetPixels / 288) * printFill;

                console.log('Print settings:', { dpi, printFill, targetPixels, finalScale });

                // ‚úÖ Check if html2canvas library loaded
                if (typeof html2canvas === 'undefined') {
                    throw new TypeError('html2canvas library not loaded. Please refresh the page or check your internet connection.');
                }

                // Remove border before capture
                const originalBorder = labelCanvas.style.border;
                labelCanvas.style.border = 'none';

                const canvas = await html2canvas(labelCanvas, {
                    scale: finalScale,
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    imageTimeout: 0
                });
                
                // Restore border and transform
                labelCanvas.style.border = originalBorder;
                labelCanvas.style.transform = currentTransform;

                console.log('Captured canvas size:', canvas.width, 'x', canvas.height);

                const imageData = canvas.toDataURL('image/png');
                const copies = parseInt(document.getElementById('qtyInput').value) || 1;

                const config = qz.configs.create(selectedPrinter, {
                    size: { width: 3, height: 3 },
                    units: 'in',
                    margins: 0,
                    copies: copies,
                    density: dpi,
                    interpolation: 'nearest-neighbor',
                    scaleContent: true,
                    rasterize: false,
                    altPrinting: true
                });

                await qz.print(config, [{
                    type: 'pixel',
                    format: 'image',
                    flavor: 'base64',
                    data: imageData.split(',')[1],
                    options: { pageWidth: 3, pageHeight: 3 }
                }]);

                // v29: ATOMIC roll number ‚Äî consume fresh number BEFORE logging
                // This prevents race conditions between multiple devices
                if (!skipLog) {
                    let freshRollNo = document.getElementById('rollNoInput').value;
                    const wasManualEntry = window.manualRollEntry;

                    if (!skipIncrement) {
                        if (window.manualRollEntry) {
                            // --- MANUAL ENTRY PATH ---
                            if (!SnehaValidation.isValidRollNumber(freshRollNo)) {
                                alert('Invalid roll number format.\n\nExpected: [System 1-2][Month 01-12][Serial 5 digits]\nExample: 10200379');
                                btn.disabled = false;
                                btn.textContent = 'üñ®Ô∏è PRINT LABEL';
                                return;
                            }

                            const manualSystem = freshRollNo.charAt(0);
                            const manualMonth = freshRollNo.substring(1, 3);
                            const manualSerial = parseInt(freshRollNo.substring(3), 10);
                            const selectedSystem = document.getElementById('systemSelect').value;
                            const currentMonth = getCurrentMonth();

                            if (manualSystem !== selectedSystem) {
                                if (!confirm(`Roll number is for System ${manualSystem}, but System ${selectedSystem} is selected.\n\nContinue with System ${manualSystem}?`)) {
                                    btn.disabled = false;
                                    btn.textContent = 'üñ®Ô∏è PRINT LABEL';
                                    return;
                                }
                            }

                            if (manualMonth !== currentMonth) {
                                if (!confirm(`Roll number month (${manualMonth}) differs from current month (${currentMonth}).\n\nContinue?`)) {
                                    btn.disabled = false;
                                    btn.textContent = 'üñ®Ô∏è PRINT LABEL';
                                    return;
                                }
                            }

                            // v29: Check for duplicate before updating counter
                            const existingEntry = printLog.find(entry => String(entry.rollNo) === freshRollNo);
                            if (existingEntry) {
                                alert(`Duplicate Roll Number!\n\nRoll No ${freshRollNo} already exists in the log.\nDate: ${existingEntry.date}\nProduct: ${existingEntry.product || '-'}\n\nPrint cancelled.`);
                                btn.disabled = false;
                                btn.textContent = 'üñ®Ô∏è PRINT LABEL';
                                return;
                            }

                            // Update sequence counter if manual serial is higher (same month only)
                            if (manualMonth === currentMonth) {
                                const currentCounter = getLocalSerial(manualSystem);
                                if (manualSerial > currentCounter) {
                                    await setSequenceToSerial(manualSystem, manualSerial, manualMonth);
                                } else if (manualSerial <= currentCounter) {
                                    if (!confirm(`Manual serial (${String(manualSerial).padStart(5, '0')}) is not higher than current counter (${String(currentCounter).padStart(5, '0')}).\n\nThis may create a duplicate. Continue?`)) {
                                        btn.disabled = false;
                                        btn.textContent = 'üñ®Ô∏è PRINT LABEL';
                                        return;
                                    }
                                }
                            }

                            window.manualRollEntry = false;
                            // freshRollNo stays as-is (manually entered value)

                        } else {
                            // --- AUTO-INCREMENT PATH (existing behavior) ---
                            try {
                                const systemNum = document.getElementById('systemSelect').value;
                                const month = getCurrentMonth();
                                const consumedSerial = await incrementAndSaveSerial(systemNum);
                                freshRollNo = systemNum + month + String(consumedSerial).padStart(5, '0');
                                document.getElementById('rollNoInput').value = freshRollNo;
                                updateLabelText();
                            } catch (incrementError) {
                                console.error('Roll number increment failed, retrying:', incrementError);
                                try {
                                    const systemNum = document.getElementById('systemSelect').value;
                                    const month = getCurrentMonth();
                                    const consumedSerial = await incrementAndSaveSerial(systemNum);
                                    freshRollNo = systemNum + month + String(consumedSerial).padStart(5, '0');
                                    document.getElementById('rollNoInput').value = freshRollNo;
                                    updateLabelText();
                                } catch (retryError) {
                                    console.error('Roll number increment retry failed:', retryError);
                                    showToast('Roll number may not have incremented. Check before next print.', 'error');
                                }
                            }
                        }
                    }

                    addToLog({
                        system: document.getElementById('systemSelect').value,
                        client: document.getElementById('clientInput').value.toUpperCase(),
                        product: document.getElementById('productInput').value.toUpperCase(),
                        design: document.getElementById('designInput').value.toUpperCase(),
                        color: document.getElementById('colorInput').value.toUpperCase(),
                        grade: document.getElementById('gradeInput').value.toUpperCase(),
                        rollNo: freshRollNo,
                        meters: document.getElementById('metersInput').value,
                        bits: document.getElementById('bitsInput').value,
                        weight: document.getElementById('weightInput').value,
                        copies: copies
                    });

                    // Display the NEXT available number for the next print
                    if (!skipIncrement) {
                        try {
                            await generateRollNumber(false);
                        } catch (e) {
                            console.warn('Could not refresh next roll number:', e);
                        }
                    }
                } else if (!skipIncrement) {
                    try {
                        await incrementRollNumber();
                    } catch (incrementError) {
                        console.error('Roll number increment failed:', incrementError);
                    }
                }

                // Save current system selection
                localStorage.setItem('snehaLastSystem', document.getElementById('systemSelect').value);

                if (!skipLog) {
                    alert(`Printed ${copies} label(s)! ${wasManualEntry ? 'Manual roll number used.' : 'Roll number auto-incremented.'}`);
                }

            } catch(err) {
                alert('‚ùå Print failed: ' + err.message);
            }

            btn.disabled = false;
            btn.textContent = 'üñ®Ô∏è PRINT LABEL';
        }

        // Report Functions
        function openReportModal() {
            document.getElementById('reportModal').classList.add('show');
            populateReportFilters();
            generateReport();
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('show');
        }

        // ============ REJECTS ENTRY FUNCTIONS ============
        
        function openRejectsModal() {
            document.getElementById('rejectsModal').classList.add('show');
            // Set system from last used
            const lastSystem = localStorage.getItem('snehaLastSystem') || '1';
            document.getElementById('rejectSystem').value = lastSystem;
            
            // Populate client dropdown with same clients as main label
            const clientSelect = document.getElementById('rejectClient');
            clientSelect.innerHTML = '<option value="">-- Select Client --</option>';
            dropdownData.client.forEach(client => {
                const option = document.createElement('option');
                option.value = client;
                option.textContent = client;
                clientSelect.appendChild(option);
            });
            
            // Clear fields
            document.getElementById('rejectClient').value = '';
            document.getElementById('rejectMeters').value = '';
            document.getElementById('rejectWeight').value = '';
            document.getElementById('rejectPrintLabel').checked = false;
            
            // Generate auto roll number for rejects
            generateRejectRollNumber();
        }
        
        // Separate serial sequence for rejects
        function getRejectStorageKey(systemNum) {
            const month = getCurrentMonth();
            const year = new Date().getFullYear();
            return `snehaRejectSerial_sys${systemNum}_${year}${month}`;
        }
        
        function getNextRejectSerial(systemNum) {
            const key = getRejectStorageKey(systemNum);
            let serial = parseInt(localStorage.getItem(key)) || 0;
            return serial + 1;
        }
        
        function saveRejectSerial(systemNum, serial) {
            const key = getRejectStorageKey(systemNum);
            localStorage.setItem(key, serial.toString());
        }
        
        function generateRejectRollNumber() {
            const systemNum = document.getElementById('rejectSystem').value;
            const month = getCurrentMonth();
            const serial = getNextRejectSerial(systemNum);
            
            // Format: R[System][Month][5-digit Serial] - R prefix for Rejects
            const rollNo = 'R' + systemNum + month + String(serial).padStart(5, '0');
            document.getElementById('rejectRollNo').value = rollNo;
            return rollNo;
        }
        
        function closeRejectsModal() {
            document.getElementById('rejectsModal').classList.remove('show');
        }
        
        function saveRejectsEntry() {
            const rollNo = document.getElementById('rejectRollNo').value;
            const client = document.getElementById('rejectClient').value;
            const meters = document.getElementById('rejectMeters').value;
            const weight = document.getElementById('rejectWeight').value;
            const system = document.getElementById('rejectSystem').value;
            const printLabel = document.getElementById('rejectPrintLabel').checked;
            
            if (!rollNo) {
                alert('Please enter Roll Number');
                return;
            }
            
            if (!meters) {
                alert('Please enter Meters value');
                return;
            }
            
            // Add to print log
            addToLog({
                system: system,
                client: client || 'Rejects',
                product: 'Rejects',
                design: 'All Design',
                color: 'All Color',
                grade: '',
                rollNo: rollNo,
                meters: meters,
                weight: weight,
                copies: 1,
                isReject: true
            });
            
            // Save last system and increment REJECT serial (separate from label serial)
            localStorage.setItem('snehaLastSystem', system);
            const serial = getNextRejectSerial(system);
            saveRejectSerial(system, serial);
            
            // Print label if checkbox is checked
            if (printLabel) {
                printRejectLabel({
                    client: client || 'Rejects',
                    product: 'Rejects',
                    design: 'All Design',
                    color: 'All Color',
                    grade: '',
                    meters: meters,
                    weight: weight,
                    rollNo: rollNo
                });
            }
            
            alert(`‚úÖ Rejects Entry Saved!\n\nClient: ${client || 'Rejects'}\nRoll No: ${rollNo}\nMeters: ${meters}\nWeight: ${weight || 'N/A'}${printLabel ? '\n\nüñ®Ô∏è Label sent to print!' : ''}`);
            
            closeRejectsModal();
        }
        
        // Extra Rolls Modal Functions
        function openExtraRollsModal() {
            document.getElementById('extraRollsModal').classList.add('show');
            
            // Populate dropdown with existing label numbers from today's log
            const today = new Date().toISOString().split('T')[0];
            const todayLabels = printLog.filter(item => item.date === today && !item.isReject);
            
            const select = document.getElementById('extraLabelSelect');
            select.innerHTML = '<option value="">-- Select Label Number --</option>';
            
            todayLabels.forEach((item, idx) => {
                const displayText = `${item.rollNo} - ${item.product} - ${item.color} (${item.meters}m)`;
                select.innerHTML += `<option value="${idx}">${displayText}</option>`;
            });
            
            // Store reference to today's labels
            window.extraLabelsRef = todayLabels;
            
            // Reset and hide fields
            document.getElementById('extraMetersToAdd').value = '';
            document.getElementById('extraWeightToAdd').value = '';
            document.getElementById('extraLabelFields').style.display = 'none';
            document.getElementById('newTotalDisplay').textContent = '';
        }
        
        function loadExtraLabelDetails() {
            const select = document.getElementById('extraLabelSelect');
            const selectedIdx = select.value;
            
            if (!selectedIdx || !window.extraLabelsRef) {
                document.getElementById('extraLabelFields').style.display = 'none';
                return;
            }
            
            const item = window.extraLabelsRef[parseInt(selectedIdx)];
            if (!item) return;
            
            // Populate input fields with label details
            document.getElementById('extraDetailProduct').value = item.product || '';
            document.getElementById('extraDetailDesign').value = item.design || '';
            document.getElementById('extraDetailColor').value = item.color || '';
            document.getElementById('extraDetailGrade').value = item.grade || '';
            document.getElementById('extraDetailMeters').textContent = item.meters || '-';
            document.getElementById('extraDetailWeight').textContent = item.weight || '-';
            document.getElementById('extraDetailSystem').value = 'Sys ' + (item.system || item.rollNo?.charAt(0) || '1');
            
            document.getElementById('extraLabelFields').style.display = 'block';
            
            // Store the selected item
            window.selectedExtraLabel = item;
            
            calculateNewTotal();
        }
        
        function calculateNewTotal() {
            if (!window.selectedExtraLabel) return;
            
            const currentMeters = parseFloat(window.selectedExtraLabel.meters) || 0;
            const extraMeters = parseFloat(document.getElementById('extraMetersToAdd').value) || 0;
            const newTotal = currentMeters + extraMeters;
            
            if (extraMeters > 0) {
                document.getElementById('newTotalDisplay').textContent = 
                    `New Total: ${currentMeters} + ${extraMeters} = ${newTotal.toFixed(1)} meters`;
            } else {
                document.getElementById('newTotalDisplay').textContent = '';
            }
        }
        
        function closeExtraRollsModal() {
            document.getElementById('extraRollsModal').classList.remove('show');
            window.extraLabelsRef = null;
            window.selectedExtraLabel = null;
        }
        
        function saveExtraRoll() {
            const selectedIdx = document.getElementById('extraLabelSelect').value;
            const extraMeters = parseFloat(document.getElementById('extraMetersToAdd').value) || 0;
            const extraWeight = parseFloat(document.getElementById('extraWeightToAdd').value) || 0;
            const printLabel = document.getElementById('extraPrintLabel').checked;
            
            if (!selectedIdx || !window.selectedExtraLabel) {
                alert('Please select an existing label number');
                return;
            }
            
            if (extraMeters <= 0) {
                alert('Please enter extra meters to add');
                return;
            }
            
            const item = window.selectedExtraLabel;
            
            // Find actual index in printLog
            const actualIndex = printLog.findIndex(p => p.timestamp === item.timestamp && p.rollNo === item.rollNo);
            
            if (actualIndex === -1) {
                alert('Error: Label not found in log');
                return;
            }
            
            // Calculate new values
            const currentMeters = parseFloat(item.meters) || 0;
            const currentWeight = parseFloat(item.weight) || 0;
            const newMeters = currentMeters + extraMeters;
            const newWeight = currentWeight + extraWeight;
            
            // UPDATE the existing record
            printLog[actualIndex].meters = newMeters.toString();
            printLog[actualIndex].weight = newWeight > 0 ? newWeight.toString() : item.weight;
            
            // Store bits info if this is a split
            if (!printLog[actualIndex].bits) {
                printLog[actualIndex].bits = `${currentMeters}+${extraMeters}`;
            } else {
                printLog[actualIndex].bits = printLog[actualIndex].bits + '+' + extraMeters;
            }
            
            // Save updated log
            savePrintLog();
            updateLogDisplay();
            
            // Print label if checkbox is checked
            if (printLabel && qzConnected && selectedPrinter) {
                // Set values for printing with updated meters
                document.getElementById('clientInput').value = item.client;
                document.getElementById('productInput').value = item.product;
                document.getElementById('designInput').value = item.design;
                document.getElementById('colorInput').value = item.color;
                document.getElementById('gradeInput').value = item.grade;
                document.getElementById('metersInput').value = newMeters.toString();
                document.getElementById('bitsInput').value = printLog[actualIndex].bits || '';
                document.getElementById('weightInput').value = printLog[actualIndex].weight || '';
                document.getElementById('rollNoInput').value = item.rollNo;
                toggleBitsField();
                updateLabelText();
                
                setTimeout(() => {
                    printLabel(true, true); // Skip log, skip increment
                }, 200);
            }
            
            alert(`‚úÖ Label UPDATED Successfully!\n\nRoll No: ${item.rollNo}\nProduct: ${item.product}\n\nMeters: ${currentMeters} + ${extraMeters} = ${newMeters}\n${extraWeight > 0 ? `Weight: ${currentWeight} + ${extraWeight} = ${newWeight}\n` : ''}${printLabel ? '\nüñ®Ô∏è Printing updated label...' : ''}\n\n‚ö†Ô∏è No new roll created - existing label updated.`);
            
            closeExtraRollsModal();
        }
        
        function printRejectLabel(data) {
            // Temporarily set label values for printing
            const originalValues = {
                product: document.getElementById('productInput').value,
                design: document.getElementById('designInput').value,
                color: document.getElementById('colorInput').value,
                grade: document.getElementById('gradeInput').value,
                meters: document.getElementById('metersInput').value,
                weight: document.getElementById('weightInput').value,
                rollNo: document.getElementById('rollNoInput').value,
                qty: document.getElementById('qtyInput').value
            };
            
            // Set reject values
            document.getElementById('productInput').value = data.product;
            document.getElementById('designInput').value = data.design;
            document.getElementById('colorInput').value = data.color;
            document.getElementById('gradeInput').value = data.grade;
            document.getElementById('metersInput').value = data.meters;
            document.getElementById('weightInput').value = data.weight;
            document.getElementById('rollNoInput').value = data.rollNo;
            document.getElementById('qtyInput').value = '1';
            updateLabelText();
            
            // Print label with skipLog=true (already logged) and skipIncrement=true
            setTimeout(async () => {
                await printLabel(true, true);
                
                // Restore original values after printing
                setTimeout(() => {
                    document.getElementById('productInput').value = originalValues.product;
                    document.getElementById('designInput').value = originalValues.design;
                    document.getElementById('colorInput').value = originalValues.color;
                    document.getElementById('gradeInput').value = originalValues.grade;
                    document.getElementById('metersInput').value = originalValues.meters;
                    document.getElementById('weightInput').value = originalValues.weight;
                    document.getElementById('rollNoInput').value = originalValues.rollNo;
                    document.getElementById('qtyInput').value = originalValues.qty;
                    updateLabelText();
                }, 500);
            }, 100);
        }

        function populateReportFilters() {
            const clients = [...new Set(printLog.map(item => (item.client || '').toUpperCase()).filter(Boolean))];
            const products = [...new Set(printLog.map(item => (item.product || '').toUpperCase()).filter(Boolean))];
            const designs = [...new Set(printLog.map(item => (item.design || '').toUpperCase()).filter(Boolean))];
            const grades = [...new Set(printLog.map(item => (item.grade || '').toUpperCase()).filter(Boolean))];
            const colors = [...new Set(printLog.map(item => (item.color || '').toUpperCase()).filter(Boolean))];

            const clientSelect = document.getElementById('reportClient');
            clientSelect.innerHTML = '<option value="">All Clients</option>' + clients.map(c => `<option value="${c}">${c}</option>`).join('');
            
            const productSelect = document.getElementById('reportProduct');
            productSelect.innerHTML = '<option value="">All Products</option>' + products.map(p => `<option value="${p}">${p}</option>`).join('');
            
            // Populate designs filter dynamically
            const designSelect = document.getElementById('reportDesign');
            if (designSelect) {
                designSelect.innerHTML = '<option value="">All Designs</option>' + designs.sort().map(d => `<option value="${d}">${d}</option>`).join('');
            }
            
            // Populate grades filter dynamically
            const gradeSelect = document.getElementById('reportGrade');
            if (gradeSelect) {
                const defaultGrades = ['A', 'STD', 'COMMERCIAL'];
                const allGrades = [...new Set([...defaultGrades, ...grades])];
                gradeSelect.innerHTML = '<option value="">All Grades</option>' + allGrades.map(g => `<option value="${g}">${g}</option>`).join('');
            }
            
            // Populate colors filter dynamically
            const colorSelect = document.getElementById('reportColor');
            if (colorSelect) {
                colorSelect.innerHTML = '<option value="">All Colors</option>' + colors.map(c => `<option value="${c}">${c}</option>`).join('');
            }
        }
        
        function toggleLabelRange() {
            const enabled = document.getElementById('enableLabelRange').checked;
            document.getElementById('labelStart').disabled = !enabled;
            document.getElementById('labelEnd').disabled = !enabled;
        }

        function generateReport() {
            const date = document.getElementById('reportDate').value;
            const reportType = document.getElementById('reportType').value;
            const systemFilter = document.getElementById('reportSystem').value;
            const clientFilter = document.getElementById('reportClient').value;
            const productFilter = document.getElementById('reportProduct').value;
            const designFilter = document.getElementById('reportDesign')?.value || '';
            const gradeFilter = document.getElementById('reportGrade').value;
            const colorFilter = document.getElementById('reportColor')?.value || '';
            const enableLabelRange = document.getElementById('enableLabelRange') ? document.getElementById('enableLabelRange').checked : false;
            const labelStart = document.getElementById('labelStart')?.value || '';
            const labelEnd = document.getElementById('labelEnd')?.value || '';

            let filtered = printLog.filter(item => item.date === date);
            
            // Filter by report type (labels, rejects, or all)
            if (reportType === 'labels') {
                filtered = filtered.filter(item => !item.isReject);
            } else if (reportType === 'rejects') {
                filtered = filtered.filter(item => item.isReject === true);
            }
            // 'all' shows everything
            
            if (systemFilter) {
                filtered = filtered.filter(item => {
                    // Check item.system first (new records), then extract from rollNo (old records)
                    // Roll number format: [System][Month][Serial] - first digit is system
                    const itemSystem = item.system || (item.rollNo ? item.rollNo.charAt(0) : '');
                    return itemSystem === systemFilter;
                });
            }
            if (clientFilter) filtered = filtered.filter(item => (item.client || '').toUpperCase() === clientFilter.toUpperCase());
            if (productFilter) filtered = filtered.filter(item => (item.product || '').toUpperCase() === productFilter.toUpperCase());
            if (designFilter) filtered = filtered.filter(item => (item.design || '').toUpperCase() === designFilter.toUpperCase());
            if (gradeFilter) filtered = filtered.filter(item => (item.grade || '').toUpperCase() === gradeFilter.toUpperCase());
            if (colorFilter) filtered = filtered.filter(item => (item.color || '').toUpperCase() === colorFilter.toUpperCase());
            
            // Apply label number range filter if enabled
            if (enableLabelRange && labelStart && labelEnd) {
                filtered = filtered.filter(item => {
                    const rollNo = item.rollNo || '';
                    // Compare as strings (label numbers are formatted consistently)
                    return rollNo >= labelStart && rollNo <= labelEnd;
                });
            }

            // Group by client/product/design/GRADE (separate groups for different grades)
            const grouped = {};
            filtered.forEach(item => {
                const gradeKey = (item.grade || 'NO GRADE').toUpperCase();
                const productName = (item.product || '').toUpperCase();
                const key = `${(item.client || 'No Client').toUpperCase()}|${productName}|${(item.design || '').toUpperCase()}|${gradeKey}`;
                
                if (!grouped[key]) {
                    grouped[key] = {
                        client: (item.client || 'No Client').toUpperCase(),
                        product: productName,
                        design: (item.design || '').toUpperCase(),
                        grade: gradeKey,
                        items: []
                    };
                }
                grouped[key].items.push(item);
            });

            const displayDate = new Date(date).toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const systemText = systemFilter ? `Sys ${systemFilter}` : 'All Systems';
            const reportTypeText = reportType === 'labels' ? 'LABELS' : (reportType === 'rejects' ? 'REJECTS' : 'ALL');

            let html = `
                <div class="report-header">
                    <div class="report-header-content">
                        <img class="report-logo" src="data:image/png;base64,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" alt="Sneha Logo">
                        <div>
                            <h1>SNEHA VINYL PRODUCTS PVT LTD</h1>
                            <div class="since">SINCE 1984</div>
                            <div class="address">14-34, IDA, RENIGUNTA, TIRUPATI, AP</div>
                            <div class="contact">
                                <span>+91-9000317333</span>
                                <span>info@snehavinyl.in</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            if (Object.keys(grouped).length === 0) {
                html += '<p style="text-align: center; padding: 40px;">No records found for the selected criteria</p>';
            } else {
                Object.values(grouped).forEach(group => {
                    html += `
                        <div class="report-meta">
                            <div class="meta-left">
                                <span><b>Client:</b> ${group.client}</span>
                                <span><b>Design:</b> ${group.design}</span>
                            </div>
                            <div class="meta-right">
                                <span><b>Product:</b> ${group.product}</span>
                                <span><b>Grade:</b> ${group.grade}</span>
                                <span><b>Date:</b> ${displayDate}</span>
                            </div>
                        </div>

                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>S.No</th>
                                    <th>${reportType === 'rejects' ? 'Serial No' : 'Roll No'}</th>
                                    <th>Color</th>
                                    <th>Grade</th>
                                    <th>Meter</th>
                                    <th>Weight</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    let totalMeters = 0, totalWeight = 0;
                    group.items.forEach((item, idx) => {
                        totalMeters += parseFloat(item.meters) || 0;
                        totalWeight += parseFloat(item.weight) || 0;
                        html += `
                            <tr>
                                <td>${idx + 1}</td>
                                <td>${item.rollNo || ''}</td>
                                <td>${(item.color || '').toUpperCase()}</td>
                                <td>${(item.grade || '').toUpperCase()}</td>
                                <td class="number">${item.meters || ''}</td>
                                <td class="number">${item.weight || ''}</td>
                            </tr>
                        `;
                    });

                    html += `
                            </tbody>
                        </table>
                        <div class="report-totals">
                            <span><b>Total</b></span>
                            <span>No of Rolls: <b>${group.items.length}</b></span>
                            <span>Total Meters: <b>${totalMeters.toFixed(1)}</b></span>
                            <span>Total Weight: <b>${totalWeight.toFixed(1)} Kgs</b></span>
                        </div>
                        <hr style="margin: 8px 0; border-top: 1px solid #000;">
                    `;
                });
            }

            document.getElementById('reportPreview').innerHTML = html;
        }

        function printReportBrowser() {
            const content = document.getElementById('reportPreview').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Production Report</title>
                    <style>
                        @page { 
                            size: A4; 
                            margin: 8mm 10mm 10mm 10mm;
                        }
                        * { box-sizing: border-box; }
                        body { 
                            font-family: Arial, sans-serif; 
                            font-size: 11pt;
                            line-height: 1.2;
                            margin: 0;
                            padding: 0;
                        }
                        .report-header { 
                            text-align: center; 
                            padding: 5px 0 8px 0;
                            border-bottom: 2px solid #000;
                            margin-bottom: 8px;
                        }
                        .report-header-content {
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 12px;
                        }
                        .report-logo {
                            width: 45px;
                            height: 45px;
                            object-fit: contain;
                        }
                        .report-header h1 { 
                            font-size: 16pt; 
                            margin: 0; 
                            font-weight: 900;
                            letter-spacing: 1px;
                        }
                        .report-header .since { 
                            font-size: 10pt; 
                            font-weight: bold;
                            margin: 2px 0;
                        }
                        .report-header .address { 
                            font-size: 10pt; 
                            margin: 2px 0;
                        }
                        .report-header .contact { 
                            font-size: 10pt; 
                            display: flex; 
                            justify-content: center; 
                            gap: 40px;
                            margin-top: 3px;
                        }
                        .report-meta { 
                            display: flex;
                            justify-content: space-between;
                            gap: 15px;
                            margin: 6px 0; 
                            padding: 6px 0; 
                            border-bottom: 1px solid #000;
                            font-size: 9pt;
                            font-weight: 500;
                        }
                        .report-meta .meta-left,
                        .report-meta .meta-right {
                            display: flex;
                            flex-direction: column;
                            gap: 2px;
                        }
                        .report-meta .meta-right {
                            text-align: right;
                        }
                        .report-meta span {
                            overflow: hidden;
                            text-overflow: ellipsis;
                            white-space: nowrap;
                        }
                        .report-meta b {
                            font-weight: 700;
                        }
                        .report-table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 3px 0;
                            font-size: 10pt;
                        }
                        .report-table th, .report-table td { 
                            border: 1px solid #000; 
                            padding: 2px 3px; 
                            text-align: left; 
                            line-height: 1.15;
                        }
                        .report-table th { 
                            background: #e0e0e0; 
                            font-weight: 700;
                            font-size: 10pt;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .report-table td { 
                            font-size: 10pt;
                        }
                        .report-table td.number { 
                            text-align: right; 
                        }
                        .report-totals { 
                            margin: 4px 0 6px 0; 
                            display: flex; 
                            justify-content: space-between; 
                            font-weight: 700;
                            font-size: 10pt;
                            padding-top: 3px;
                        }
                        hr {
                            margin: 6px 0 !important;
                            border: none !important;
                            border-top: 1px solid #000 !important;
                        }
                        /* Force print images and colors */
                        img {
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                            color-adjust: exact !important;
                        }
                        .report-logo {
                            display: block !important;
                            visibility: visible !important;
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                        @media print {
                            img { display: block !important; }
                            .report-logo { display: block !important; }
                            .no-print { display: none !important; }
                        }
                        /* Hide filter info in print */
                        .no-print {
                            display: none;
                        }
                        /* Page break control */
                        .report-meta {
                            page-break-inside: avoid;
                        }
                        .report-table {
                            page-break-inside: auto;
                        }
                        .report-table tr {
                            page-break-inside: avoid;
                        }
                        .report-totals {
                            page-break-inside: avoid;
                        }
                    </style>
                </head>
                <body>${content}</body>
                </html>
            `);
            printWindow.document.close();
            
            // Wait for image to load before printing
            const img = printWindow.document.querySelector('.report-logo');
            if (img && !img.complete) {
                img.onload = () => {
                    setTimeout(() => printWindow.print(), 100);
                };
                img.onerror = () => {
                    printWindow.print();
                };
            } else {
                setTimeout(() => printWindow.print(), 200);
            }
        }

        async function printReportDotMatrix() {
            const dotMatrixPrinter = document.getElementById('dotMatrixSelect').value;
            if (!qzConnected || !dotMatrixPrinter) {
                alert('Please connect and select a dot matrix printer');
                return;
            }

            try {
                const date = document.getElementById('reportDate').value;
                const systemFilter = document.getElementById('reportSystem').value;
                const clientFilter = document.getElementById('reportClient').value;
                const productFilter = document.getElementById('reportProduct').value;

                let filtered = printLog.filter(item => item.date === date);
                if (systemFilter) {
                    filtered = filtered.filter(item => {
                        // Check item.system first (new records), then extract from rollNo (old records)
                        // Roll number format: [System][Month][Serial] - first digit is system
                        const itemSystem = item.system || (item.rollNo ? item.rollNo.charAt(0) : '');
                        return itemSystem === systemFilter;
                    });
                }
                if (clientFilter) filtered = filtered.filter(item => item.client === clientFilter);
                if (productFilter) filtered = filtered.filter(item => item.product === productFilter);

                // Group by client/product/design
                const grouped = {};
                filtered.forEach(item => {
                    const key = `${item.client || 'No Client'}|${item.product || ''}|${item.design || ''}`;
                    if (!grouped[key]) {
                        grouped[key] = { client: item.client || 'No Client', product: item.product || '', design: item.design || '', items: [] };
                    }
                    grouped[key].items.push(item);
                });

                const displayDate = new Date(date).toLocaleDateString('en-IN');
                const systemText = systemFilter ? `Sys ${systemFilter}` : 'All Systems';

                // Build plain text for dot matrix
                let text = '';
                text += '                    SNEHA VINYL PRODUCTS PVT LTD\n';
                text += '                           SINCE 1984\n';
                text += '               14-34, IDA, RENIGUNTA, TIRUPATI, AP\n';
                text += '           +91-9000317333        info@snehavinyl.in\n';
                text += `                    [ ${systemText} ] - Date: ${displayDate}\n`;
                text += '=' .repeat(80) + '\n\n';

                Object.values(grouped).forEach(group => {
                    text += `Client: ${group.client.padEnd(20)} Product: ${group.product.padEnd(15)} Design: ${group.design}\n`;
                    text += `Date: ${displayDate}\n`;
                    text += '-'.repeat(80) + '\n';
                    text += 'S:no  Roll no      Color          Grade     Meter    Weight(Kgs)\n';
                    text += '-'.repeat(80) + '\n';

                    let totalMeters = 0, totalWeight = 0;
                    group.items.forEach((item, idx) => {
                        totalMeters += parseFloat(item.meters) || 0;
                        totalWeight += parseFloat(item.weight) || 0;
                        text += `${String(idx + 1).padStart(4)}  ${(item.rollNo || '').padEnd(12)} ${(item.color || '').padEnd(14)} ${(item.grade || '').padEnd(9)} ${String(item.meters || '').padStart(8)} ${String(item.weight || '').padStart(12)}\n`;
                    });

                    text += '-'.repeat(80) + '\n';
                    text += `Total                                        Rolls: ${String(group.items.length).padStart(4)}  Meters: ${totalMeters.toFixed(1).padStart(8)}  Weight: ${totalWeight.toFixed(1).padStart(8)}\n`;
                    text += '='.repeat(80) + '\n\n';
                });

                const config = qz.configs.create(dotMatrixPrinter, {
                    size: { width: 10, height: 12 },
                    units: 'in'
                });

                await qz.print(config, [{ type: 'raw', format: 'plain', data: text }]);
                alert('‚úÖ Report sent to dot matrix printer!');

            } catch(err) {
                alert('‚ùå Print failed: ' + err.message);
            }
        }
    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // PWA Install Prompt
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Show install button
            showInstallButton();
        });
        
        function showInstallButton() {
            // Create install button if not exists
            if (!document.getElementById('pwaInstallBtn')) {
                const btn = document.createElement('button');
                btn.id = 'pwaInstallBtn';
                btn.innerHTML = 'üì≤ Install App';
                btn.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #059669;
                    color: white;
                    border: none;
                    padding: 12px 20px;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 10000;
                    transition: all 0.3s;
                `;
                btn.onmouseover = () => btn.style.background = '#047857';
                btn.onmouseout = () => btn.style.background = '#059669';
                btn.onclick = installPWA;
                document.body.appendChild(btn);
            }
        }
        
        async function installPWA() {
            if (!deferredPrompt) {
                alert('App is already installed or cannot be installed on this browser.');
                return;
            }
            
            // Show the install prompt
            deferredPrompt.prompt();
            
            // Wait for the user to respond to the prompt
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('User accepted the install prompt');
                // Hide the install button
                const btn = document.getElementById('pwaInstallBtn');
                if (btn) btn.remove();
            }
            
            // Clear the deferred prompt
            deferredPrompt = null;
        }
        
        // When PWA is installed
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            const btn = document.getElementById('pwaInstallBtn');
            if (btn) btn.remove();
            deferredPrompt = null;
        });
        
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js?v=29.0')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration.scope);
                        
                        // Force update check
                        registration.update();
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New content available
                                    if (confirm('New version available! Reload to update?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed:', err);
                    });
            });
        }
    </script>
</body>
</html>
